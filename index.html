<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRHJvcCBBIEdyaW1vaXJlIiwic2hvcnRfbmFtZSI6IkdyaW1vaXJlIiwic3RhcnRfdXJsIjoiLi8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMGQwMTE4IiwidGhlbWVfY29sb3IiOiIjNjYxMGM4Iiwib3JpZW50YXRpb24iOiJwb3J0cmFpdCIsImljb25zIjpbeyJzcmMiOiIuL2ljb24ucG5nIiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3BuZyIsInB1cnBvc2UiOiJhbnkgbWFza2FibGUifV19">
<link rel="icon" type="image/png" href="./icon.png">
<link rel="apple-touch-icon" href="./icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Drop A Grimoire">
<meta name="theme-color" content="#7711cc">
<meta name="description" content="7-String Drop A Deathcore Guitar Learning App">
<title>Drop A Grimoire — 7-String Deathcore</title>
<style>
/* ═══════════════════════════════════════════
   TOKENS
═══════════════════════════════════════════ */
:root {
  /* ── Core void ── */
  --void:    #040210;
  --abyss:   #070514;
  --forge:   #0d0a1a;
  --iron:    #141020;
  --steel:   #1e1a2c;
  --edge:    #2c2640;
  --wire:    #3e3658;
  --surface: #120f1e;

  /* ── Purple palette ── */
  --crimson: #5512a0;
  --blood:   #8822ee;
  --ember:   #a83dff;
  --flame:   #c466ff;
  --hot:     #dd88ff;

  /* ── Text & bone ── */
  --gold:    #e0a030;
  --bone:    #eeddc8;
  --pale:    #f5edde;
  --mid:     #c4b8a8;
  --dim:     #8a7e8e;
  --ghost:   #32283e;

  --glow-r: rgba(140, 34, 200, 0.22);
  --glow-b: rgba(100, 20, 140, 0.12);

  /* ── Fonts: brutal slab + mono ── */
  --display: 'Rockwell', 'Rockwell Condensed', 'Courier New', Georgia, serif;
  --ui:      ui-sans-serif, 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
  --body:    ui-sans-serif, 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif;
  --mono:    ui-monospace, 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace;

  --radius: 1px;
  --speed: 0.18s;
}

/* ═══════════════════════════════════════════
   BASE
═══════════════════════════════════════════ */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

html { scroll-behavior: smooth; }

body {
  background: #060410;
  color: var(--pale);
  font-family: var(--body);
  font-size: 15px;
  line-height: 1.65;
  min-height: 100vh;
  overflow-x: hidden;
}

/* Hex grid background */
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image:
    radial-gradient(ellipse at 15% 0%, rgba(130,30,220,0.35) 0%, transparent 55%),
    radial-gradient(ellipse at 85% 100%, rgba(90,20,180,0.28) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 50%, rgba(110,15,100,0.14) 0%, transparent 70%),
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80'%3E%3Cline x1='0' y1='0' x2='80' y2='80' stroke='%23241f32' stroke-width='0.4'/%3E%3Cline x1='80' y1='0' x2='0' y2='80' stroke='%23241f32' stroke-width='0.4'/%3E%3Crect x='38' y='38' width='4' height='4' fill='%23301a1a' opacity='0.4'/%3E%3C/svg%3E");
  background-size: auto, auto, auto, 80px 80px;
  pointer-events: none;
  z-index: 0;
}

body::after {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: linear-gradient(90deg, transparent 0%, #7718cc 15%, #c466ff 50%, #7718cc 85%, transparent 100%);
  z-index: 200;
}

body > * { position: relative; z-index: 1; }

::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: var(--abyss); }
::-webkit-scrollbar-thumb { background: var(--blood); }

/* ═══════════════════════════════════════════
   HEADER
═══════════════════════════════════════════ */
header {
  padding: 56px 24px 44px;
  text-align: center;
  position: relative;
  border-bottom: 1px solid var(--edge);
  background: linear-gradient(180deg, rgba(100,20,180,0.14) 0%, transparent 100%);
}

.header-eyebrow {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 7px;
  color: var(--blood);
  text-transform: uppercase;
  margin-bottom: 18px;
  opacity: 0.9;
}

h1 {
  font-family: var(--display);
  font-size: clamp(22px, 6vw, 60px);
  font-weight: 900;
  color: var(--pale);
  line-height: 1;
  letter-spacing: 3px;
  text-transform: uppercase;
  text-shadow:
    0 0 40px rgba(170,68,238,0.7),
    0 0 80px rgba(120,30,200,0.35),
    2px 2px 0 rgba(0,0,0,0.9);
  margin-bottom: 12px;
}

.header-sub {
  font-family: var(--ui);
  font-size: 13px;
  font-weight: 400;
  letter-spacing: 9px;
  color: var(--mid);
  text-transform: uppercase;
}

/* glowing line under header */
.header-line {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent 0%, var(--blood) 25%, var(--ember) 50%, var(--blood) 75%, transparent 100%);
}

/* ═══════════════════════════════════════════
   NAVIGATION
═══════════════════════════════════════════ */
.nav-wrap {
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(6,4,16,0.96);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  border-bottom: 1px solid var(--edge);
  box-shadow: 0 4px 30px rgba(0,0,0,0.6);
}

nav {
  display: flex;
  overflow-x: auto;
  scrollbar-width: none;
  padding: 0 8px;
  max-width: 1100px;
  margin: 0 auto;
}
nav::-webkit-scrollbar { display: none; }

nav button {
  flex-shrink: 0;
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  color: #8880a8;
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  padding: 14px 16px;
  cursor: pointer;
  transition: all var(--speed);
  white-space: nowrap;
  position: relative;
}

nav button:hover { color: var(--pale); background: rgba(136,34,238,0.10); }
nav button.active {
  color: var(--flame);
  border-bottom-color: var(--blood);
  background: rgba(119,24,204,0.18);
  text-shadow: 0 0 16px rgba(187,85,255,0.5);
}

/* ═══════════════════════════════════════════
   LAYOUT
═══════════════════════════════════════════ */
.page { display: none; max-width: 960px; margin: 0 auto; padding: 40px 20px 80px; }
.page.active { display: block; animation: fadeSlideIn 0.3s ease; }
@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}

.page-header { margin-bottom: 32px; }
.page-title {
  font-family: var(--display);
  font-size: clamp(20px, 4vw, 34px);
  font-weight: 900;
  color: var(--pale);
  letter-spacing: 3px;
  text-transform: uppercase;
  text-shadow: 0 0 30px rgba(153,51,221,0.4);
  margin-bottom: 10px;
}
.page-lead { color: #c4b8ae; font-size: 14px; max-width: 600px; line-height: 1.6; }

/* ═══════════════════════════════════════════
   COLLAPSIBLE SECTIONS
═══════════════════════════════════════════ */
.collapse-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 24px; }

.collapse-item {
  background: linear-gradient(135deg, #110d22, #160d26);
  border: 1px solid var(--edge);
  border-radius: var(--radius);
  overflow: hidden;
  transition: border-color var(--speed);
}
.collapse-item:hover { border-color: var(--wire); }
.collapse-item.open { border-color: var(--ember); box-shadow: 0 0 20px rgba(153,51,221,0.18); }

.collapse-trigger {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 11px 14px;
  cursor: pointer;
  user-select: none;
  transition: background var(--speed);
}
.collapse-trigger:hover { background: rgba(255,255,255,0.02); }
.collapse-item.open .collapse-trigger { background: rgba(100,20,180,0.12); }

.collapse-icon {
  width: 24px; height: 24px;
  border: 1px solid var(--edge);
  border-radius: 4px;
  display: flex; align-items: center; justify-content: center;
  font-size: 11px;
  color: var(--ember);
  flex-shrink: 0;
  transition: all var(--speed);
}
.collapse-item.open .collapse-icon {
  background: rgba(100,20,180,0.25);
  border-color: var(--blood);
  box-shadow: 0 0 8px rgba(153,51,221,0.3);
}

.collapse-title { flex: 1 1 auto; min-width: 0; overflow: hidden; }
.collapse-title-main {
  font-family: var(--ui);
  font-weight: 600;
  font-size: 13px;
  letter-spacing: 0.3px;
  color: var(--pale);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.collapse-title-sub {
  font-family: var(--mono);
  font-size: 9px;
  color: #9890b0;
  letter-spacing: 0.5px;
  margin-top: 1px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.collapse-badge {
  font-family: var(--mono);
  font-size: 8px;
  letter-spacing: 1px;
  padding: 2px 6px;
  border: 1px solid var(--blood);
  color: var(--ember);
  text-transform: uppercase;
  opacity: 0.8;
  flex-shrink: 0;
  white-space: nowrap;
}
.collapse-badge.gold { border-color: var(--gold); color: var(--gold); }
.collapse-badge.gray { border-color: var(--wire); color: var(--dim); }

.collapse-arrow {
  font-size: 10px;
  color: var(--dim);
  transition: transform var(--speed);
  flex-shrink: 0;
}
.collapse-item.open .collapse-arrow { transform: rotate(180deg); color: var(--ember); }

.collapse-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.38s cubic-bezier(0.4, 0, 0.2, 1);
}
.collapse-body.open { overflow: visible; }
.collapse-body-inner { padding: 0 20px 22px; border-top: 1px solid var(--edge); }
.collapse-body-inner .tab-block { overflow-x: auto; max-width: 100%; }
.collapse-body-inner .ai-tab-block { overflow-x: auto; max-width: 100%; }
.collapse-body-inner p { max-width: 100%; word-break: break-word; }

/* Refresh button on each collapse header */
.refresh-btn {
  display: flex;
  align-items: center;
  gap: 4px;
  background: transparent;
  border: 1px solid transparent;
  color: var(--dim);
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 1px;
  padding: 3px 6px;
  cursor: pointer;
  text-transform: uppercase;
  transition: all var(--speed);
  border-radius: var(--radius);
  flex-shrink: 0;
  /* hidden but takes NO space */
  width: 0;
  overflow: hidden;
  opacity: 0;
  white-space: nowrap;
}
.collapse-item:hover .refresh-btn,
.collapse-item.open .refresh-btn { opacity: 1; width: auto; overflow: visible; }
.refresh-btn:hover { border-color: var(--ember); color: var(--hot); background: rgba(136,34,238,0.12); }
.refresh-btn:disabled { opacity: 0.3; cursor: not-allowed; }
.refresh-btn .r-icon { display: inline-block; font-size: 12px; line-height: 1; }
.refresh-btn .r-icon.spin { animation: spin 0.7s linear infinite; }

/* AI-generated exercise panel inside collapse */
.ai-exercise-panel {
  margin-top: 16px;
  border: 1px solid var(--edge);
  border-top: 2px solid var(--ember);
  border-radius: var(--radius);
  overflow: hidden;
  animation: fadeSlideIn 0.35s ease;
}
.ai-exercise-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 9px 14px;
  background: rgba(200,64,32,0.07);
  border-bottom: 1px solid var(--edge);
}
.ai-exercise-label {
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 3px;
  color: var(--ember);
  text-transform: uppercase;
  display: flex;
  align-items: center;
  gap: 7px;
}
.ai-exercise-label::before {
  content: '✦';
  font-size: 10px;
}
.ai-exercise-dismiss {
  background: none;
  border: none;
  color: var(--dim);
  cursor: pointer;
  font-size: 14px;
  padding: 0 2px;
  transition: color var(--speed);
  line-height: 1;
}
.ai-exercise-dismiss:hover { color: var(--ember); }
.ai-exercise-body {
  padding: 16px 18px;
  background: rgba(0,0,0,0.30);
  font-size: 14px;
  color: #f0e8d8;
  line-height: 1.75;
  min-height: 60px;
}
.ai-exercise-body.loading {
  opacity: 0.4;
  font-family: var(--mono);
  font-size: 11px;
  color: var(--dim);
  letter-spacing: 2px;
}

/* ── Add to Session button (appears in all generated content) ── */
.add-to-sess-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  margin-top: 12px;
  background: rgba(100,20,180,0.18);
  border: 1px solid var(--blood);
  color: var(--flame);
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 2px;
  padding: 7px 14px;
  border-radius: 4px;
  cursor: pointer;
  text-transform: uppercase;
  transition: all 0.18s;
}
.add-to-sess-btn:hover { background: rgba(140,34,220,0.3); border-color: var(--ember); color: var(--hot); }
.add-to-sess-btn.added { background: rgba(60,160,60,0.2); border-color: #4aaa4a; color: #6ddd6d; }

/* ── Session toast notification ── */
#sess-toast {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: rgba(80,20,160,0.95);
  border: 1px solid var(--ember);
  border-radius: 8px;
  padding: 10px 20px;
  font-family: var(--mono);
  font-size: 11px;
  letter-spacing: 2px;
  color: var(--flame);
  z-index: 9500;
  pointer-events: none;
  opacity: 0;
  transition: all 0.3s;
  white-space: nowrap;
}
#sess-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
/* Inline tab inside AI panel */
.ai-tab-block {
  background: #040408;
  border: 1px solid var(--edge);
  border-left: 2px solid var(--blood);
  padding: 12px 14px;
  margin: 12px 0;
  font-family: var(--mono);
  font-size: 12px;
  overflow-x: auto;
  white-space: pre;
  line-height: 1.7;
  color: var(--pale);
}
.ai-tab-block .tab-comment { color: var(--gold); font-size: 10px; display: block; margin-bottom: 6px; }

/* Section-level refresh bar (scales, session, roadmap) */
.section-refresh-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 16px;
  background: var(--iron);
  border: 1px solid var(--edge);
  border-radius: var(--radius);
  margin-bottom: 16px;
}
.section-refresh-label {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 2px;
  color: var(--dim);
  text-transform: uppercase;
}
.section-ai-output {
  background: var(--iron);
  border: 1px solid var(--edge);
  border-top: 2px solid var(--gold);
  border-radius: var(--radius);
  margin-top: 16px;
  overflow: hidden;
  animation: fadeSlideIn 0.35s ease;
}
.section-ai-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 16px;
  background: rgba(200,136,58,0.06);
  border-bottom: 1px solid var(--edge);
}
.section-ai-label { font-family: var(--mono); font-size: 9px; letter-spacing: 3px; color: var(--gold); text-transform: uppercase; }
.section-ai-body { padding: 18px 20px; font-size: 14px; color: var(--pale); line-height: 1.75; }
.section-ai-body.loading { opacity: 0.3; font-family: var(--mono); font-size: 11px; letter-spacing: 2px; color: var(--dim); }

/* ═══════════════════════════════════════════
   TAB DISPLAY
═══════════════════════════════════════════ */
.tab-block {
  background: #05040e;
  border: 1px solid var(--edge);
  border-top: 2px solid var(--blood);
  border-radius: var(--radius);
  padding: 18px 20px 14px;
  margin: 14px 0;
  position: relative;
  overflow-x: auto;
}

.tab-block-label {
  position: absolute;
  top: -10px; left: 14px;
  background: var(--blood);
  color: var(--pale);
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 3px;
  padding: 2px 9px;
  text-transform: uppercase;
}

.tab-row {
  display: flex;
  align-items: center;
  margin: 1.5px 0;
  white-space: nowrap;
  font-family: var(--mono);
  font-size: 12px;
  line-height: 1.6;
}
.tab-str { color: var(--ember); width: 22px; flex-shrink: 0; font-weight: 600; }
.tab-sep { color: var(--dim); margin-right: 6px; }
.tab-notes { color: #f0e8d8; letter-spacing: 0.5px; }
.tab-notes .h { color: var(--hot); font-weight: 600; }  /* highlight notes */
.tab-notes .x { color: var(--dim); }                    /* muted */

.tab-comment {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--gold);
  margin-bottom: 8px;
  letter-spacing: 1px;
}

.tab-legend {
  margin-top: 10px;
  font-family: var(--mono);
  font-size: 10px;
  color: var(--dim);
  letter-spacing: 1px;
  border-top: 1px solid var(--edge);
  padding-top: 8px;
}

/* ═══════════════════════════════════════════
   PROSE & CARDS
═══════════════════════════════════════════ */
.prose { color: #c0b4a4; font-size: 14px; line-height: 1.75; margin-bottom: 14px; }
.prose strong { color: var(--pale); font-weight: 600; }
.prose em { color: var(--gold); font-style: normal; }

.cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px; margin: 16px 0; }

.card {
  background: linear-gradient(135deg, #110d22, #180d28);
  border: 1px solid #2d2642;
  border-radius: var(--radius);
  padding: 18px;
  transition: border-color var(--speed), transform var(--speed);
}
.card:hover { border-color: var(--wire); transform: translateY(-1px); }
.card.red  { border-left: 3px solid var(--blood); }
.card.gold { border-left: 3px solid var(--gold); }
.card.hot  { border-left: 3px solid var(--flame); }

.card-title {
  font-family: var(--ui);
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--pale);
  margin-bottom: 6px;
}
.card-body { font-size: 13px; color: var(--mid); line-height: 1.6; } .card-body strong { color: var(--pale); }

.info-box {
  background: rgba(80,15,150,0.10);
  border: 1px solid rgba(100,20,180,0.30);
  border-left: 3px solid var(--blood);
  border-radius: var(--radius);
  padding: 14px 18px;
  margin: 14px 0;
  font-size: 13px;
  color: #c8bc9e;
}
.info-box strong { color: var(--flame); }
.info-box.gold { background: rgba(200,136,58,0.06); border-color: rgba(200,136,58,0.2); border-left-color: var(--gold); }
.info-box.gold strong { color: var(--gold); }

h3 {
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 5px;
  text-transform: uppercase;
  color: var(--flame);
  margin: 28px 0 14px;
  padding-bottom: 6px;
  border-bottom: 1px solid rgba(168,61,255,0.35);
}

/* list */
.dot-list { list-style: none; padding: 0; }
.dot-list li {
  padding: 7px 0 7px 20px;
  border-bottom: 1px solid var(--ghost);
  color: var(--mid);
  font-size: 14px;
  position: relative;
}
.dot-list li::before {
  content: '//';
  position: absolute; left: 0; top: 8px;
  font-family: var(--mono);
  font-size: 10px;
  color: var(--blood);
}
.dot-list li strong { color: var(--pale); }

/* divider */
.divider {
  border: none;
  border-top: 1px solid var(--ghost);
  margin: 28px 0;
}

/* ═══════════════════════════════════════════
   INTERACTIVE FRETBOARD (SVG-based)
═══════════════════════════════════════════ */
.fret-wrap {
  background: #070710;
  border: 1px solid var(--edge);
  border-top: 2px solid var(--ember);
  border-radius: var(--radius);
  padding: 20px;
  margin: 14px 0;
  overflow-x: auto;
}
.fret-wrap svg { min-width: 680px; width: 100%; }

/* ═══════════════════════════════════════════
   SCALE SELECTOR
═══════════════════════════════════════════ */
.scale-pills { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 20px; }
.scale-pill {
  background: var(--iron);
  border: 1px solid var(--edge);
  color: var(--dim);
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 2px;
  padding: 6px 14px;
  cursor: pointer;
  text-transform: uppercase;
  transition: all var(--speed);
  border-radius: var(--radius);
}
.scale-pill:hover { color: var(--mid); border-color: var(--wire); }
.scale-pill.active { background: rgba(122,21,21,0.2); border-color: var(--blood); color: var(--hot); }

/* ═══════════════════════════════════════════
   HOME DASHBOARD
═══════════════════════════════════════════ */
.dashboard-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 12px;
  margin-bottom: 28px;
}
@media (max-width: 600px) { .dashboard-grid { grid-template-columns: 1fr 1fr; } }
@media (max-width: 400px) { .dashboard-grid { grid-template-columns: 1fr; } }

.stat-card {
  background: linear-gradient(135deg, rgba(18,12,32,0.95), rgba(28,18,44,0.9));
  border: 1px solid var(--edge);
  border-radius: var(--radius);
  padding: 18px 16px;
  text-align: center;
  position: relative;
  overflow: hidden;
  cursor: pointer;
  transition: all var(--speed);
}
.stat-card::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(136,34,238,0.08) 0%, transparent 70%);
  pointer-events: none;
}
.stat-card:hover { border-color: var(--wire); transform: translateY(-2px); }
.stat-val {
  font-family: var(--mono);
  font-size: 32px;
  color: var(--flame);
  line-height: 1;
  text-shadow: 0 0 20px rgba(187,85,255,0.5);
  font-weight: 600;
}
.stat-label {
  font-family: var(--ui);
  font-size: 10px;
  letter-spacing: 3px;
  color: #8880a0;
  text-transform: uppercase;
  margin-top: 6px;
}

.streak-flame {
  font-size: 18px;
  margin-bottom: 4px;
  display: block;
  filter: drop-shadow(0 0 8px rgba(232,93,32,0.6));
  animation: flicker 2.5s infinite;
}
@keyframes flicker {
  0%,100% { opacity: 1; }
  50%      { opacity: 0.82; }
  75%      { opacity: 0.95; }
}

/* QUICK TIP strip */
.quick-tip-strip {
  background: rgba(80,15,150,0.10);
  border: 1px solid rgba(100,20,180,0.25);
  border-left: 3px solid var(--ember);
  border-radius: var(--radius);
  padding: 16px 18px;
  display: flex;
  align-items: flex-start;
  gap: 14px;
  margin-bottom: 24px;
  cursor: pointer;
  transition: background var(--speed);
}
.quick-tip-strip:hover { background: rgba(122,21,21,0.12); }

.qt-icon { font-size: 18px; flex-shrink: 0; }
.qt-label {
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 3px;
  color: var(--ember);
  text-transform: uppercase;
  margin-bottom: 4px;
}
.qt-text { font-size: 13px; color: var(--pale); line-height: 1.5; }
.qt-action {
  margin-left: auto;
  flex-shrink: 0;
  font-family: var(--mono);
  font-size: 10px;
  color: var(--dim);
  letter-spacing: 2px;
  align-self: center;
  padding-left: 10px;
}

/* SECTION intro links on home */
.quick-nav {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 8px;
}
.quick-nav-btn {
  background: var(--iron);
  border: 1px solid var(--edge);
  border-radius: var(--radius);
  padding: 14px 12px;
  cursor: pointer;
  text-align: center;
  transition: all var(--speed);
  color: inherit;
  display: block;
}
.quick-nav-btn:hover { border-color: var(--blood); background: rgba(122,21,21,0.1); }
.qn-icon { font-size: 20px; margin-bottom: 8px; }
.qn-label {
  font-family: var(--ui);
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--pale);
}
.qn-sub {
  font-family: var(--mono);
  font-size: 9px;
  color: var(--dim);
  letter-spacing: 1px;
  margin-top: 4px;
}

/* ═══════════════════════════════════════════
   METRONOME
═══════════════════════════════════════════ */
.metro-shell {
  background: var(--iron);
  border: 1px solid var(--edge);
  border-radius: var(--radius);
  overflow: hidden;
}

.metro-display {
  background: #070710;
  padding: 36px 20px 28px;
  text-align: center;
  position: relative;
  border-bottom: 1px solid var(--edge);
}

.metro-bpm {
  font-family: var(--mono);
  font-size: 80px;
  font-weight: 600;
  line-height: 1;
  color: var(--hot);
  text-shadow: 0 0 40px rgba(232,93,32,0.5), 0 0 80px rgba(232,93,32,0.2);
  transition: color 0.1s;
  cursor: default;
  user-select: none;
}

.metro-bpm-unit {
  font-family: var(--mono);
  font-size: 11px;
  letter-spacing: 4px;
  color: var(--dim);
  text-transform: uppercase;
  margin-top: 4px;
}

.beat-row {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin: 20px 0 0;
}
.beat-pip {
  width: 10px; height: 10px;
  border-radius: 50%;
  background: var(--edge);
  border: 1px solid var(--wire);
  transition: all 0.06s;
}
.beat-pip.on {
  background: var(--hot);
  border-color: var(--hot);
  box-shadow: 0 0 12px var(--hot), 0 0 24px rgba(232,93,32,0.4);
}
.beat-pip.on.accent {
  background: var(--pale);
  border-color: var(--pale);
  box-shadow: 0 0 16px var(--hot), 0 0 32px rgba(232,93,32,0.5);
}

.metro-controls {
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.metro-row { display: flex; align-items: center; gap: 10px; justify-content: center; flex-wrap: wrap; }

.metro-slider {
  -webkit-appearance: none;
  flex: 1; max-width: 360px;
  height: 3px;
  background: linear-gradient(90deg, var(--blood), var(--ember));
  outline: none;
  cursor: pointer;
}
.metro-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px; height: 16px;
  background: var(--hot);
  border-radius: 50%;
  box-shadow: 0 0 10px rgba(232,93,32,0.6);
  cursor: pointer;
}

.btn {
  background: rgba(15,10,28,0.85);
  border: 1px solid #4a3d66;
  color: #b0a0c8;
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  padding: 9px 18px;
  cursor: pointer;
  transition: all var(--speed);
  border-radius: var(--radius);
}
.btn:hover { border-color: var(--blood); color: var(--pale); background: rgba(102,16,187,0.22); box-shadow: 0 0 12px rgba(119,24,204,0.25); }
.btn.primary { border-color: var(--blood); color: var(--pale); font-size: 11px; padding: 11px 28px; background: rgba(102,16,187,0.25); }
.btn.primary:hover { background: rgba(140,34,200,0.35); box-shadow: 0 0 18px rgba(196,42,24,0.25); border-color: var(--ember); }
.btn.primary.running { background: rgba(196,42,24,0.2); box-shadow: 0 0 16px rgba(196,42,24,0.2); color: var(--flame); }
.btn.danger:hover { border-color: var(--blood); color: var(--ember); background: rgba(154,16,16,0.1); }

/* tap tempo pulse */
@keyframes tapPulse {
  0%  { box-shadow: 0 0 0 0 rgba(232,93,32,0.5); }
  70% { box-shadow: 0 0 0 12px rgba(232,93,32,0); }
  100%{ box-shadow: 0 0 0 0 rgba(232,93,32,0); }
}
.tapping { animation: tapPulse 0.4s ease; }

/* ═══════════════════════════════════════════
   DAILY TIP
═══════════════════════════════════════════ */
.tip-card {
  background: linear-gradient(135deg, #0e0b18, #120f1e);
  border: 1px solid var(--edge);
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 20px;
}
.tip-card-header {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 16px 18px;
  background: rgba(0,0,0,0.3);
  border-bottom: 1px solid var(--edge);
}
.tip-orb {
  width: 38px; height: 38px;
  border: 1px solid var(--blood);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
  background: rgba(122,21,21,0.1);
}
.tip-meta-label { font-family: var(--mono); font-size: 9px; letter-spacing: 4px; color: var(--ember); text-transform: uppercase; }
.tip-meta-cat { font-family: var(--mono); font-size: 11px; color: var(--dim); letter-spacing: 2px; margin-top: 2px; }

.tip-body-text {
  padding: 26px 22px 20px;
  font-size: 16px;
  color: var(--pale);
  line-height: 1.75;
  font-weight: 300;
  min-height: 130px;
  display: flex; align-items: flex-start; gap: 14px;
  transition: opacity 0.25s;
}
.tip-body-text.loading { opacity: 0.25; }
.tip-quote { font-family: var(--display); font-size: 60px; color: var(--blood); opacity: 0.2; line-height: 0.8; flex-shrink: 0; margin-top: 8px; }

.tip-footer {
  padding: 12px 18px;
  border-top: 1px solid var(--ghost);
  display: flex; align-items: center; justify-content: space-between;
  flex-wrap: wrap; gap: 8px;
}
.tip-count { font-family: var(--mono); font-size: 10px; color: var(--dim); letter-spacing: 2px; }
.tip-count span { color: var(--ember); }

.tip-filter-row { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 16px; }
.tip-filter-tag {
  background: var(--iron); border: 1px solid var(--edge);
  color: var(--dim); font-family: var(--mono); font-size: 9px;
  letter-spacing: 2px; padding: 5px 11px; cursor: pointer;
  text-transform: uppercase; transition: all var(--speed); border-radius: var(--radius);
}
.tip-filter-tag:hover { color: var(--mid); border-color: var(--wire); }
.tip-filter-tag.active { background: rgba(122,21,21,0.2); border-color: var(--blood); color: var(--hot); }

.tip-history-wrap { background: var(--abyss); border: 1px solid var(--edge); border-top: none; border-radius: 0 0 var(--radius) var(--radius); }
.tip-history-head { font-family: var(--mono); font-size: 9px; letter-spacing: 3px; color: var(--dim); padding: 12px 16px 6px; text-transform: uppercase; }
.tip-hist-item {
  padding: 9px 16px; border-bottom: 1px solid var(--ghost);
  font-size: 12px; color: var(--dim); cursor: pointer;
  transition: color var(--speed); display: flex; gap: 10px; align-items: flex-start;
}
.tip-hist-item:hover { color: var(--mid); }
.tip-hist-num { font-family: var(--mono); font-size: 9px; color: var(--blood); flex-shrink: 0; margin-top: 3px; }

/* spin anim */
@keyframes spin { to { transform: rotate(360deg); } }
.spinning { animation: spin 0.7s linear infinite; display: inline-block; }

/* ═══════════════════════════════════════════
   NOTEPAD
═══════════════════════════════════════════ */
.notepad-outer { display: flex; flex-direction: column; }
.note-tab-row {
  display: flex;
  background: var(--abyss);
  border: 1px solid var(--edge);
  border-bottom: none;
  overflow-x: auto;
  scrollbar-width: none;
}
.note-tab-row::-webkit-scrollbar { display: none; }

.note-tab {
  display: flex; align-items: center; gap: 7px;
  padding: 10px 16px;
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 2px;
  color: var(--dim);
  cursor: pointer;
  border-right: 1px solid var(--edge);
  white-space: nowrap;
  transition: all var(--speed);
  text-transform: uppercase;
  user-select: none;
  flex-shrink: 0;
}
.note-tab:hover { color: var(--mid); background: rgba(255,255,255,0.02); }
.note-tab.active { color: var(--pale); background: var(--iron); border-bottom: 2px solid var(--ember); margin-bottom: -1px; }
.note-tab-x { color: var(--ghost); font-size: 13px; transition: color var(--speed); line-height: 1; }
.note-tab:hover .note-tab-x { color: var(--ember); }

.note-tab-input {
  background: transparent; border: none; outline: none;
  color: inherit; font-family: var(--mono); font-size: 10px;
  letter-spacing: 2px; text-transform: uppercase;
  width: 80px; cursor: pointer;
}

.note-add-btn {
  padding: 10px 14px; font-size: 16px; color: var(--ghost);
  cursor: pointer; transition: color var(--speed);
  display: flex; align-items: center; margin-left: auto; flex-shrink: 0;
}
.note-add-btn:hover { color: var(--ember); }

.note-editor {
  background: var(--iron);
  border: 1px solid var(--edge);
  border-radius: 0 0 var(--radius) var(--radius);
  display: flex; flex-direction: column;
}

.note-bar {
  display: flex; gap: 3px; align-items: center;
  padding: 8px 10px;
  background: rgba(0,0,0,0.25);
  border-bottom: 1px solid var(--ghost);
  flex-wrap: wrap;
}
.note-btn {
  background: transparent; border: 1px solid transparent;
  color: var(--dim); font-family: var(--mono); font-size: 11px;
  padding: 4px 10px; cursor: pointer;
  transition: all var(--speed); border-radius: var(--radius);
}
.note-btn:hover { border-color: var(--wire); color: var(--mid); background: rgba(255,255,255,0.03); }
.note-bar-sep { width: 1px; height: 16px; background: var(--edge); margin: 0 4px; flex-shrink: 0; }
.note-char { margin-left: auto; font-family: var(--mono); font-size: 9px; color: var(--dim); letter-spacing: 1px; padding: 4px; }

textarea.note-area {
  width: 100%; min-height: 300px;
  background: transparent; border: none; outline: none;
  color: var(--pale); font-family: var(--mono); font-size: 13px;
  font-weight: 300; line-height: 1.85; padding: 20px 22px;
  resize: vertical; caret-color: var(--hot);
}
textarea.note-area::placeholder { color: var(--ghost); }

.note-status {
  display: flex; align-items: center; justify-content: space-between;
  padding: 8px 16px; border-top: 1px solid var(--ghost);
  background: rgba(0,0,0,0.15); flex-wrap: wrap; gap: 8px;
}
.note-status-left { display: flex; align-items: center; gap: 12px; }
.saved-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--dim); transition: all 0.3s; }
.saved-dot.ok { background: #4a9a4a; box-shadow: 0 0 6px #4a9a4a; }
.saved-text { font-family: var(--mono); font-size: 9px; letter-spacing: 2px; color: var(--dim); text-transform: uppercase; }
.note-actions { display: flex; gap: 7px; }

/* ═══════════════════════════════════════════
   PROGRESS TRACKER
═══════════════════════════════════════════ */
.prog-row {
  display: flex; align-items: center; gap: 12px;
  margin: 7px 0; cursor: pointer;
}
.prog-label { font-family: var(--mono); font-size: 10px; letter-spacing: 1px; color: #b8a8c8; width: 140px; flex-shrink: 0; text-transform: uppercase; }
.prog-track { flex: 1; height: 5px; background: var(--edge); border-radius: 2px; overflow: hidden; }
.prog-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--crimson), var(--ember));
  transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 0 8px rgba(200,64,32,0.3);
}
.prog-pct { font-family: var(--mono); font-size: 10px; color: var(--flame); width: 34px; text-align: right; font-weight: 700; flex-shrink: 0; }

/* Achievements */
.achieve-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin: 16px 0; }
.achieve-badge {
  background: var(--iron);
  border: 1px solid var(--edge);
  border-radius: var(--radius);
  padding: 16px 12px;
  text-align: center;
  opacity: 0.35;
  transition: all var(--speed);
  position: relative;
}
.achieve-badge.unlocked {
  opacity: 1;
  border-color: var(--gold);
  box-shadow: 0 0 20px rgba(200,136,58,0.12);
}
.achieve-badge.unlocked::after {
  content: '';
  position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(200,136,58,0.05) 0%, transparent 60%);
  border-radius: var(--radius);
  pointer-events: none;
}
.badge-icon { font-size: 26px; margin-bottom: 8px; }
.badge-name { font-family: var(--ui); font-size: 11px; font-weight: 700; letter-spacing: 1px; color: var(--pale); text-transform: uppercase; margin-bottom: 4px; }
.badge-desc { font-size: 11px; color: var(--dim); }

/* ═══════════════════════════════════════════
   CHECKLIST
═══════════════════════════════════════════ */
.check-row {
  display: flex; align-items: flex-start; gap: 12px;
  padding: 12px 0; border-bottom: 1px solid var(--ghost);
  cursor: pointer; transition: background var(--speed);
}
.check-row:hover { background: rgba(255,255,255,0.01); }
.check-box {
  width: 18px; height: 18px; border: 1px solid var(--wire);
  flex-shrink: 0; margin-top: 2px; display: flex;
  align-items: center; justify-content: center;
  font-size: 11px; color: var(--hot); transition: all var(--speed);
}
.check-box.done { background: rgba(232,93,32,0.15); border-color: var(--ember); }
.check-main { font-size: 14px; color: var(--pale); font-weight: 400; display: block; margin-bottom: 2px; }
.check-sub { font-size: 12px; color: #9890a8; }

/* ═══════════════════════════════════════════
   ROADMAP / SUGGESTIONS
═══════════════════════════════════════════ */
.road-item {
  background: var(--iron);
  border: 1px solid var(--edge);
  border-radius: var(--radius);
  padding: 18px 20px;
  margin-bottom: 8px;
  display: flex; gap: 16px; align-items: flex-start;
  transition: all var(--speed);
}
.road-item:hover { border-color: var(--wire); }
.road-num {
  font-family: var(--mono); font-size: 20px; font-weight: 600;
  color: var(--blood); flex-shrink: 0; line-height: 1.2;
  width: 32px;
}
.road-body {}
.road-title { font-family: var(--ui); font-size: 15px; font-weight: 700; letter-spacing: 1px; color: var(--pale); margin-bottom: 4px; text-transform: uppercase; }
.road-desc { font-size: 13px; color: var(--mid); line-height: 1.6; margin-bottom: 8px; }
.road-tags { display: flex; gap: 5px; flex-wrap: wrap; }
.road-tag {
  font-family: var(--mono); font-size: 9px; letter-spacing: 2px;
  padding: 3px 8px; border: 1px solid; text-transform: uppercase;
}
.road-tag.impact { border-color: var(--ember); color: var(--ember); }
.road-tag.effort { border-color: var(--wire); color: var(--dim); }
.road-tag.type   { border-color: var(--gold); color: var(--gold); }

/* ═══════════════════════════════════════════
   SESSION BUILDER
═══════════════════════════════════════════ */
.session-block {
  background: linear-gradient(135deg, #100c20, #140e26);
  border: 1px solid var(--edge);
  border-radius: var(--radius);
  margin-bottom: 6px;
  cursor: pointer;
  transition: all var(--speed);
  overflow: hidden;
}
.session-block:hover { border-color: var(--wire); transform: translateX(2px); }
.session-block.active-block { border-color: var(--ember); background: linear-gradient(135deg, rgba(130,40,200,0.12), rgba(80,10,160,0.08)); box-shadow: 0 0 16px rgba(168,61,255,0.15); }
.session-block.selected-block { border-color: var(--blood); background: linear-gradient(135deg, rgba(100,20,180,0.14), rgba(60,8,130,0.08)); }
.session-block.done-block { opacity: 0.5; }
.block-header { display: flex; align-items: center; gap: 12px; padding: 13px 16px; }
.block-drag { color: var(--ghost); font-size: 13px; flex-shrink: 0; }
.block-color { width: 4px; height: 32px; border-radius: 2px; flex-shrink: 0; }
.block-info { flex: 1; min-width: 0; }
.block-name { font-family: var(--ui); font-size: 13px; font-weight: 600; letter-spacing: 0.5px; color: var(--pale); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.block-meta { display: flex; gap: 8px; margin-top: 3px; align-items: center; flex-wrap: wrap; }
.block-bpm { font-family: var(--mono); font-size: 10px; color: var(--flame); }
.block-skill { font-family: var(--mono); font-size: 9px; color: var(--dim); }
.block-timer-val {
  font-family: var(--mono); font-size: 20px; color: var(--hot);
  min-width: 54px; text-align: right; flex-shrink: 0; letter-spacing: 1px;
}
.block-chevron { font-size: 10px; color: var(--dim); flex-shrink: 0; transition: transform 0.2s; margin-left: 4px; }
.session-block.expanded .block-chevron { transform: rotate(180deg); color: var(--ember); }

/* Block detail panel */
.block-detail {
  max-height: 0; overflow: hidden;
  transition: max-height 0.32s cubic-bezier(0.4,0,0.2,1);
}
.session-block.expanded .block-detail { max-height: 600px; }
.block-detail-inner {
  padding: 0 16px 16px;
  border-top: 1px solid rgba(100,20,180,0.2);
  margin: 0 4px;
}
.block-detail-text {
  font-size: 13px; color: #c0b4a0; line-height: 1.7; margin: 12px 0;
}
.block-detail-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
.block-jump-btn {
  background: var(--blood); border: none; color: #fff;
  font-family: var(--mono); font-size: 10px; letter-spacing: 2px;
  padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: background 0.15s;
}
.block-jump-btn:hover { background: var(--ember); }
.block-set-metro-btn {
  background: transparent; border: 1px solid var(--wire);
  color: var(--mid); font-family: var(--mono); font-size: 10px;
  letter-spacing: 1px; padding: 7px 14px; border-radius: 4px; cursor: pointer; transition: all 0.15s;
}
.block-set-metro-btn:hover { border-color: var(--blood); color: var(--flame); }

.session-total {
  font-family: var(--mono); font-size: 11px; color: var(--dim);
  letter-spacing: 2px; text-align: right; padding: 8px 4px;
}

/* big timer */
.big-timer {
  background: #070710;
  border: 1px solid var(--edge);
  border-top: 2px solid var(--ember);
  border-radius: var(--radius);
  padding: 30px 20px;
  text-align: center;
  margin-bottom: 20px;
}
.big-timer-val {
  font-family: var(--mono);
  font-size: 64px;
  font-weight: 600;
  color: var(--hot);
  text-shadow: 0 0 40px rgba(232,93,32,0.4);
  line-height: 1;
}
.big-timer-label {
  font-family: var(--ui);
  font-size: 11px;
  letter-spacing: 4px;
  color: var(--dim);
  text-transform: uppercase;
  margin-top: 8px;
}

/* fade-in stagger for home items */
.stagger > * {
  animation: fadeSlideIn 0.4s ease both;
}
.stagger > *:nth-child(1) { animation-delay: 0.05s; }
.stagger > *:nth-child(2) { animation-delay: 0.1s; }
.stagger > *:nth-child(3) { animation-delay: 0.15s; }
.stagger > *:nth-child(4) { animation-delay: 0.2s; }
.stagger > *:nth-child(5) { animation-delay: 0.25s; }
.stagger > *:nth-child(6) { animation-delay: 0.3s; }

footer {
  text-align: center;
  padding: 32px 20px;
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 6px;
  color: var(--blood);
  border-top: 1px solid var(--crimson);
  text-shadow: 0 0 20px rgba(154,16,16,0.6);
  background: linear-gradient(180deg, transparent, rgba(154,16,16,0.05));
}

/* ══════════════════════════════════════
   TUNER
══════════════════════════════════════ */
/* ─── FLOATING METRONOME POPUP ─── */
.metro-popup {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 280px;
  background: rgba(8,6,14,0.97);
  border: 1px solid var(--edge);
  border-top: 2px solid var(--blood);
  border-radius: 12px;
  padding: 18px;
  z-index: 9001;
  display: none;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  box-shadow: 0 8px 40px rgba(0,0,0,0.8);
}
.metro-popup.open { display: block; animation: popup-in 0.2s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes popup-in {
  from { opacity:0; transform: translateY(12px) scale(0.95); }
  to   { opacity:1; transform: translateY(0) scale(1); }
}
.mp-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 14px;
}
.mp-title { font-family: var(--display); font-size: 11px; letter-spacing: 2px; color: var(--dim); }
.mp-close {
  background: none; border: none; color: var(--dim); cursor: pointer;
  font-size: 16px; line-height: 1; padding: 2px 6px;
  transition: color 0.15s;
}
.mp-close:hover { color: var(--pale); }
.mp-bpm-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-bottom: 12px;
}
.mp-bpm-num {
  font-family: var(--display);
  font-size: 52px;
  color: var(--crimson);
  min-width: 90px;
  text-align: center;
  line-height: 1;
  text-shadow: 0 0 20px rgba(180,20,20,0.5);
}
.mp-adj {
  background: var(--surface);
  border: 1px solid var(--edge);
  color: var(--pale);
  border-radius: 6px;
  font-size: 18px;
  width: 36px;
  height: 36px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s;
  flex-shrink: 0;
}
.mp-adj:hover { background: var(--blood); border-color: var(--crimson); }
.mp-adj:active { transform: scale(0.9); }
.mp-adj-group { display: flex; flex-direction: column; gap: 4px; }
.mp-adj.sm { font-size: 12px; height: 28px; }
.mp-slider {
  width: 100%;
  -webkit-appearance: none;
  height: 3px;
  background: var(--edge);
  border-radius: 2px;
  outline: none;
  margin: 8px 0;
}
.mp-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px; height: 14px;
  border-radius: 50%;
  background: var(--crimson);
  cursor: pointer;
  box-shadow: 0 0 6px rgba(180,20,20,0.6);
}
.mp-beat-row {
  display: flex; justify-content: center; gap: 6px; margin: 10px 0;
}
.mp-pip {
  width: 10px; height: 10px; border-radius: 50%;
  background: var(--edge); transition: background 0.05s, box-shadow 0.05s;
}
.mp-pip.on { background: var(--crimson); box-shadow: 0 0 8px var(--crimson); }
.mp-pip.accent { background: var(--ember); box-shadow: 0 0 10px var(--ember); }
.mp-start-btn {
  width: 100%;
  padding: 10px;
  background: var(--blood);
  border: 1px solid var(--crimson);
  color: var(--pale);
  font-family: var(--display);
  font-size: 12px;
  letter-spacing: 2px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.15s;
  margin-top: 4px;
}
.mp-start-btn:hover { background: var(--crimson); }
.mp-start-btn.running { background: rgba(180,20,20,0.2); border-color: var(--ember); color: var(--ember); }
.mp-tap-btn {
  width: 100%;
  padding: 8px;
  background: transparent;
  border: 1px solid var(--edge);
  color: var(--dim);
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 1px;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 6px;
  transition: border-color 0.15s, color 0.15s;
}
.mp-tap-btn:hover { border-color: var(--blood); color: var(--pale); }
.mp-tap-btn.tapping { border-color: var(--ember); color: var(--ember); }

/* ─── SESSION PAGE START/STOP BUTTON UPGRADE ─── */
.sess-start-wrap {
  position: sticky;
  bottom: 0;
  z-index: 200;
  background: linear-gradient(to top, #080010 70%, transparent);
  padding: 16px 20px 20px;
  margin: 0 -20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  pointer-events: none;
}
.sess-start-wrap > * { pointer-events: all; }
.sess-controls-row {
  display: flex;
  gap: 8px;
  justify-content: center;
  flex-wrap: wrap;
}
.sess-big-btn {
  padding: 14px 40px;
  font-family: var(--display);
  font-size: 14px;
  letter-spacing: 3px;
  border-radius: 8px;
  border: 1.5px solid var(--blood);
  background: rgba(120,10,10,0.2);
  color: var(--pale);
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: background 0.2s, border-color 0.2s, box-shadow 0.2s;
}
.sess-big-btn::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(180,30,30,0.15) 0%, transparent 60%);
  pointer-events: none;
}
.sess-big-btn:hover { background: rgba(110,15,180,0.35); border-color: var(--crimson); box-shadow: 0 0 20px rgba(130,20,200,0.3); }
.sess-big-btn.running {
  border-color: var(--gold);
  background: rgba(200,136,58,0.15);
  animation: sess-pulse 2s ease-in-out infinite;
}
.sess-big-btn.running::before { background: linear-gradient(135deg, rgba(200,136,58,0.1) 0%, transparent 60%); }
@keyframes sess-pulse {
  0%,100% { box-shadow: 0 0 0 rgba(200,136,58,0); }
  50% { box-shadow: 0 0 24px rgba(200,136,58,0.35); }
}


/* ─── RIFF LAB ─── */
.riff-card { background: var(--surface); border: 1px solid var(--edge); border-radius: 10px; padding: 20px; }
.riff-card-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px; margin-bottom: 14px; }
.riff-title { font-family: var(--display); font-size: 22px; color: var(--pale); letter-spacing: 2px; }
.riff-tags { display: flex; gap: 6px; flex-wrap: wrap; }
.riff-tag { font-family: var(--mono); font-size: 9px; letter-spacing: 2px; border: 1px solid var(--edge); border-radius: 4px; padding: 2px 8px; color: var(--dim); }
.riff-tip { background: rgba(200,136,58,0.08); border: 1px solid rgba(200,136,58,0.3); border-radius: 6px; padding: 12px 14px; margin-top: 14px; font-size: 13px; color: #c8bca8; display: flex; gap: 10px; align-items: flex-start; }
.riff-tip-label { font-family: var(--mono); font-size: 9px; letter-spacing: 2px; color: var(--gold); flex-shrink: 0; padding-top: 2px; }

/* ── RAMP MODE ─────────────────────────────── */
.ramp-panel { background: rgba(80,0,140,0.10); border: 1px solid var(--blood); border-radius:8px; padding:14px 16px; margin-top:16px; }
.ramp-row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
.ramp-label { font-family:var(--mono); font-size:10px; letter-spacing:1px; color:var(--dim); min-width:60px; }
.ramp-num { font-family:var(--mono); font-size:13px; color:var(--pale); background:var(--iron); border:1px solid var(--wire); border-radius:4px; width:52px; text-align:center; padding:4px 0; }
.ramp-status { font-family:var(--mono); font-size:12px; color:var(--flame); margin-top:6px; min-height:18px; }

/* ── CONTEXT BAR (global quick-start strip) ─── */
#context-bar {
  display: none;
  position: fixed;
  bottom: 0; left: 0; right: 0;
  z-index: 190;
  background: linear-gradient(to top, rgba(6,3,16,0.98) 60%, transparent);
  padding: 12px 20px 20px;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  flex-wrap: wrap;
  pointer-events: none;
}
#context-bar > * { pointer-events: all; }
.ctx-info { flex: 1; min-width: 120px; }
.ctx-name { font-size: 12px; color: var(--pale); font-weight: 600; }
.ctx-bpm-badge { font-family: var(--mono); font-size: 10px; color: var(--flame); letter-spacing: 1px; margin-top: 2px; }
.ctx-actions { display: flex; gap: 8px; flex-wrap: wrap; }

/* ── PLAN BLOCK MODAL ──────────────────────── */
#plan-block-modal {
  display: none;
  position: fixed; inset: 0; z-index: 9100;
  background: rgba(0,0,0,0.78);
  align-items: center; justify-content: center;
}
.pbm-inner {
  background: #0c0918;
  border: 1px solid var(--blood);
  border-radius: 14px;
  padding: 26px 22px;
  width: 92%; max-width: 400px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 8px 50px rgba(100,10,180,0.4);
}
.pbm-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:14px; gap:10px; }
.pbm-title { font-size:14px; font-weight:700; color:var(--pale); line-height:1.4; flex:1; }
.pbm-close { background:none; border:none; color:var(--dim); font-size:22px; cursor:pointer; padding:0 4px; flex-shrink:0; }
.pbm-meta { display:flex; gap:10px; margin-bottom:14px; }
.pbm-badge { font-family:var(--mono); font-size:9px; letter-spacing:2px; border-radius:3px; padding:3px 8px; border:1px solid; }
.pbm-body { font-size:13px; color:var(--mid); line-height:1.7; }
.pbm-start { width:100%; margin-top:18px; padding:12px; background:var(--blood); border:none; color:#fff; font-family:var(--mono); font-size:11px; letter-spacing:2px; border-radius:6px; cursor:pointer; }
  margin-top: 18px;
  border: 1px solid var(--blood);
  border-radius: 10px;
  overflow: hidden;
  background: rgba(80,0,140,0.07);
}
.riff-session-header {
  background: rgba(110,20,180,0.15);
  padding: 10px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 8px;
}
.riff-session-title { font-family: var(--mono); font-size: 10px; letter-spacing: 2px; color: var(--blood); }
.riff-session-timer { font-family: var(--mono); font-size: 22px; color: var(--lead); font-weight: 700; }
.riff-session-label { font-size: 11px; color: var(--dim); margin-top: 2px; }
.riff-session-blocks { padding: 12px 16px; display: flex; flex-direction: column; gap: 6px; }
.riff-sblock { display: flex; align-items: center; gap: 10px; padding: 6px 0; border-bottom: 1px solid var(--ghost); }
.riff-sblock:last-child { border-bottom: none; }
.riff-sblock-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.riff-sblock-name { flex: 1; font-size: 12px; color: var(--mid); }
.riff-sblock-time { font-family: var(--mono); font-size: 11px; color: var(--dim); }
.riff-sblock.riff-sblock-active .riff-sblock-name { color: var(--lead); font-weight: 600; }
.riff-sblock.riff-sblock-done .riff-sblock-name { color: var(--dim); text-decoration: line-through; }
.riff-session-footer { padding: 12px 16px; display: flex; gap: 8px; flex-wrap: wrap; border-top: 1px solid var(--ghost); }
.tab-key { font-family: var(--mono); font-size: 10px; color: var(--dim); border-top: 1px solid var(--edge); margin-top: 10px; padding-top: 8px; line-height: 1.8; }
.tab-key-title { color: var(--gold); letter-spacing: 1px; }

/* ─── SESSION RECOMMENDATION BANNERS ─── */
.sess-rec { background: rgba(180,20,20,0.1); border: 1px solid rgba(130,20,200,0.3); border-radius: 8px; padding: 12px 16px; margin: 16px 0; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
.sess-rec-text { font-size: 12px; color: var(--dim); font-family: var(--mono); letter-spacing: 1px; }
.sess-rec-btn { font-family: var(--mono); font-size: 10px; letter-spacing: 2px; padding: 6px 14px; background: var(--blood); border: 1px solid var(--crimson); color: var(--pale); border-radius: 5px; cursor: pointer; transition: background 0.15s; }
.sess-rec-btn:hover { background: var(--crimson); }

/* ─── FRETBOARD SVG UPGRADE ─── */
#fretboard-svg { width: 100%; border-radius: 8px; border: 1px solid var(--edge); margin: 16px 0; background: #060610; }
.fret-key { display: flex; gap: 14px; flex-wrap: wrap; margin-top: 8px; font-family: var(--mono); font-size: 10px; color: var(--dim); }
.fret-key-item { display: flex; align-items: center; gap: 5px; }
.fret-key-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

/* ─── POSITION GRAPHIC ─── */
.pos-graphic { margin: 12px 0; }
.pos-graphic svg { width: 100%; max-width: 340px; display: block; }
.pos-label { font-family: var(--mono); font-size: 9px; letter-spacing: 2px; color: var(--dim); margin-top: 4px; }

/* ─── WEEKLY CHART ─── */
.week-chart { display: flex; align-items: flex-end; gap: 4px; height: 80px; margin: 16px 0; }
.week-bar-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; }
.week-bar { width: 100%; background: linear-gradient(to top, var(--crimson), var(--blood)); border-radius: 2px 2px 0 0; min-height: 3px; transition: height 0.4s; }
.week-bar.today { background: linear-gradient(to top, var(--blood), var(--flame)); box-shadow: 0 0 8px rgba(187,85,255,0.4); }
.week-day { font-family: var(--mono); font-size: 8px; color: #8880a0; letter-spacing: 1px; }
.week-mins { font-family: var(--mono); font-size: 8px; color: var(--hot); font-weight: 700; }


/* ─── THEORY PAGE ─── */
.theory-tabs {
  display: flex;
  gap: 0;
  border-bottom: 1px solid var(--edge);
  margin-bottom: 24px;
}
.theory-tab {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--dim);
  padding: 12px 20px;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all var(--speed);
  user-select: none;
}
.theory-tab:hover { color: var(--mid); background: rgba(154,16,16,0.04); }
.theory-tab.active {
  color: var(--flame);
  border-bottom-color: var(--blood);
  background: rgba(154,16,16,0.06);
}
.theory-panel { display: none; }
.theory-panel.active { display: block; }

.theory-selectors {
  display: flex;
  gap: 14px;
  flex-wrap: wrap;
  align-items: flex-start;
  margin-bottom: 8px;
}
.theory-select-wrap { display: flex; flex-direction: column; gap: 5px; }
.theory-label {
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 3px;
  color: var(--dim);
}
.theory-select {
  background: var(--forge);
  border: 1px solid var(--wire);
  color: var(--pale);
  font-family: var(--mono);
  font-size: 12px;
  padding: 8px 12px;
  border-radius: var(--radius);
  cursor: pointer;
  min-width: 160px;
}
.theory-select:focus { outline: none; border-color: var(--blood); }

.scale-result-item {
  background: rgba(12,9,20,0.6);
  border: 1px solid var(--edge);
  border-left: 3px solid var(--wire);
  border-radius: var(--radius);
  padding: 12px 16px;
  margin-bottom: 6px;
  transition: border-color var(--speed);
}
.scale-result-item.best {
  border-left-color: var(--ember);
  background: rgba(154,16,16,0.08);
  box-shadow: 0 0 12px rgba(154,16,16,0.1);
}
.scale-result-name {
  font-family: var(--display);
  font-size: 15px;
  color: var(--pale);
  font-weight: 700;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4px;
}
.scale-result-match {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 2px;
  color: var(--ember);
}
.scale-result-notes {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--gold);
  letter-spacing: 2px;
  margin-bottom: 4px;
}
.scale-result-desc { font-size: 12px; color: var(--dim); }

/* ─── INTERVAL TRAINER ─── */
.interval-trainer-shell {
  background: linear-gradient(135deg, #110d22, #160d26);
  border: 1px solid var(--edge);
  border-top: 2px solid var(--blood);
  border-radius: var(--radius);
  padding: 24px;
}
.interval-display { text-align: center; margin-bottom: 20px; }
.interval-scores {
  display: flex;
  justify-content: center;
  gap: 32px;
  margin-bottom: 20px;
}
.int-score-item { display: flex; flex-direction: column; align-items: center; gap: 4px; }
.int-score-val {
  font-family: var(--display);
  font-size: 28px;
  color: var(--ember);
  line-height: 1;
  text-shadow: 0 0 20px rgba(196,42,24,0.4);
}
.int-score-lbl { font-family: var(--mono); font-size: 8px; letter-spacing: 3px; color: var(--dim); }
.interval-reveal {
  font-family: var(--display);
  font-size: 32px;
  color: var(--pale);
  letter-spacing: 2px;
  margin-bottom: 6px;
  text-shadow: 0 0 30px rgba(196,42,24,0.25);
  text-transform: uppercase;
}
.interval-sub { font-family: var(--mono); font-size: 11px; color: var(--dim); letter-spacing: 2px; margin-bottom: 8px; }
.interval-context { font-size: 12px; color: var(--gold); font-style: italic; max-width: 380px; margin: 0 auto; }
.interval-controls { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
.interval-options {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 8px;
}
.interval-opt {
  background: rgba(12,9,20,0.8);
  border: 1px solid var(--wire);
  color: var(--mid);
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  padding: 12px 10px;
  text-align: center;
  cursor: pointer;
  border-radius: var(--radius);
  transition: all var(--speed);
  user-select: none;
}
.interval-opt:hover { border-color: var(--blood); color: var(--bone); background: rgba(154,16,16,0.1); }
.interval-opt.correct { border-color: #2a8a4a; color: #4ecb71; background: rgba(42,138,74,0.1); }
.interval-opt.wrong   { border-color: var(--blood); color: var(--ember); background: rgba(102,16,187,0.15); }

/* ─── WEEKLY REVIEW ─── */
.review-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 10px;
  margin-bottom: 24px;
}
.review-stat {
  background: linear-gradient(135deg, #110d22, #160d26);
  border: 1px solid var(--edge);
  border-top: 2px solid var(--blood);
  border-radius: var(--radius);
  padding: 18px 14px;
  text-align: center;
}
.review-stat-val {
  font-family: var(--display);
  font-size: 36px;
  color: var(--ember);
  line-height: 1;
  text-shadow: 0 0 20px rgba(196,42,24,0.4);
  margin-bottom: 6px;
}
.review-stat-lbl { font-family: var(--mono); font-size: 9px; letter-spacing: 3px; color: var(--dim); text-transform: uppercase; }

.review-bar-section { display: flex; flex-direction: column; gap: 8px; }
.review-bar-row { display: flex; align-items: center; gap: 10px; }
.review-bar-label { font-family: var(--mono); font-size: 10px; color: var(--dim); width: 130px; flex-shrink: 0; letter-spacing: 1px; }
.review-bar-track { flex: 1; height: 6px; background: var(--forge); border-radius: 3px; overflow: hidden; }
.review-bar-fill { height: 100%; background: linear-gradient(90deg, var(--blood), var(--ember)); border-radius: 3px; transition: width 0.6s ease; }
.review-bar-pct { font-family: var(--mono); font-size: 10px; color: var(--ember); width: 32px; text-align: right; }

/* ─── PROGRESS CARD ─── */
.card-preview {
  background: linear-gradient(135deg, #0a0714, #100c1c, #0a0714);
  border: 1px solid var(--crimson);
  border-top: 3px solid var(--blood);
  border-radius: var(--radius);
  padding: 24px;
  font-family: var(--mono);
}
.card-preview-title {
  font-family: var(--display);
  font-size: 22px;
  color: var(--pale);
  letter-spacing: 4px;
  text-transform: uppercase;
  text-shadow: 0 0 20px rgba(196,42,24,0.3);
  margin-bottom: 4px;
}
.card-preview-sub { font-size: 10px; letter-spacing: 3px; color: var(--dim); margin-bottom: 20px; }
.card-preview-stats { display: flex; gap: 24px; margin-bottom: 20px; }
.card-prev-stat { text-align: center; }
.card-prev-val { font-family: var(--display); font-size: 28px; color: var(--ember); }
.card-prev-lbl { font-size: 9px; letter-spacing: 2px; color: var(--dim); }
.card-skill-row { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
.card-skill-lbl { font-size: 10px; color: var(--dim); width: 130px; letter-spacing: 1px; }
.card-skill-bar { flex: 1; height: 4px; background: var(--forge); border-radius: 2px; overflow: hidden; }
.card-skill-fill { height: 100%; background: linear-gradient(90deg, var(--crimson), var(--blood)); }

/* ─── DEATH METAL INFO BOX ─── */
.info-box {
  background: rgba(12,9,20,0.7);
  border: 1px solid var(--wire);
  border-left: 3px solid var(--blood);
  border-radius: var(--radius);
  padding: 14px 18px;
  font-size: 13px;
  color: var(--mid);
  line-height: 1.7;
}
.info-box strong { color: var(--bone); }

/* ─── SECTION CARDS DEATH POLISH ─── */
.card { background: linear-gradient(135deg, #0c0918, #100d1c); }
.card.red  { border-top-color: var(--blood); }
.card.gold { border-top-color: var(--gold); }
.card.hot  { border-top-color: var(--flame); }

/* ─── PROGRESS BARS DEATH POLISH ─── */
.prog-bar-fill { background: linear-gradient(90deg, var(--crimson), var(--blood), var(--ember)) !important; }

/* ─── SESSION BIG BUTTON ─── */
.sess-big-btn {
  font-family: var(--mono);
  font-size: 12px;
  letter-spacing: 4px;
  text-transform: uppercase;
}
.sess-big-btn.running {
  border-color: var(--blood) !important;
  box-shadow: 0 0 30px rgba(102,16,187,0.3) !important;
}

/* ─── BIG TIMER ─── */
.big-timer-val {
  text-shadow: 0 0 40px rgba(196,42,24,0.5) !important;
  color: var(--ember) !important;
}

/* ─── METRO DISPLAY ─── */
.metro-bpm { color: var(--hot) !important; text-shadow: 0 0 40px rgba(196,102,255,0.6) !important; }
.beat-pip.on { background: var(--flame) !important; box-shadow: 0 0 10px var(--flame) !important; }
.beat-pip.accent { background: var(--pale) !important; box-shadow: 0 0 14px var(--pale) !important; }

/* ─── SCROLL BAR DEATH ─── */
::-webkit-scrollbar-thumb { background: var(--blood) !important; border-radius: 0 !important; }

/* ─── SCALE PILLS ─── */
.scale-pill {
  font-family: var(--mono) !important;
  font-size: 10px !important;
  letter-spacing: 2px !important;
}
.scale-pill.active {
  background: rgba(102,16,187,0.3) !important;
  border-color: var(--blood) !important;
  color: var(--flame) !important;
  box-shadow: 0 0 10px rgba(154,16,16,0.2) !important;
}


/* ═══════════════════════════════════════════════
   FLOATING ACTION BUTTONS
═══════════════════════════════════════════════ */
.fab-cluster {
  position: fixed;
  bottom: 24px;
  right: 20px;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 10px;
  z-index: 9000;
  user-select: none;
}
.fab {
  width: 52px;
  height: 52px;
  border-radius: 50%;
  border: 1.5px solid var(--wire);
  background: rgba(5,4,14,0.95);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  color: var(--mid);
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(0,0,0,0.7), inset 0 1px 0 rgba(255,255,255,0.03);
  transition: transform 0.15s, border-color 0.15s, box-shadow 0.15s, color 0.15s;
  position: relative;
}
.fab:hover {
  transform: scale(1.1);
  border-color: var(--blood);
  color: var(--pale);
  box-shadow: 0 4px 24px rgba(154,16,16,0.4), inset 0 1px 0 rgba(255,255,255,0.05);
}
.fab:active { transform: scale(0.95); }
.fab.active-fab { border-color: var(--ember); color: var(--flame); background: rgba(154,16,16,0.2); }
.fab.session-running {
  border-color: var(--gold);
  color: var(--gold);
  animation: fab-pulse 2s ease-in-out infinite;
}
@keyframes fab-pulse {
  0%,100% { box-shadow: 0 4px 20px rgba(0,0,0,0.6); }
  50% { box-shadow: 0 4px 28px rgba(184,120,40,0.5); }
}
.fab-label {
  position: absolute;
  right: 60px;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(5,4,14,0.96);
  border: 1px solid var(--wire);
  border-radius: 3px;
  padding: 4px 10px;
  font-family: var(--mono);
  font-size: 9px;
  color: var(--dim);
  letter-spacing: 2px;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
}
.fab:hover .fab-label { opacity: 1; }
.fab-timer-val {
  font-family: var(--mono);
  font-size: 9px;
  color: var(--gold);
  position: absolute;
  bottom: -17px;
  left: 50%;
  transform: translateX(-50%);
  white-space: nowrap;
  letter-spacing: 1px;
  opacity: 0;
  transition: opacity 0.2s;
}
.fab.session-running .fab-timer-val { opacity: 1; }

/* ─── FLOATING METRONOME POPUP ─── */
.metro-popup {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 280px;
  background: rgba(5,4,14,0.98);
  border: 1px solid var(--wire);
  border-top: 2px solid var(--blood);
  border-radius: 4px;
  padding: 18px;
  z-index: 9001;
  display: none;
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  box-shadow: 0 8px 40px rgba(0,0,0,0.85);
}
.metro-popup.open { display: block; animation: popup-in 0.2s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes popup-in {
  from { opacity:0; transform: translateY(12px) scale(0.95); }
  to   { opacity:1; transform: translateY(0) scale(1); }
}
.mp-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 14px;
}
.mp-title { font-family: var(--mono); font-size: 10px; letter-spacing: 4px; color: var(--dim); }
.mp-close {
  background: none; border: none; color: var(--dim); cursor: pointer;
  font-size: 18px; line-height: 1; padding: 2px 6px; transition: color 0.15s;
}
.mp-close:hover { color: var(--pale); }
.mp-bpm-row {
  display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 12px;
}
.mp-bpm-num {
  font-family: var(--display);
  font-size: 52px;
  color: var(--flame);
  min-width: 90px;
  text-align: center;
  line-height: 1;
  text-shadow: 0 0 20px rgba(224,64,16,0.5);
  letter-spacing: 2px;
}
.mp-adj-group { display: flex; flex-direction: column; gap: 5px; }
.mp-adj {
  background: var(--forge);
  border: 1px solid var(--wire);
  color: var(--mid);
  border-radius: 3px;
  font-family: var(--mono);
  font-size: 11px;
  width: 40px; height: 34px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  transition: all 0.15s;
}
.mp-adj:hover { background: rgba(102,16,187,0.3); border-color: var(--blood); color: var(--pale); }
.mp-adj:active { transform: scale(0.92); }
.mp-adj.sm { font-size: 10px; height: 28px; }
.mp-slider {
  width: 100%; -webkit-appearance: none; height: 3px;
  background: var(--wire); border-radius: 2px; outline: none; margin: 8px 0;
}
.mp-slider::-webkit-slider-thumb {
  -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%;
  background: var(--blood); cursor: pointer; box-shadow: 0 0 6px rgba(154,16,16,0.6);
}
.mp-beat-row { display: flex; justify-content: center; gap: 8px; margin: 10px 0; }
.mp-pip {
  width: 10px; height: 10px; border-radius: 50%;
  background: var(--wire); transition: background 0.05s, box-shadow 0.05s;
}
.mp-pip.on { background: var(--flame); box-shadow: 0 0 8px var(--flame); }
.mp-pip.accent { background: var(--pale); box-shadow: 0 0 12px var(--pale); }
.mp-start-btn {
  width: 100%; padding: 10px;
  background: rgba(102,16,187,0.25);
  border: 1px solid var(--blood);
  color: var(--pale);
  font-family: var(--mono); font-size: 11px; letter-spacing: 3px;
  border-radius: 3px; cursor: pointer; transition: background 0.15s; margin-top: 4px;
}
.mp-start-btn:hover { background: rgba(140,34,200,0.35); }
.mp-start-btn.running { background: rgba(102,16,187,0.15); border-color: var(--ember); color: var(--flame); }
.mp-tap-btn {
  width: 100%; padding: 8px;
  background: transparent; border: 1px solid var(--wire);
  color: var(--dim); font-family: var(--mono); font-size: 10px; letter-spacing: 2px;
  border-radius: 3px; cursor: pointer; margin-top: 6px; transition: all 0.15s;
}
.mp-tap-btn:hover { border-color: var(--blood); color: var(--pale); }
.mp-tap-btn.tapping { border-color: var(--ember); color: var(--ember); }

/* ── INTERACTIVE BLOCK DETAIL ───────────────────────── */
.session-block {
  cursor: pointer;
}
.session-block.block-selected {
  border-color: var(--ember);
  background: rgba(130,40,200,0.10);
  border-radius: var(--radius) var(--radius) 0 0;
  margin-bottom: 0;
}
.block-chevron {
  font-size: 9px;
  color: var(--dim);
  flex-shrink: 0;
  margin-left: 2px;
  transition: color var(--speed);
  width: 12px;
  text-align: center;
}
.session-block.block-selected .block-chevron { color: var(--ember); }
.block-meta {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--dim);
  margin-top: 2px;
}
.block-detail-panel {
  background: linear-gradient(135deg, #0f0c20, #140e26);
  border: 1px solid var(--ember);
  border-top: none;
  border-radius: 0 0 var(--radius) var(--radius);
  padding: 16px 18px 18px;
  margin-bottom: 8px;
}
.block-detail-coaching {
  font-size: 13px;
  color: #c8bca8;
  line-height: 1.75;
  margin-bottom: 12px;
}
.block-detail-ex-label {
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 2px;
  color: var(--ember);
  margin: 14px 0 6px;
  text-transform: uppercase;
}
.block-detail-tab {
  background: #05040e;
  border: 1px solid var(--edge);
  border-left: 2px solid var(--blood);
  padding: 12px 14px;
  margin: 6px 0;
  font-family: var(--mono);
  font-size: 12px;
  white-space: pre;
  overflow-x: auto;
  color: #f0e8d8;
  line-height: 1.7;
  border-radius: 2px;
}
.block-detail-instruction {
  font-size: 12px;
  color: var(--mid);
  line-height: 1.7;
  margin-top: 8px;
}
.block-detail-mistake {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--gold);
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid var(--ghost);
}
.block-detail-actions {
  display: flex;
  gap: 8px;
  margin-top: 14px;
  flex-wrap: wrap;
  align-items: center;
}
.block-detail-actions .btn {
  font-size: 10px;
  padding: 7px 14px;
}

/* ── ADD TO SESSION FOOTER ──────────────────────────── */
.sess-add-footer {
  border-top: 1px solid var(--edge);
  padding: 12px 18px;
  display: flex;
  align-items: center;
  gap: 10px;
  background: rgba(0,0,0,0.18);
  flex-wrap: wrap;
}
.sess-add-label {
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 2px;
  color: var(--dim);
  text-transform: uppercase;
  flex-shrink: 0;
}
.sess-add-mins {
  display: flex;
  align-items: center;
  gap: 6px;
}
.sess-add-mins-input {
  width: 48px;
  background: var(--forge);
  border: 1px solid var(--wire);
  color: var(--pale);
  font-family: var(--mono);
  font-size: 11px;
  padding: 4px 6px;
  border-radius: 3px;
  text-align: center;
}
.sess-add-mins-lbl {
  font-family: var(--mono);
  font-size: 9px;
  color: var(--dim);
}
.add-to-sess-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: rgba(119,24,204,0.28);
  border: 1px solid var(--blood);
  color: var(--pale);
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  padding: 8px 16px;
  cursor: pointer;
  border-radius: var(--radius);
  transition: all var(--speed);
  white-space: nowrap;
}
.add-to-sess-btn:hover {
  background: rgba(168,61,255,0.38);
  border-color: var(--flame);
  box-shadow: 0 0 14px rgba(168,61,255,0.3);
}
.add-to-sess-inline-btn {
  margin-top: 12px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: rgba(119,24,204,0.22);
  border: 1px solid var(--wire);
  color: var(--mid);
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  padding: 6px 12px;
  cursor: pointer;
  border-radius: var(--radius);
  transition: all var(--speed);
}
.add-to-sess-inline-btn:hover {
  border-color: var(--blood);
  color: var(--flame);
  background: rgba(168,61,255,0.22);
}
/* Toast notification */
.sess-toast {
  position: fixed;
  bottom: 110px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--blood);
  color: var(--pale);
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 2px;
  padding: 10px 22px;
  border-radius: 4px;
  z-index: 9999;
  pointer-events: none;
  white-space: nowrap;
  box-shadow: 0 4px 24px rgba(0,0,0,0.6);
  animation: toastIn 0.2s ease;
}
@keyframes toastIn {
  from { opacity:0; transform: translateX(-50%) translateY(10px); }
  to   { opacity:1; transform: translateX(-50%) translateY(0); }
}


</style>
</head>
<body>

<header>
  <div class="header-eyebrow">⟦ Grimoire of the Seven Strings ⟧</div>
  <h1>DROP A GRIMOIRE</h1>
  <div class="header-sub">7-String · Deathcore · Self-Learning Codex</div>
  <div class="header-line"></div>
</header>

<div class="nav-wrap">
  <nav>
    <button class="active" onclick="goTo('home',this)">Home</button>
    <button onclick="goTo('fundamentals',this)">Fundamentals</button>
    <button onclick="goTo('scales',this)">Scales</button>
    <button onclick="goTo('arpeggios',this)">Arpeggios</button>
    <button onclick="goTo('techniques',this)">Techniques</button>
    <button onclick="goTo('session',this)">Session</button>
    <button onclick="goTo('metronome',this)">Metronome</button>
    <button onclick="goTo('dailytip',this)">Daily Tip</button>
    <button onclick="goTo('notepad',this)">Notepad</button>
    <button onclick="goTo('progress',this)">Progress</button>
    <button onclick="goTo('review',this)">Weekly Review</button>
    <button onclick="goTo('theory',this)">Theory</button>
    <button onclick="goTo('riff',this)">Riff Lab</button>
    <button onclick="goTo('roadmap',this)">Roadmap</button>
  </nav>
</div>

<!-- ═══════════════════════════════════ HOME ═══════ -->
<div id="home" class="page active">
  <div class="page-header stagger">
    <div class="page-title">Welcome back, Shredder.</div>
    <div class="page-lead">Your personal 7-string deathcore learning codex. Everything in one place.</div>
  </div>

  <div class="dashboard-grid stagger" id="home-stats">
    <div class="stat-card">
      <span class="streak-flame">🔥</span>
      <div class="stat-val" id="stat-streak">0</div>
      <div class="stat-label">Day Streak</div>
    </div>
    <div class="stat-card" onclick="goTo('session', document.querySelector('nav button:nth-child(6)'))">
      <div style="font-size:20px;margin-bottom:4px">⏱</div>
      <div class="stat-val" id="stat-mins">0</div>
      <div class="stat-label">Mins Logged</div>
    </div>
    <div class="stat-card" onclick="goTo('progress', document.querySelector('nav button:nth-child(10)'))">
      <div style="font-size:20px;margin-bottom:4px">⊕</div>
      <div class="stat-val" id="stat-skills">0%</div>
      <div class="stat-label">Avg Progress</div>
    </div>
  </div>

  <div class="quick-tip-strip stagger" id="home-tip-strip" onclick="goTo('dailytip', document.querySelector('nav button:nth-child(8)'))">
    <div class="qt-icon">✦</div>
    <div>
      <div class="qt-label">Today's Transmission</div>
      <div class="qt-text" id="home-tip-text">Click to load your daily tip...</div>
    </div>
    <div class="qt-action">NEW TIP →</div>
  </div>

  <div id="week-chart-section" style="margin:8px 0 16px"></div>
  <h3>Quick Navigation</h3>
  <div class="quick-nav stagger">
    <div class="quick-nav-btn" onclick="goTo('fundamentals', document.querySelector('nav button:nth-child(2)'))">
      <div class="qn-icon">🎸</div>
      <div class="qn-label">Fundamentals</div>
      <div class="qn-sub">Start here</div>
    </div>
    <div class="quick-nav-btn" onclick="goTo('scales', document.querySelector('nav button:nth-child(3)'))">
      <div class="qn-icon">≡</div>
      <div class="qn-label">Scales</div>
      <div class="qn-sub">Minor · Phrygian · Dim</div>
    </div>
    <div class="quick-nav-btn" onclick="goTo('arpeggios', document.querySelector('nav button:nth-child(4)'))">
      <div class="qn-icon">◈</div>
      <div class="qn-label">Arpeggios</div>
      <div class="qn-sub">Sweep shapes</div>
    </div>
    <div class="quick-nav-btn" onclick="goTo('techniques', document.querySelector('nav button:nth-child(5)'))">
      <div class="qn-icon">⊕</div>
      <div class="qn-label">Techniques</div>
      <div class="qn-sub">Chugs · Gallops · Sweeps</div>
    </div>
    <div class="quick-nav-btn" onclick="goTo('session', document.querySelector('nav button:nth-child(6)'))">
      <div class="qn-icon">⏱</div>
      <div class="qn-label">Session</div>
      <div class="qn-sub">Practice timer</div>
    </div>
    <div class="quick-nav-btn" onclick="goTo('metronome', document.querySelector('nav button:nth-child(7)'))">
      <div class="qn-icon">♩</div>
      <div class="qn-label">Metronome</div>
      <div class="qn-sub">Tap tempo</div>
    </div>
    <div class="quick-nav-btn" onclick="goTo('riff',null)">
      <div class="qn-icon">🎸</div>
      <div class="qn-label">Riff Lab</div>
      <div class="qn-sub">Instant riff ideas</div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════ FUNDAMENTALS ═══════ -->
<div id="fundamentals" class="page">
  <div class="page-header">
    <div class="page-title">Fundamentals</div>
    <div class="page-lead">Core concepts for your 7-string Drop A setup. Each section has examples and tabs — work through them in order.</div>
  </div>

  <div class="collapse-group" id="fund-group"></div>
  <div class="sess-rec">
    <span class="sess-rec-text">📌 READY TO PRACTICE THESE FUNDAMENTALS?</span>
    <button class="sess-rec-btn" onclick="loadPreset('tech');goTo('session',null)">▶ START TECHNIQUE SESSION</button>
  </div>
</div>

<!-- ═══════════════════════════════════ SCALES ═══════ -->
<div id="scales" class="page">
  <div class="page-header">
    <div class="page-title">Scales</div>
    <div class="page-lead">The harmonic vocabulary of deathcore. Select a scale below to see its structure, fretboard position, and example licks.</div>
  </div>

  <div class="scale-pills" id="scale-pills"></div>

  <div class="section-refresh-bar">
    <span class="section-refresh-label">Scale Exercise Generator</span>
    <button class="btn" id="scale-ref-btn" onclick="refreshScaleExercise()" style="display:flex;align-items:center;gap:6px;padding:7px 16px;font-size:10px">
      <span class="r-icon" id="scale-ref-icon">↻</span> New Exercise for Selected Scale
    </button>
  </div>
  <div id="scale-ai-panel" style="display:none" class="section-ai-output">
    <div class="section-ai-header">
      <span class="section-ai-label">AI Scale Exercise</span>
      <button class="ai-exercise-dismiss" onclick="document.getElementById('scale-ai-panel').style.display='none'">×</button>
    </div>
    <div class="section-ai-body"></div>
  </div>

  <div class="fret-wrap" id="fret-wrap">
    <svg id="fretboard-svg" viewBox="0 0 720 230" xmlns="http://www.w3.org/2000/svg"></svg>
  </div>

  <div class="collapse-group" id="scales-group"></div>
  <div class="sess-rec" style="margin-top:20px">
    <span class="sess-rec-text">🎵 LOCK IN THESE SCALES WITH A PRACTICE SESSION</span>
    <button class="sess-rec-btn" onclick="loadPreset('deep');goTo('session',null)">▶ START DEEP WORK SESSION</button>
  </div>
</div>

<!-- ═══════════════════════════════════ ARPEGGIOS ═══════ -->
<div id="arpeggios" class="page">
  <div class="page-header">
    <div class="page-title">Arpeggios</div>
    <div class="page-lead">Broken chord shapes for melodic deathcore leads. Build clean picking before attempting sweeps.</div>
  </div>
  <div class="collapse-group" id="arp-group"></div>
</div>

<!-- ═══════════════════════════════════ TECHNIQUES ═══════ -->
<div id="techniques" class="page">
  <div class="page-header">
    <div class="page-title">Techniques</div>
    <div class="page-lead">Every critical technique for heavy guitar. Each section includes explanation, tab exercises, and difficulty guidance.</div>
  </div>
  <div class="collapse-group" id="tech-group"></div>
  <div class="sess-rec" style="margin-top:20px">
    <span class="sess-rec-text">⚡ DRILL THESE TECHNIQUES IN A TIMED SESSION</span>
    <button class="sess-rec-btn" onclick="loadPreset('tech');goTo('session',null)">▶ START TECHNIQUE SESSION</button>
  </div>
</div>

<!-- ═══════════════════════════════════ SESSION ═══════ -->
<div id="session" class="page">
  <div class="page-header">
    <div class="page-title">Practice Session</div>
    <div class="page-lead">Build your session, then run the timer. Each block counts down. Minutes are logged to your home stats.</div>
  </div>

  <div class="big-timer">
    <div class="big-timer-val" id="sess-timer-val">--:--</div>
    <div class="big-timer-label" id="sess-timer-label">Load a preset below to begin</div>
  </div>

  <div class="sess-start-wrap">
    <button class="sess-big-btn" id="sess-start-btn" onclick="toggleSession()">
      <span id="sess-btn-label">▶ START SESSION</span>
    </button>
    <div class="sess-controls-row">
      <button class="btn" onclick="resetSession()">Reset</button>
      <button class="btn" id="log-manual-btn" onclick="openLogTimeModal()" style="background:var(--ember);color:#fff;border-color:var(--ember)">+ Log Time</button>
      <button class="btn" onclick="skipBlock()">Skip →</button>
      <button class="btn" id="sess-metro-btn" onclick="toggleMetroFromSession()" style="font-size:11px">♩ Metro</button>
    </div>
  </div>

  <h3>Session Blocks</h3>
  <div id="active-plan-name" style="font-size:11px;color:var(--dim);margin:-8px 0 10px;font-style:italic"></div>
  <div id="session-blocks"></div>
  <div class="session-total" id="session-total"></div>

  <h3 style="margin-top:28px">Presets</h3>
  <div class="cards-grid">
    <div class="card red" style="cursor:pointer" onclick="loadPreset('quick')">
      <div class="card-title">Quick Fire — 20 min</div>
      <div class="card-body">Warmup → Scales → Song Work. Efficient daily minimum.</div>
    </div>
    <div class="card gold" style="cursor:pointer" onclick="loadPreset('deep')">
      <div class="card-title">Deep Work — 45 min</div>
      <div class="card-body">Full structured session covering all areas.</div>
    </div>
    <div class="card hot" style="cursor:pointer" onclick="loadPreset('tech')">
      <div class="card-title">Technique Focus — 30 min</div>
      <div class="card-body">Heavy emphasis on specific technique drills.</div>
    </div>
  </div>

  <div class="section-refresh-bar" style="margin-top:20px">
    <span class="section-refresh-label">AI Session Planner</span>
    <button class="btn" id="sess-ref-btn" onclick="refreshSessionPlan()" style="display:flex;align-items:center;gap:6px;padding:7px 16px;font-size:10px">
      <span class="r-icon" id="sess-ref-icon">↻</span> Generate Custom Session
    </button>
  </div>
  <div id="session-ai-panel" style="display:none" class="section-ai-output">
    <div class="section-ai-header">
      <span class="section-ai-label">AI Custom Session Plan</span>
      <button class="ai-exercise-dismiss" onclick="document.getElementById('session-ai-panel').style.display='none'">×</button>
    </div>
    <div class="section-ai-body"></div>
  </div>
</div>

<!-- ═══════════════════════════════════ METRONOME ═══════ -->
<div id="metronome" class="page">
  <div class="page-header">
    <div class="page-title">Metronome</div>
    <div class="page-lead">Time is everything. If you can't play it clean at 60, you can't play it clean at 160.</div>
  </div>

  <div class="metro-shell">
    <div class="metro-display">
      <div class="metro-bpm" id="bpm-display" title="Click +/- to change">80</div>
      <div class="metro-bpm-unit">BPM &nbsp;·&nbsp; <span id="ts-label">4/4</span></div>
      <div class="beat-row" id="beat-row"></div>
    </div>
    <div class="metro-controls">
      <div class="metro-row">
        <button class="btn" onclick="changeBPM(-10)">−10</button>
        <button class="btn" onclick="changeBPM(-5)">−5</button>
        <button class="btn" onclick="changeBPM(-1)">−1</button>
        <input type="range" class="metro-slider" id="bpm-slider" min="40" max="240" value="80" oninput="updateBPM(this.value)">
        <button class="btn" onclick="changeBPM(1)">+1</button>
        <button class="btn" onclick="changeBPM(5)">+5</button>
        <button class="btn" onclick="changeBPM(10)">+10</button>
      </div>
      <div class="metro-row">
        <button class="btn primary" id="metro-btn" onclick="toggleMetro()">Start</button>
        <button class="btn" id="tap-btn" onclick="tapTempo()">Tap Tempo</button>
      </div>
      <div class="metro-row">
        <span style="font-family:var(--mono);font-size:10px;color:var(--dim);letter-spacing:2px">TIME SIG:</span>
        <button class="btn" onclick="setTS(4)">4/4</button>
        <button class="btn" onclick="setTS(3)">3/4</button>
        <button class="btn" onclick="setTS(6)">6/8</button>
        <button class="btn" onclick="setTS(5)">5/4</button>
        <button class="btn" onclick="setTS(7)">7/8</button>
      </div>
    </div>
  </div>

  <h3 style="margin-top:28px">BPM Reference</h3>
  <div class="cards-grid">
    <div class="card red"><div class="card-title">Slow Work</div><div class="card-body">40–70 BPM — arpeggios, new techniques, isolating hard passages</div></div>
    <div class="card"><div class="card-title">Moderate</div><div class="card-body">70–110 BPM — scale runs, rhythm practice, gallop patterns</div></div>
    <div class="card gold"><div class="card-title">Performance</div><div class="card-body">140–200 BPM — deathcore tempos, full song speed</div></div>
  </div>

  <div class="info-box" style="margin-top:20px">
    <strong>The Ratchet Method:</strong> Start at a tempo where 30s is flawless. Increase by 5 BPM only when you hit that threshold. Never rush — you're programming muscle memory that lasts years.
  </div>

  <!-- BPM RAMP MODE -->
  <h3 style="margin-top:28px">BPM Ramp Trainer</h3>
  <div class="ramp-panel">
    <div style="font-size:12px;color:var(--mid);margin-bottom:14px">Auto-increments BPM on a timer. Set your range and interval, start the metronome, then just play — the click gets faster automatically.</div>
    <div class="ramp-row">
      <span class="ramp-label">START</span>
      <button class="btn" onclick="rampAdj('start',-5)">−5</button>
      <div class="ramp-num" id="ramp-start-val">60</div>
      <button class="btn" onclick="rampAdj('start',5)">+5</button>
      <span class="ramp-label" style="margin-left:10px">END</span>
      <button class="btn" onclick="rampAdj('end',-5)">−5</button>
      <div class="ramp-num" id="ramp-end-val">120</div>
      <button class="btn" onclick="rampAdj('end',5)">+5</button>
    </div>
    <div class="ramp-row">
      <span class="ramp-label">STEP</span>
      <button class="btn" onclick="rampAdj('step',-1)">−1</button>
      <div class="ramp-num" id="ramp-step-val">5</div>
      <button class="btn" onclick="rampAdj('step',1)">+1</button>
      <span class="ramp-label" style="margin-left:10px">EVERY</span>
      <button class="btn" onclick="rampAdj('interval',-15)">−</button>
      <div class="ramp-num" id="ramp-interval-val">30</div>
      <button class="btn" onclick="rampAdj('interval',15)">+</button>
      <span style="font-size:11px;color:var(--dim)">sec</span>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" id="ramp-start-btn" onclick="toggleRamp()">▶ Start Ramp</button>
      <button class="btn" onclick="resetRamp()">Reset</button>
    </div>
    <div class="ramp-status" id="ramp-status"></div>
  </div>

  <div class="section-refresh-bar" style="margin-top:20px">
    <span class="section-refresh-label">Rhythm Drill at Current BPM</span>
    <button class="btn" id="metro-ref-btn" onclick="refreshMetronome()" style="display:flex;align-items:center;gap:6px;padding:7px 16px;font-size:10px">
      <span class="r-icon" id="metro-ref-icon">↻</span> Generate Drill
    </button>
  </div>
  <div id="metro-ai-panel" style="display:none" class="section-ai-output">
    <div class="section-ai-header">
      <span class="section-ai-label">AI Rhythm Drill</span>
      <button class="ai-exercise-dismiss" onclick="document.getElementById('metro-ai-panel').style.display='none'">×</button>
    </div>
    <div class="section-ai-body"></div>
  </div>
</div>

<!-- ═══════════════════════════════════ DAILY TIP ═══════ -->
<div id="dailytip" class="page">
  <div class="page-header">
    <div class="page-title">Daily Tip</div>
    <div class="page-lead">AI-generated practice wisdom targeted to your 7-string Drop A deathcore setup. Filter by category.</div>
  </div>

  <div class="tip-filter-row" id="tip-filters">
    <div class="tip-filter-tag active" data-cat="any" onclick="setTipCat(this)">Any</div>
    <div class="tip-filter-tag" data-cat="technique" onclick="setTipCat(this)">Technique</div>
    <div class="tip-filter-tag" data-cat="rhythm" onclick="setTipCat(this)">Rhythm</div>
    <div class="tip-filter-tag" data-cat="scales" onclick="setTipCat(this)">Scales</div>
    <div class="tip-filter-tag" data-cat="arpeggios" onclick="setTipCat(this)">Arpeggios</div>
    <div class="tip-filter-tag" data-cat="mindset" onclick="setTipCat(this)">Mindset</div>
    <div class="tip-filter-tag" data-cat="theory" onclick="setTipCat(this)">Theory</div>
    <div class="tip-filter-tag" data-cat="gear" onclick="setTipCat(this)">Gear & Tone</div>
  </div>

  <div class="tip-card">
    <div class="tip-card-header">
      <div class="tip-orb" id="tip-orb">✦</div>
      <div>
        <div class="tip-meta-label">Today's Transmission</div>
        <div class="tip-meta-cat" id="tip-cat-label">Awaiting signal...</div>
      </div>
    </div>
    <div class="tip-body-text" id="tip-main-text">
      <div class="tip-quote">"</div>
      <div id="tip-inner">Hit "New Tip" to receive today's transmission.</div>
    </div>
    <div class="tip-footer">
      <div class="tip-count">Received: <span id="tip-count">0</span></div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="btn" id="regen-btn" onclick="fetchTip()"><span id="regen-icon">↻</span>&nbsp; New Tip</button>
        <button class="add-to-sess-btn" id="tip-add-btn" onclick="addTipToSession(this)" style="margin-top:0">+ Add to Session</button>
      </div>
    </div>
  </div>

  <div id="tip-history-wrap" style="display:none">
    <div class="tip-history-wrap">
      <div class="tip-history-head">// Recent Tips</div>
      <div id="tip-hist-list"></div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════ NOTEPAD ═══════ -->
<div id="notepad" class="page">
  <div class="page-header">
    <div class="page-title">Notepad</div>
    <div class="page-lead">Your practice journal. Notes persist between sessions. Double-click a tab name to rename it.</div>
  </div>
  <div class="notepad-outer">
    <div class="note-tab-row" id="note-tab-row">
      <div class="note-add-btn" onclick="addTab()" title="New tab">＋</div>
    </div>
    <div class="note-editor">
      <div class="note-bar">
        <button class="note-btn" onclick="fmt('**','**')"><b>B</b></button>
        <button class="note-btn" onclick="fmt('_','_')"><i>I</i></button>
        <button class="note-btn" onclick="fmt('`','`')">`x`</button>
        <div class="note-bar-sep"></div>
        <button class="note-btn" onclick="ins('// ')">// comment</button>
        <button class="note-btn" onclick="ins('[ ] ')">☐ task</button>
        <button class="note-btn" onclick="ins('BPM: ')">BPM</button>
        <button class="note-btn" onclick="ins('GOAL: ')">Goal</button>
        <button class="note-btn" onclick="ins('★ ')">★ Note</button>
        <div class="note-char" id="note-chars">0 ch</div>
      </div>
      <textarea class="note-area" id="note-area" placeholder="Begin writing...&#10;&#10;// Use // for comments&#10;[ ] Use [ ] for tasks&#10;BPM: Log your BPM goals&#10;GOAL: Track your objectives&#10;★ Mark important notes" oninput="onNoteType()" onkeydown="noteKey(event)"></textarea>
      <div class="note-status">
        <div class="note-status-left">
          <div class="saved-dot" id="save-dot"></div>
          <span class="saved-text" id="save-txt">NOT SAVED</span>
          <span class="saved-text" id="note-words">0 words</span>
        </div>
        <div class="note-actions">
          <button class="btn" onclick="copyNote()">Copy</button>
          <button class="btn" onclick="exportNote()">Export .txt</button>
          <button class="btn danger" onclick="clearNote()">Clear</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════ PROGRESS ═══════ -->
<div id="progress" class="page">
  <div class="page-header">
    <div class="page-title">Progress</div>
    <div class="page-lead">Skills update automatically as you practice. Bars fill as you complete session blocks, visit sections, and log time. Tap any bar to manually adjust.</div>
  </div>

  <h3>Core Skills</h3>
  <div id="prog-skills"></div>

  <hr class="divider">
  <h3>6-Month Milestones</h3>
  <div id="milestones"></div>

  <hr class="divider">
  <h3>Achievements</h3>
  <div class="achieve-grid" id="achievements"></div>
</div>


<!-- ═══════════════════════════════════ RIFF LAB ═══════ -->
<div id="riff" class="page">
  <div class="page-header">
    <div class="page-title">Riff Lab</div>
    <div class="page-lead">Get instant riff ideas with tab, picking direction, and tips. Hit "New Riff" until something clicks — then practice it.</div>
  </div>

  <div class="tip-filter-row" style="margin-bottom:20px">
    <div class="riff-filter active tip-filter-tag" data-genre="any" onclick="setRiffGenre(this,'any')">Any Style</div>
    <div class="riff-filter tip-filter-tag" data-genre="breakdown" onclick="setRiffGenre(this,'breakdown')">Breakdown</div>
    <div class="riff-filter tip-filter-tag" data-genre="gallop" onclick="setRiffGenre(this,'gallop')">Gallop</div>
    <div class="riff-filter tip-filter-tag" data-genre="tremolo" onclick="setRiffGenre(this,'tremolo')">Tremolo</div>
    <div class="riff-filter tip-filter-tag" data-genre="riff" onclick="setRiffGenre(this,'riff')">Melodic Riff</div>
    <div class="riff-filter tip-filter-tag" data-genre="lick" onclick="setRiffGenre(this,'lick')">Lead Lick</div>
  </div>

  <div id="riff-display"></div>

  <div class="info-box" style="margin-top:24px">
    <strong>How to use this:</strong> Get a riff → set your metronome to the suggested BPM → play it slowly until clean → increase tempo 5 BPM at a time → tap "Practice This" to build a full session around it.
  </div>
</div>

<!-- ═══════════════════════════════════ ROADMAP ═══════ -->
<div id="roadmap" class="page">
  <div class="page-header">
    <div class="page-title">Beyond The Grimoire</div>
    <div class="page-lead">Your next-level learning map — curated outside resources, 6-month milestone tracker, and planned app features.</div>
  </div>

  <h3>6-Month Progress Milestones</h3>
  <div id="roadmap-milestones" style="margin-top:12px"></div>

  <h3 style="margin-top:28px">Outside Resources</h3>
  <div class="cards-grid" style="margin-top:12px">

    <div class="card gold">
      <div class="card-title">🎬 Theory — YouTube</div>
      <div class="card-body" style="font-size:13px;color:#c4b8a8">
        <div style="margin-bottom:8px"><strong style="color:var(--pale)">Adam Neely</strong> — Deep theory, accessible. Watch: "Why does metal sound evil"</div>
        <div style="margin-bottom:8px"><strong style="color:var(--pale)">Paul Davids</strong> — Picking mechanics and tone. Exceptional production.</div>
        <div><strong style="color:var(--pale)">Jens Larsen</strong> — Jazz-to-metal intervals and phrasing. Advanced ear training.</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">🎬 Technique — YouTube</div>
      <div class="card-body" style="font-size:13px;color:#c4b8a8">
        <div style="margin-bottom:8px"><strong style="color:var(--pale)">Ola Englund</strong> — 7-string extended range specialist. Gear and technique.</div>
        <div style="margin-bottom:8px"><strong style="color:var(--pale)">Rick Graham</strong> — Best sweep/legato tutorials on the internet. Mandatory viewing.</div>
        <div><strong style="color:var(--pale)">Marty Music</strong> — Song breakdowns including deathcore. Musical context focus.</div>
      </div>
    </div>

    <div class="card red">
      <div class="card-title">📱 Essential Apps</div>
      <div class="card-body" style="font-size:13px;color:#c4b8a8">
        <div style="margin-bottom:8px"><strong style="color:var(--pale)">GuitarTuna</strong> — Best free tuner for Drop A. 7-string presets built in.</div>
        <div style="margin-bottom:8px"><strong style="color:var(--pale)">Soundslice</strong> — Tab player with tempo control + looping. Learn songs slowly.</div>
        <div><strong style="color:var(--pale)">Transcribe!</strong> — Slow recordings without pitch shift. Essential for learning by ear.</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">📚 Books</div>
      <div class="card-body" style="font-size:13px;color:#c4b8a8">
        <div style="margin-bottom:8px"><strong style="color:var(--pale)">Guitar Grimoire — Scales</strong> — Complete scale reference. Every mode, every position.</div>
        <div style="margin-bottom:8px"><strong style="color:var(--pale)">The Advancing Guitarist</strong> — Mick Goodrick. The most honest practice book ever written.</div>
        <div><strong style="color:var(--pale)">Musicophilia — Oliver Sacks</strong> — Neuroscience of how musicians' brains work.</div>
      </div>
    </div>

    <div class="card gold">
      <div class="card-title">🌐 Tab & Theory Sites</div>
      <div class="card-body" style="font-size:13px;color:#c4b8a8">
        <div style="margin-bottom:8px"><strong style="color:var(--pale)">Ultimate Guitar</strong> — Best tab library. Filter: 7-string. Always verify vs recording.</div>
        <div style="margin-bottom:8px"><strong style="color:var(--pale)">Musictheory.net</strong> — Free theory. Use the exercises section daily.</div>
        <div><strong style="color:var(--pale)">Hooktheory</strong> — Chord progression database. Understand what metal progressions share.</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">🎸 Deathcore To Study</div>
      <div class="card-body" style="font-size:13px;color:#c4b8a8">
        <div style="margin-bottom:8px"><strong style="color:var(--pale)">Beginner: Fit For An Autopsy</strong> — "Heads Will Hang" — first full song goal.</div>
        <div style="margin-bottom:8px"><strong style="color:var(--pale)">Intermediate: Whitechapel</strong> — "This Is Exile" era. Drop A style, accessible riffs.</div>
        <div><strong style="color:var(--pale)">Advanced: Thy Art Is Murder</strong> — "Whore To A Chainsaw" for sweep practice.</div>
      </div>
    </div>

  </div>

  <h3 style="margin-top:28px">App Feature Roadmap</h3>
  <div class="info-box" style="margin-bottom:14px">Planned features — click any to jump to the related section.</div>
  <div id="roadmap-list"></div>

  <div class="section-refresh-bar" style="margin-top:16px">
    <span class="section-refresh-label">More Feature Ideas</span>
    <button class="btn" id="road-ref-btn" onclick="refreshRoadmap()" style="display:flex;align-items:center;gap:6px;padding:7px 16px;font-size:10px">
      <span class="r-icon" id="road-ref-icon">↻</span> Generate More Ideas
    </button>
  </div>
  <div id="roadmap-ai-panel" style="display:none" class="section-ai-output">
    <div class="section-ai-header">
      <span class="section-ai-label">AI Feature Suggestions</span>
      <button class="ai-exercise-dismiss" onclick="document.getElementById('roadmap-ai-panel').style.display='none'">×</button>
    </div>
    <div class="section-ai-body"></div>
  </div>
</div>


<!-- ═══════════════════════════════════ WEEKLY REVIEW ═══════ -->
<!-- ═══════════════════════════════════ THEORY ═══════ -->
<div id="theory" class="page">
  <div class="page-header">
    <div class="page-title">Music Theory</div>
    <div class="page-lead">Two tools: find which scales fit a chord, and train your ear to recognise intervals. Both essential for any serious metal player.</div>
  </div>

  <div class="theory-tabs">
    <div class="theory-tab active" onclick="switchTheoryTab('chord',this)">Chord → Scale Finder</div>
    <div class="theory-tab" onclick="switchTheoryTab('interval',this)">Interval Ear Trainer</div>
  </div>

  <!-- PANEL 1: Chord to Scale finder -->
  <div class="theory-panel active" id="theory-chord">
    <p class="prose" style="margin:16px 0 20px">Pick a chord root and quality — the tool shows which scales contain it and how well they match. Use this when writing riffs to know what scale to solo over.</p>

    <div class="theory-selectors">
      <div class="theory-select-wrap">
        <label class="theory-label">ROOT NOTE</label>
        <select class="theory-select" id="chord-root-sel">
          <option>A</option><option>A#/Bb</option><option>B</option><option>C</option>
          <option>C#/Db</option><option>D</option><option>D#/Eb</option><option>E</option>
          <option>F</option><option>F#/Gb</option><option>G</option><option>G#/Ab</option>
        </select>
      </div>
      <div class="theory-select-wrap">
        <label class="theory-label">CHORD QUALITY</label>
        <select class="theory-select" id="chord-quality-sel">
          <option value="5">Power (5th)</option>
          <option value="m">Minor (m)</option>
          <option value="maj">Major (M)</option>
          <option value="dim">Diminished (dim)</option>
          <option value="dim7">Diminished 7th</option>
          <option value="m7">Minor 7th</option>
          <option value="aug">Augmented</option>
        </select>
      </div>
      <button class="btn primary" onclick="findScales()" style="align-self:flex-end;margin-bottom:2px">Find Scales</button>
    </div>

    <div id="scale-results" style="margin-top:20px"></div>

    <div class="info-box" style="margin-top:20px">
      <strong>How to use this in Drop A:</strong> Play an open Am5 power chord (strings 7-6-5 open). This is an A5. Run the finder with Root=A, Quality=Power — every 100% match scale works as a solo or melody over that chord.
    </div>
  </div>

  <!-- PANEL 2: Interval Ear Trainer -->
  <div class="theory-panel" id="theory-interval">
    <p class="prose" style="margin:16px 0 20px">Two notes play in sequence. Identify the interval between them. This is how pros think about music — not as fret numbers, but as sounds with names. Start with the first 5, expand as you get them right.</p>

    <div class="interval-trainer-shell">
      <div class="interval-display">
        <div class="interval-scores">
          <div class="int-score-item"><span class="int-score-val" id="int-score">0</span><span class="int-score-lbl">CORRECT</span></div>
          <div class="int-score-item"><span class="int-score-val" id="int-total">0</span><span class="int-score-lbl">TOTAL</span></div>
          <div class="int-score-item"><span class="int-score-val" id="int-streak">0</span><span class="int-score-lbl">STREAK</span></div>
        </div>
        <div class="interval-reveal" id="int-name">—</div>
        <div class="interval-sub" id="int-semitones">Press Play to begin</div>
        <div class="interval-context" id="int-context"></div>
      </div>

      <div class="interval-controls">
        <button class="btn primary" onclick="playInterval(true)">▶  Play New Interval</button>
        <button class="btn" onclick="playInterval(false)">↻  Replay</button>
      </div>

      <div class="interval-options" id="int-options">
        <!-- built by JS -->
      </div>
    </div>

    <div class="info-box" style="margin-top:20px">
      <strong>Why this matters:</strong> Once you can hear a tritone, you'll recognise it in every Slipknot and Meshuggah riff. Minor 3rds give you the minor chord feel. Perfect 5ths are power chords. This is the bridge between "knowing theory" and actually hearing it.
    </div>
  </div>
</div>

<div id="review" class="page">
  <div class="page-header">
    <div class="page-title">Weekly Review</div>
    <div class="page-lead">Your practice at a glance. Track progress over time, generate your shareable progress card, and get an AI coaching note for the week ahead.</div>
  </div>

  <div class="review-grid" id="review-stats"></div>

  <h3>Skill Progress Snapshot</h3>
  <div class="review-bar-section" id="review-bars"></div>

  <div class="section-refresh-bar" style="margin-top:8px">
    <span class="section-refresh-label">AI Weekly Coach</span>
    <button class="btn" id="review-ai-btn" onclick="refreshWeeklyCoach()" style="display:flex;align-items:center;gap:6px;padding:7px 16px;font-size:10px">
      <span class="r-icon" id="review-ai-icon">↻</span> Get This Week's Coaching Note
    </button>
  </div>
  <div id="review-ai-panel" style="display:none" class="section-ai-output">
    <div class="section-ai-header">
      <span class="section-ai-label">AI Weekly Coaching</span>
      <button class="ai-exercise-dismiss" onclick="document.getElementById('review-ai-panel').style.display='none'">×</button>
    </div>
    <div class="section-ai-body"></div>
  </div>

  <hr class="divider">
  <h3>Shareable Progress Card</h3>
  <p class="prose">Your stats as a card — copy the text below to share your progress with other players, or post it to r/guitarlessons.</p>
  <div class="card-preview" id="progress-card-preview"></div>
  <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
    <button class="btn primary" onclick="copyProgressCard()">Copy Progress Card Text</button>
    <button class="btn" onclick="buildProgressCard()">↻ Refresh Card</button>
  </div>
</div>

<footer>⟦ PLAY SLOW · PLAY CLEAN · THEN PLAY FAST ⟧</footer>

<script>/* ══════════════════════════════════════
   STORAGE FALLBACK (localStorage if no window.storage)
══════════════════════════════════════ */
if (!window.storage) {
  window.storage = {
    get: async (key) => {
      try {
        const v = localStorage.getItem('grimoire_' + key);
        return v !== null ? { key, value: v } : null;
      } catch(e) { return null; }
    },
    set: async (key, value) => {
      try {
        localStorage.setItem('grimoire_' + key, value);
        return { key, value };
      } catch(e) { return null; }
    },
    delete: async (key) => {
      try { localStorage.removeItem('grimoire_' + key); return { key, deleted: true }; }
      catch(e) { return null; }
    }
  };
}


/* ═══════════════════════════════════════
   NAVIGATION
═══════════════════════════════════════ */
function goTo(id, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (btn) btn.classList.add('active');
  window.scrollTo(0,0);
  onPageOpen(id);
}

function onPageOpen(id) {
  if (id === 'dailytip' && tipCount === 0) setTimeout(fetchTip, 200);
  if (id === 'notepad' && !noteInited) { noteInited = true; loadNotes(); }
  if (id === 'home') refreshHomeStats();
  if (id === 'review') { buildReview(); buildProgressCard(); }
  if (id === 'theory') { if (!intCurrent) initIntervalTrainer(); setTimeout(findScales, 50); }
  if (id === 'riff') { generateRiff(); }
  if (id === 'session') { renderBlocks(); updateTimerDisplay(); }
  if (id === 'progress') { buildProgress(); }
  trackPageVisit(id);
  updateContextBar(id);
}

/* ═══════════════════════════════════════
   COLLAPSE ENGINE
═══════════════════════════════════════ */
function buildCollapse(containerId, items) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  items.forEach((item, i) => {
    const itemId = containerId + '-item-' + i;
    const topicSafe = (item.title + (item.sub ? ' — ' + item.sub : '')).replace(/['"]/g, ' ');
    const div = document.createElement('div');
    div.className = 'collapse-item';
    div.id = itemId;
    div.innerHTML = `
      <div class="collapse-trigger" onclick="toggleCollapse('${itemId}')">
        <div class="collapse-icon">${item.icon}</div>
        <div class="collapse-title">
          <div class="collapse-title-main">${item.title}</div>
          ${item.sub ? `<div class="collapse-title-sub">${item.sub}</div>` : ''}
        </div>
        ${item.badge ? `<div class="collapse-badge ${item.badgeColor||''}">${item.badge}</div>` : ''}
        <button class="refresh-btn" id="rbtn-${itemId}" onclick="event.stopPropagation(); refreshSection('${itemId}')">
          <span class="r-icon" id="rico-${itemId}">↻</span> New Exercise
        </button>
        <div class="collapse-arrow">▼</div>
      </div>
      <div class="collapse-body">
        <div class="collapse-body-inner">
          ${item.content}
          <div id="ai-panel-${itemId}" style="display:none">
            <div class="ai-exercise-panel">
              <div class="ai-exercise-header">
                <span class="ai-exercise-label">AI-Generated Exercise</span>
                <button class="ai-exercise-dismiss" onclick="document.getElementById('ai-panel-${itemId}').style.display='none'">×</button>
              </div>
              <div class="ai-exercise-body" id="ai-body-${itemId}"></div>
            </div>
          </div>
        </div>
      </div>`;
    // Store topic on element for later use
    div.dataset.topic = topicSafe;
    container.appendChild(div);
  });
}

function toggleCollapse(id) {
  const item = document.getElementById(id);
  const body = item.querySelector('.collapse-body');
  const isOpen = item.classList.contains('open');
  if (isOpen) {
    body.classList.remove('open');
    body.style.maxHeight = body.scrollHeight + 'px';
    requestAnimationFrame(() => body.style.maxHeight = '0');
    item.classList.remove('open');
  } else {
    item.classList.add('open');
    body.style.maxHeight = body.scrollHeight + 'px';
    setTimeout(() => { body.style.maxHeight = 'none'; body.classList.add('open'); }, 400);
  }
}

/* ═══════════════════════════════════════
   UNIVERSAL AI REFRESH ENGINE
═══════════════════════════════════════ */
/* ══════════════════════════════════════════════════
   STATIC CONTENT BANKS  (replaces API calls)
══════════════════════════════════════════════════ */

// ── 60 DAILY TIPS ──────────────────────────────
const tipsBank = {
  technique: [
    "Set your metronome to 70 BPM and play strict alternate picking on string 7 (open A) for 60 seconds straight. Every down-stroke lands on the click — no deviation. This is the hardest minute in metal guitar, and it builds the foundation everything else rests on.",
    "Practice your palm mute pressure with a simple test: play a muted open A on string 7, then gradually release palm pressure until the note opens up fully. The exact contact point where you get that tight, percussive thud — memorise it. That's your metal sweet spot.",
    "Slow your sweep arpeggio down to 30 BPM and focus only on the fretting hand. Each finger must lift the instant it's picked — not when the next finger lands, but the instant. No note should ring into the next. At 30 BPM you have time to actually do this correctly.",
    "Pinch harmonics: the secret is thumb placement, not pick force. Hold your pick so barely 2mm protrudes, then catch the string with the fleshy side of your thumb immediately after the pick. Try frets 5, 7 and 12 on string 6 — those positions ring out most on A-tuned guitars.",
    "For bend accuracy, fret the note you're bending *to* first, memorise the pitch, then bend up from two frets lower to match it. This is how you build ear-to-hand coordination for accurate bends — not guessing by feel alone.",
    "Practice economy picking on scale runs: when you move to a higher string, use a downstroke; when moving to a lower string, use an upstroke. This eliminates the extra motion of crossing strings with opposing picks. Start at 80 BPM on the A natural minor scale.",
    "Vibrato exercise: fret string 2 at position 7, then oscillate the string exactly a quarter-tone sharp and flat in a steady rhythm. Use a metronome at 60 BPM and aim for two oscillations per beat. Most beginners only go sharp — train the downward pull equally.",
    "Two-hand sync test: play a scale run at a tempo where you're making exactly zero errors for 30 consecutive seconds. That BPM is your current ability ceiling. Don't go higher until that threshold is consistent — the ratchet method is the fastest path to real speed.",
  ],
  rhythm: [
    "Gallop drill at 100 BPM: play the forward gallop (D-DU) for 8 bars on open string 7, then the reverse gallop (DU-D) for 8 bars without stopping. The transition between the two is where timing collapses for most beginners — smooth that seam.",
    "Record yourself playing a 4-bar chug at 120 BPM, then listen back. Your brain corrects timing drift in real time while playing — the recording reveals the truth. Most beginners rush beats 2 and 3 and drag beat 4. Identify your pattern.",
    "Polyrhythm intro: play 3-against-4 at 80 BPM. Count four steady beats with your foot, then play three evenly-spaced notes within each group of four. This feels broken at first — that's normal. Deathcore uses this tension constantly in rhythmic accents.",
    "Palm mute accent exercise: play 15 muted notes then one open accent on beat 4, repeat. The dynamic contrast between the dense muted mass and the sudden open note is the core sound of the deathcore breakdown. Start at 90 BPM, push to 140.",
    "Practice your strumming in complete silence first — air guitar the right hand rhythm over your left hand chords. Lock the right hand into the groove before introducing pick-string contact. This isolates the rhythm from the physical effort of actually picking.",
    "16th note endurance: set the metronome to 100 BPM and alternate pick open string 7 in strict 16th notes for 2 full minutes. Count your errors — any uneven note counts as a miss. Track your personal record. This builds the stamina for long technical passages.",
    "Practice starting a riff on beat 2 instead of beat 1. Deathcore syncopation often pushes the accent off the downbeat — if you can only start phrases on beat 1, you'll always struggle with syncopated riffs. Discipline the entry point.",
    "Ghost note exercise: alternate between fully muted (x) and lightly muted palm strokes at 110 BPM in 16th notes. The percussive dead notes should have a distinct rhythmic identity — not dead silence, not tone. That middle ground is the deathcore ghost note.",
  ],
  scales: [
    "Learn the A natural minor scale in position 1 starting from string 7, fret 0: 0-2 on A, 0-2 on E, 0-2 on A, 0-2 on D, 0-2-3 on G, 0-1-3 on B, 0-1-3 on e. Play it up and down at 60 BPM until every position is automatic before increasing tempo.",
    "The Phrygian flat-2 in Drop A: on string 7 open (A) the bII chord is Bb, one fret up (fret 1). Practice moving from open A power chord to fret-1 power chord and back — this two-chord movement is the single most recognisable sound in deathcore.",
    "Harmonic minor exercise: play the A harmonic minor scale and pay attention to the augmented 2nd interval between the b6 (F, fret 8 on string 6) and the major 7th (G#, fret 10). That two-fret jump within a scale is the harmonic minor signature — let it ring.",
    "Diminished scale symmetry trick: the shape repeats every 3 frets. Learn it in one position on strings 7-5, then move the exact same shape up 3 frets, then 3 more. You've now covered the entire neck with one pattern — that's the power of a symmetrical scale.",
    "Minor pentatonic starting positions on Drop A: string 7 open = root. From there: frets 0-3 on strings 7 and 6, frets 0-2 on strings 5 and 4, frets 0-2 on strings 3 and 2, frets 0-3 on string 1. Five notes, massive range. Learn this box before anything else.",
    "Connect two scale positions by finding the note where they overlap. In A natural minor, position 1 ends on high e fret 3 (G). Position 2 starts with G on string 2 fret 3. That shared note is your bridge — practise arriving at it from position 1 and departing into position 2.",
    "Play a scale run, but every 4th note double-pick (pick it twice in quick succession). This builds the awareness of individual notes within a mechanical scale passage — deathcore leads use this to add rhythmic texture without changing the underlying pattern.",
    "Modes from the same parent scale: A Aeolian (natural minor), B Locrian, C Ionian, D Dorian, E Phrygian, F Lydian, G Mixolydian. In Drop A, Phrygian and Locrian are your best friends — both have that flat-2 darkness. Learn to shift between them over static A drones.",
  ],
  arpeggios: [
    "Am arpeggio strict alternate picking: frets 5-5-5-7-5-5 on strings 7-6-5-4-3-2 (open on string 1). No sweeping — force yourself to alternate pick every note at 60 BPM. This builds the control that makes sweep arpeggios sound clean when you eventually combine the techniques.",
    "Diminished 7 symmetry practice: the Adim7 arpeggio shape (A-C-Eb-F#) repeats identically every 3 frets. Play the 4-note ascending arpeggio starting at fret 5, then shift the identical shape up 3 frets to fret 8, then to fret 11. Same shape, three positions — memorise one, get three.",
    "Sweep arpeggio right hand: practice the picking motion without the guitar. Drag your pick hand slowly across 5 imaginary strings top to bottom (one continuous downward motion), then bottom to top. The pick should glide, not bounce — one stroke per direction, not multiple picks.",
    "Three-string sweep foundation: before attempting 5-string sweeps, nail the Am 3-string version. Strings 5-4-3 only: frets 0-2-2. Down sweep, pick it three times until the motion is smooth and each note is distinct. Add the 4th and 5th strings only after this is effortless at 80 BPM.",
    "Major vs minor arpeggio ear test: alternate between Am arpeggio (A-C-E) and A major arpeggio (A-C#-E). The only difference is one fret on the middle note — but the emotional difference is enormous. Play both back to back to train your ear to the brightness contrast.",
    "Arpeggio sequencing: instead of playing the arpeggio root-to-root, start on the 3rd or 5th. Am arpeggio starting on the C: fret 8 on string 5, then 7 on string 4, then 9 on string 3. Inverting arpeggios changes the melodic entry point and makes leads sound less mechanical.",
    "Tap arpeggio intro: play the 2-string Am arpeggio (5h7 on string 3, 5 on string 2), then add a tap at fret 12 on string 2 with your picking hand index finger. The tapping hand replaces a high position you couldn't physically reach — this is how 3-octave arpeggios are built.",
    "Sweep clean test: record yourself playing the Am 5-string sweep at your current 'performance' speed. If any two notes blur into each other or ring simultaneously — that's your actual ceiling. Back off 20 BPM, fix the blur, then rebuild. Blurry sweeps at speed are worse than slow clean ones.",
  ],
  mindset: [
    "The plateau is not a wall — it's a floor you haven't finished building yet. When practice feels like you're going nowhere, you're consolidating gains at the cellular level. Show up tomorrow anyway. Breakthroughs always follow periods of invisible progress.",
    "Record a 2-minute video of yourself playing your hardest riff tonight. Watch it tomorrow. You'll notice things — position, tension, timing — that your hands never report to your brain in the moment. Self-video is the coaching tool most intermediate players never use.",
    "Practice the thing you hate most first. If sweeps feel hopeless, open with sweeps. The exercises you avoid are always the ones defining your ceiling. 10 minutes of deliberate discomfort at the start of a session beats an hour of playing only what feels good.",
    "Set a BPM goal with a specific date. 'I want to palm mute gallops at 160 BPM by the end of next month.' Track your daily BPM ceiling. Watching a number move is more motivating than vague notions of 'getting better.' Specificity creates progress.",
    "Rest is practice. Your fingers and forearms adapt during recovery, not during playing. If your hand feels tight or fatigued, stopping for the day is the correct technical decision — not a failure. Players who ignore this signal are the ones who develop tendinitis.",
    "Find one deathcore song you love and commit to learning just the main riff — nothing else. A specific musical goal focuses every technical exercise you do. Suddenly palm muting at 140 BPM isn't an abstract drill; it's the thing you need for that Thy Art riff.",
    "Slow practice is not easy practice. Slow practice is the hardest practice — it removes momentum and forces your brain and hands to make conscious decisions about every single note. If slow practice feels easy, you're not practising slowly enough.",
    "Stop comparing your month 3 to someone else's year 5. Every player you admire sucked for at least two years before they sounded like themselves. Your only competition is the version of you who picked up the guitar yesterday.",
  ],
  theory: [
    "Power chords in Drop A: a 5th chord is just two fingers — index on string 7 (root), ring on string 6 (same fret). Because string 7 is already tuned to A, an open power chord is Am5. Fret 5 on strings 7-6 is D5. Fret 7 is E5. You now know every root note for every power chord.",
    "The tritone (flat-5) is 6 semitones from the root — the exact midpoint of the octave. In A, the tritone is Eb. Fret 6 on string 7. It's called the Devil's Interval because it doesn't resolve — it hangs in pure tension. Every dissonant deathcore riff is built around this interval.",
    "Roman numeral analysis of your favourite riff: find the root note, then figure out what scale degree each chord is. If the root is A (i) and you're playing G (bVII) and F (bVI), you're playing a i-bVII-bVI movement. Label riffs this way and you'll start hearing harmonic patterns across every song.",
    "The augmented 2nd in harmonic minor: between the b6 and the major 7th there are 3 semitones instead of the usual 2. In A harmonic minor, that's F (fret 8 on string 6) to G# (fret 10). That one skipped semitone is the entire reason harmonic minor sounds cinematic and dramatic.",
    "Chord tones vs scale tones: when improvising over an Am chord, the notes A, C and E are chord tones — they always sound resolved. The other notes in A natural minor (B, D, F, G) are passing tones — they create tension that needs to resolve to a chord tone. Use chord tones on strong beats.",
    "Interval recognition shortcut: a perfect 5th is 7 semitones. A power chord IS a perfect 5th. You already hear perfect 5ths thousands of times per practice session — you just didn't have the name for it. Every other interval is measured relative to this one.",
    "Modes as emotional states: Aeolian (natural minor) = melancholy. Phrygian = menacing, aggressive. Locrian = pure instability and dread. Dorian = darker jazz, progressive metal. Mixolydian = triumphant. Learn one new mode per month by playing it over a static root drone for 10 minutes.",
    "Key signatures by sharps/flats: A natural minor has no sharps or flats (same key signature as C major). A harmonic minor adds G#. A Phrygian lowers the 2nd (Bb). Understanding these relationships explains why Phrygian feels like a darker version of the same base material.",
  ],
  gear: [
    "String gauge for Drop A 7-string: the 7th string needs minimum .070, ideally .074 or .080 for proper tension at A. Anything lighter will be floppy and hard to control for palm muting. The top 6 strings: .010-.052 or .011-.056 works well and keeps the higher strings easy to bend.",
    "EQ for deathcore rhythm tone: high-pass filter at 80Hz (removes sub rumble), slight scoop at 300-400Hz (removes mud), mid cut at 800Hz (removes boxiness), presence boost at 2-3kHz (adds bite and articulation), slight roll-off above 8kHz (tames harshness). This is the blueprint — adjust to taste from here.",
    "Pick weight for heavy rhythm: 1.5-2mm picks give you the mass needed to control palm muting and alternate picking at speed. Anything thinner flexes on attack and creates an inconsistent sound. Jazz III XL shape in 1.5mm is a very common choice for technical metal players.",
    "Amp settings starting point for Drop A: gain at 65-70% (not full — full gain creates mud), bass at 40% (boost it too much and string 7 becomes indistinct), mids at 55% (metal players cut mids live, but you need them for definition when practicing), treble at 65%, presence at 70%.",
    "The noise gate threshold: set it just above your guitar's idle hum. Too high and it chops off the beginning of your palm mutes (the gate closes between notes). Too low and it doesn't eliminate hum. The correct setting lets muted notes through but kills string noise between chords.",
    "Tuning stability on the low 7th string: always tune up to pitch from flat, never down from sharp. Strings stretch when tuned up and settle — tuning down leaves the string unstable and it will creep sharp. Lock tuners eliminate most of this issue but the principle still applies.",
    "Cab simulation vs real cab: for practice, a good IR (impulse response) through headphones sounds better than a real amp at bedroom volumes. The amp's character only emerges at loud volumes. For home practice, amp sim + IR is the genuinely superior option.",
    "The importance of a clean DI recording: plug in direct and record a dry signal alongside your processed tone. If the dry signal sounds good (clear attack, controlled dynamics, no dead notes), your technique is solid. If it sounds sloppy — the problem is your hands, not your tone.",
  ]
};

// ── EXERCISES BANK (per section topic) ──────────────
const exercisesBank = {
  'Drop A Tuning Reference — STRING LAYOUT · OPEN TUNING': [
    { title: 'Open String Recognition', bpm: 60, tab: 'A|-0-------0-------0-------0---|\nE|-0-------0-------0-------0---|\nA|-0-------0-------0-------0---|\nD|-0-------0-------0-------0---|\nG|-0-------0-------0-------0---|\nB|-0-------0-------0-------0---|\ne|-0-------0-------0-------0---|', instruction: 'Pick each open string one at a time. Name it aloud before you pick it. This builds the reflex of knowing where each string sits without looking. Go slow and be exact.', mistake: 'Skipping strings accidentally — keep eyes on the right hand until position is automatic.' },
    { title: 'String Pairs', bpm: 70, tab: 'A|-0-0-0-0-0-0-0-0-|\nE|-0-0-0-0-0-0-0-0-|', instruction: 'Alternate between string 7 and string 6 with downstrokes only. Focus on landing squarely on the target string. This is the first muting discipline — your palm covers everything below the two strings you\'re playing.', mistake: 'Letting strings above the pair ring out. Mute them with your fretting hand index finger laid flat.' },
  ],
  'Fretting Hand Posture — THUMB · CURVE · 1-2-3-4': [
    { title: '1-2-3-4 Chromatic Warmup', bpm: 60, tab: 'A|-5-6-7-8-5-6-7-8-5-6-7-8-5-6-7-8-|\nE|-5-6-7-8-5-6-7-8-5-6-7-8-5-6-7-8-|\nA|-5-6-7-8-5-6-7-8-5-6-7-8-5-6-7-8-|', instruction: 'One finger per fret. Index = fret 5, middle = 6, ring = 7, pinky = 8. Alternate pick every note, keep all unused fingers hovering just above the fretboard — not splayed out. Each note should ring for its full value before the next lands.', mistake: 'Fingers flying up high when not in use. Train them to hover 3-5mm above the strings.' },
    { title: 'Spider Walk', bpm: 50, tab: 'e|-5-6-5-6---------|\nB|---------5-6-5-6-|\nG|-5-6-5-6---------|\nD|---------5-6-5-6-|\nA|-5-6-5-6---------|\nE|---------5-6-5-6-|\nA|-5-6-5-6---------|', instruction: 'Pairs of fingers (1-2, then 2-3, then 3-4) crossing adjacent strings. Keep the hand in one position — only the fingers move. This is a coordination builder, not a speed exercise. Feel is more important than tempo.', mistake: 'Letting the thumb creep over the top of the neck. Thumb belongs behind the middle finger, on the back of the neck.' },
  ],
  'Palm Muting & The Chug — THE DEATHCORE HEARTBEAT': [
    { title: 'The Foundational Chug', bpm: 80, tab: 'A|-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-|', instruction: 'All notes palm muted, strict alternate picking. Every single note must sound identical — same volume, same length, same tone. This is the hardest simple exercise in metal. If any note sounds different from the others, you\'re not there yet.', mistake: 'Palm pressure changing between down and up strokes. Keep the palm absolutely still on the bridge while the wrist drives the pick.' },
    { title: 'Chug Accent Pattern', bpm: 90, tab: 'A|-0-0-0-0-0-0-0-0-0-0-0-0-2-2-2-2-|\n  (PM)(PM)(PM)(PM)(PM)(PM)(PM)(PM)(PM)(PM)(PM)(PM)open open open', instruction: 'Play 12 muted notes then shift to fret 2 (B5 power chord) for the last four — still muted. The movement while maintaining consistent palm pressure is the core of playing chord transitions in a breakdown context.', mistake: 'Lifting the palm to change chord. The palm stays, the fingers and wrist adjust around it.' },
  ],
  'Gallop & Rhythm Patterns — FORWARD & REVERSE GALLOP': [
    { title: 'Forward Gallop Isolation', bpm: 100, tab: 'A|-0-00-0-00-0-00-0-00-|\n   D-DU-D-DU-D-DU-D-DU', instruction: 'D-DU repeated. The two rapid notes are 16th notes, the single note is an 8th. Count: ONE-and-uh TWO-and-uh. The metronome click lands on the first D of each group. Start at 80 and only increase when the DU feels effortless.', mistake: 'Rushing the "and-uh" — the up-strokes feel faster than they should and scramble the triplet feel. Record yourself to catch this.' },
    { title: 'Reverse Gallop', bpm: 95, tab: 'A|-00-0-00-0-00-0-00-0-|\n   DU-D-DU-D-DU-D-DU-D', instruction: 'DU-D repeated. This one leads with the double. The accent falls on the single downstroke at the end of each group — that\'s the rhythmic emphasis in most heavy verse riffs. Practice separately from the forward gallop before trying to switch between them.', mistake: 'Treating the DU as one stroke instead of two distinct picks. Slow to 60 BPM and hear each pick separately.' },
  ],
  'Hammer-ons & Pull-offs — LEGATO TECHNIQUE': [
    { title: 'Basic Hammer-on Chain', bpm: 70, tab: 'A|-5h7h8-5h7h8-5h7h8-5h7h8-|', instruction: 'Pick only the first note. Every subsequent note is fretted sharply enough to sound without being picked. The hammer must strike the string with the fingertip — not the pad — and with enough force to produce clear tone equal to the picked note.', mistake: 'Hammering with the finger pad instead of the tip. The tip creates a precise point of contact and full tone; the pad creates a muffled thud.' },
    { title: 'Pull-off Descend', bpm: 65, tab: 'A|-8p7p5-8p7p5-8p7p5-8p7p5-|', instruction: 'Fret all three notes simultaneously before pulling off the highest. A pull-off is a controlled pluck with the fretting finger — pull the string sideways as you release it. Have the lower fingers already planted before the pull begins.', mistake: 'Releasing the string straight up instead of pulling sideways. An upward release produces no tone; a sideways pull produces a clear note.' },
  ],
  'Natural Minor — A · C · D · E · F · G · A': [
    { title: 'Position 1 Up and Down', bpm: 65, tab: 'e|-----------------------------------------0-1-3-|\nB|------------------------------------0-1-3-------|\nG|---------------------------0-2-3---------------|\nD|-------------------0-2-3-----------------------|\nA|-----------0-2-3-------------------------------|\nE|---0-2-3--------------------------------------- |\nA|-0-2-------------------------------------------|\n// Return: reverse', instruction: 'One note per beat at 65 BPM. No rushing. Lock every note to the click. This position covers all 7 strings — the bottom A string is your low root, the top e string ends on G, the b6. Memorise the shape, not just the mechanics.', mistake: 'Speeding up in the familiar middle strings and dragging on the awkward string crossings. The tempo must be perfectly even.' },
    { title: 'Scale in Thirds', bpm: 60, tab: 'e|--1-0-3-1-3-1---|\nB|-3-1-3-1-0-3----|\nG|-0-2-0-2-3-2---|\nD|-0-2-0-2-3-0--|', instruction: 'Play every other scale tone — A then C, B then D, C then E. These are thirds and they sound melodic and musical immediately. This is how real leads are constructed, not just scale runs. 60 BPM, feel the intervals.', mistake: 'Losing your place in the scale when skipping degrees. Keep counting positions in your head until the pattern is visual on the fretboard.' },
  ],
  'Phrygian — bII · FLAT 2ND · SPANISH FLAVOUR': [
    { title: 'The Phrygian Two-Chord Riff', bpm: 100, tab: 'A|-0-0-0-0-1-1-0-0-0-0-1-1-0-0-0-0-|\nE|-0-0-0-0-1-1-0-0-0-0-1-1-0-0-0-0-|\nA|-0-0-0-0-1-1-0-0-0-0-1-1-0-0-0-0-|\n  Am power  Bb5 power', instruction: 'Open Am5 to Bb5 (all strings 7-5-4 fret 1) and back. This is the purest expression of Phrygian in Drop A — the bII chord one semitone above the root. Palm mute throughout. Feel the menace in that half-step movement.', mistake: 'Letting the open chord ring into the Bb chord. Keep the palm mute consistent and the chord changes clean.' },
    { title: 'Phrygian Scale Run Descending', bpm: 70, tab: 'e|-1-0-------|\nB|-----3-1-0-|\nG|-----------|\nD|-----------|\nA|-----------|\nE|-----------|\nA|-----------|\n// Play the scale descending from e string', instruction: 'The flat 2nd (Bb, fret 1 on the e string) is the signature note. Let it sustain slightly before moving to A — that half-step resolution is the harmonic identity of Phrygian. Descend the entire scale slowly, emphasising that bII each time.', mistake: 'Rushing over the bII note. That note deserves emphasis — it is the scale.' },
  ],
  'Harmonic Minor — ROOT · 2 · b3 · 4 · 5 · b6 · 7': [
    { title: 'Augmented 2nd Focus', bpm: 60, tab: 'A|-5-7-8-10-12-|\nE|-5-7-8-10-  |\n// A harmonic minor, focus on frets 8 to 10', instruction: 'The gap between fret 8 (F, the b6) and fret 10 (G#, the major 7) is 3 semitones — the augmented 2nd. Play slowly up to that gap, pause, then complete it. Hear the jump. That awkward stretch is why harmonic minor sounds so cinematic.', mistake: 'Treating the augmented 2nd as just another scale step. Emphasise it — land on the G# with intention.' },
    { title: 'Harmonic Minor vs Natural Minor Comparison', bpm: 55, tab: 'A|-5-7-8-10-12-13-12-|\n// Natural minor (G natural)\nA|-5-7-8-10-12-12-12-|\n// Harmonic minor (G#)', instruction: 'Play A natural minor up to the 7th degree (G), then play A harmonic minor up to the raised 7th (G#). One fret difference — enormous emotional contrast. The raised 7 wants to resolve up to A; the natural 7 just sits there. This is music theory you can actually hear.', mistake: 'Not pausing to listen to the difference. Stop after each version and let the emotional quality of the 7th register.' },
  ],
  'Introduction to Sweep Picking — ONE DIRECTIONAL MOTION': [
    { title: '3-String Sweep Foundation', bpm: 40, tab: 'G|-2-|\nD|-2-|\nA|-0-|\n// Down-sweep only first. Then up only. Then combine.', instruction: 'Three strings only: A (open), D (fret 2), G (fret 2). Drag the pick down in one slow, smooth stroke — one note per string, not three rapid picks. Every finger lifts immediately after its string is picked. At 40 BPM you have time to be conscious about every lift.', mistake: 'Picking each string individually instead of one sweep motion. If you hear three distinct picks, you\'re not sweeping.' },
    { title: 'Sweep Turn Practice', bpm: 35, tab: 'e|-0-|\nB|-1-|\nG|-2-|\n// Top of 5-string Am: turn here', instruction: 'The hardest part of a sweep is the turnaround at the top — where down-sweep becomes up-sweep. Isolate just these top 3 strings: G (fret 2), B (fret 1), e (open). Down then immediately up. The e string is struck twice: once going down, once returning. Practice the turn 50 times.', mistake: 'Pausing at the turnaround. The motion must be continuous — down stroke meets e string and instantly reverses.' },
  ],
};

// ── SESSION PLANS ──────────────────────────────────
const sessionPlans = [
  { name: 'Chug Obsession Session', summary: 'Heavy focus on palm-muted rhythm, gallop patterns, and muting control. Best for days when you want to feel the groove.', blocks: [
    {label:'Warmup — 1-2-3-4 chromatic at 60 BPM, all 7 strings', mins:5, color:'#c8883a', bpm:60, skill:'Chromatic/Warmup', detail:'Start on fret 1, string 7. Place one finger per fret — index on 1, middle on 2, ring on 3, pinky on 4. Pick each note cleanly. Move to string 6, repeat. Work all 7 strings. This warms the tendons and establishes your pick-attack consistency before any heavy technique.'},
    {label:'Palm mute endurance — 60s on, 30s rest × 4 sets at 100 BPM', mins:10, color:'#7720cc', bpm:100, skill:'Palm Muting', detail:'Place the heel of your pick hand lightly on the bridge saddles — just enough contact to dampen the string. Alternate pick string 7 in 16th notes for 60 seconds. Rest 30s. Repeat 4 times. Goal: identical tone in rep 4 as rep 1. Palm pressure should be feather-light — if it\'s muffled, you\'re pressing too hard.'},
    {label:'Gallop patterns — forward + reverse, 90→120 BPM ratchet', mins:12, color:'#5a10a0', bpm:90, skill:'Gallop Rhythm', detail:'Forward gallop: D-DU per beat. Reverse: DU-D per beat. Run each for 8 bars at 90 BPM. When clean: move to 95. Then 100. Max 120. The ratchet method — 30s perfect before adding 5 BPM. Never rush. The DU pair should feel like one fast motion, not two separate picks.'},
    {label:'Power chord transitions while muting — Am→G5→F5→G5 at 100 BPM', mins:8, color:'#3d0870', bpm:100, skill:'Palm Muting', detail:'Fret Am5 (strings 7-5-4 open or at nut position). Move to G5 (fret 3), F5 (fret 1), G5 (fret 3). Keep palm mute constant through all changes. The mute should never lift during the transition — your pick hand should be an anchor while your fret hand moves independently.'},
    {label:'Cool down — slow A natural minor scale, 50 BPM', mins:5, color:'#5a5248', bpm:50, skill:'Natural Minor', detail:'A natural minor scale ascending (A B C D E F G A) and descending on strings 7-5-4. Use strict alternate picking. This is your cooldown — focus on clean fretting and relaxed pick attack. Never end a session with intensity. Give your hands 5 minutes of easy movement to prevent tension buildup.'}
  ]},
  { name: 'Scale Fluency Session', summary: 'Build genuine fretboard knowledge — not just patterns but sounds. A Phrygian comparison will change how you hear deathcore.', blocks: [
    {label:'Warmup — open string names, no picking, just fretting positions', mins:5, color:'#c8883a', bpm:60, skill:'Chromatic/Warmup', detail:'Name each open string aloud before fretting: A A E A D G B E (7→1). Then fret each string at positions 1, 3, 5, 7, 9, 12 and name the notes. No picking — this is purely about your fretting hand and note knowledge. If you can\'t name a note, it\'s a gap to fill.'},
    {label:'A natural minor position 1 — up and down, 60→90 BPM', mins:10, color:'#4a7a9a', bpm:65, skill:'Natural Minor', detail:'Position 1: strings 7-1, starting at fret 5. Pattern: 5-7, 5-7, 5-6, 5-7, 5-7, 4-5-7, 5-6-8, 5-7-8. Memorise the shape not the numbers — the visual pattern is more reliable. Run ascending then descending. Start at 60, increase 5 BPM only when 30s is perfectly clean.'},
    {label:'A Phrygian comparison — same pattern, spot the flat 2nd', mins:8, color:'#5a10a0', bpm:70, skill:'Phrygian', detail:'Phrygian is natural minor with a lowered 2nd (Bb instead of B). In your scale pattern, this means one note changes — the second note becomes one fret lower. Play the scale and listen for that note. It creates a distinctive Middle-Eastern/sinister flavour. This single note change is the sound of deathcore.'},
    {label:'Scale in thirds — melodic phrasing exercise', mins:7, color:'#7720cc', bpm:65, skill:'Natural Minor', detail:'Instead of playing 1-2-3-4-5-6-7, play 1-3, 2-4, 3-5, 4-6, 5-7, 6-1, 7-2. Every pair is a third interval. These sound musical and are the foundation of actual melody. Go slow — this is harder than running the scale straight.'},
    {label:'Free improvisation over A drone — apply everything learned', mins:10, color:'#c8883a', bpm:80, skill:'Natural Minor', detail:'Play a sustained open A on string 7 (or have a friend hold it). Improvise freely using the natural minor scale in any position. No structure required — just play what sounds right. This is the bridge between \'knowing the scale\' and actually using it musically. Any note in A minor will work. Trust it.'}
  ]},
  { name: 'Technique Isolation Session', summary: 'Hammer-ons and pull-offs are your escape from picking fatigue. This session builds the legato foundation every deathcore player needs.', blocks: [
    {label:'Warmup — finger independence spiders at 50 BPM', mins:5, color:'#c8883a', bpm:50, skill:'Chromatic/Warmup', detail:'Chromatic spider exercise: 1-2-3-4 across all strings, then 1-3-2-4, then 4-3-2-1. These permutations force each finger to act independently. At 50 BPM this feels easy — that\'s correct. Warmup is not practice; warmup is preparation. Keep pressure light.'},
    {label:'Hammer-ons only — 5h7h8 chains at 60 BPM until tone is even', mins:8, color:'#3d0870', bpm:60, skill:'Hammer/Pull', detail:'Pick only the first note (fret 5). Then hammer fret 7 with your ring finger — strike the string firmly from directly above. Then hammer fret 8 with your pinky. The second and third notes should be 80-90% the volume of the picked note. If they\'re quieter, you\'re not hammering hard enough or not landing directly on the fret.'},
    {label:'Pull-offs only — 8p7p5 chains, focusing on sideways pull', mins:8, color:'#5a10a0', bpm:60, skill:'Hammer/Pull', detail:'Fret all three notes simultaneously (5, 7, 8). Pick only the first. Pull off 8→7 by plucking the string sideways with your pinky as you release — not straight up. Then pull 7→5 the same way. The sideways motion is what creates volume. A straight release produces a dead note.'},
    {label:'Legato run combining both — 5h7p5h8p7h5 loop', mins:9, color:'#7720cc', bpm:65, skill:'Hammer/Pull', detail:'This run uses both techniques in sequence. The motion: pick 5, hammer 7, pull to 5, hammer 8, pull to 7, hammer 5. Loop it continuously without stopping. It should flow like one connected sound, not a series of discrete notes. Record yourself — any weak note will stand out immediately in the recording.'},
    {label:'Rest and listen — play back any recordings from session', mins:5, color:'#5a5248', bpm:60, skill:'Hammer/Pull', detail:'Mandatory rest. Shake out your fretting hand — not because it hurts, but because ending with relaxation locks in the session. If you recorded anything, play it back now. You will hear things your brain filtered out while playing. One specific note to improve becomes tomorrow\'s target.'}
  ]},
  { name: 'Sweep Arpeggio Foundation', summary: 'The most technical session in the guide. Sweeping takes months to clean up — start here and be patient.', blocks: [
    {label:'Warmup — finger posture check, thumb position', mins:5, color:'#c8883a', bpm:55, skill:'Chromatic/Warmup', detail:'Before any sweep practice: check your thumb position. It should sit roughly behind the middle finger, centered on the back of the neck — not gripping over the top. An incorrect thumb position makes sweeping nearly impossible because your hand can\'t rotate freely. Spend 5 minutes just placing fingers with correct thumb position, no speed required.'},
    {label:'3-string Am sweep down-only at 30 BPM — 10 perfect reps', mins:10, color:'#7720cc', bpm:30, skill:'Sweep Arpeggios', detail:'3-string Am arpeggio: G fret 2, D fret 2, A open (or same fret). One continuous downward pick stroke across all three — not three separate picks. The strings must NOT ring simultaneously. Your fretting fingers must lift the instant the string below is picked. The sound should be arpeggio (sequential), not chord (simultaneous). 30 BPM is correct. This is not slow practice — this is correct practice.'},
    {label:'3-string Am sweep up-only at 30 BPM — 10 perfect reps', mins:10, color:'#5a10a0', bpm:30, skill:'Sweep Arpeggios', detail:'Same shape, now ascending. One continuous upward pick stroke. A open → D fret 2 → G fret 2. Again: each finger must lift immediately after its string is picked. The up-sweep is usually harder because our wrist naturally resists the upward dragging motion. Slow is correct. 30 BPM. 10 perfect reps — not 10 reps.'},
    {label:'3-string combined down + up at 35 BPM', mins:10, color:'#3d0870', bpm:35, skill:'Sweep Arpeggios', detail:'Now combine: down-sweep all three strings, then immediately up-sweep back. The turnaround at the top string is the hardest part — your pick must reverse direction without pausing. The top note (G fret 2) is picked twice: once going down, once going up. This must not sound like a hesitation. Practice the turnaround alone 20 times before running the full thing.'},
    {label:'Dim7 arpeggio strict alternate picking — no sweeping yet', mins:5, color:'#5a5248', bpm:60, skill:'Sweep Arpeggios', detail:'Alternate pick the Adim7 arpeggio notes (A-C-Eb-F#) on individual strings — no sweeping. This locks in the notes themselves before you try to play them with sweep technique. If you don\'t know the notes, you can\'t sweep them cleanly. Alternate pick them slowly and clearly first.'}
  ]},
  { name: 'Rhythm Endurance Session', summary: 'Pure stamina building. Your right hand will be exhausted. That\'s the point — performance tempo requires performance conditioning.', blocks: [
    {label:'Warmup — alternate picking open string 7 at 80 BPM for 60s', mins:5, color:'#c8883a', bpm:80, skill:'Alternate Pick', detail:'One minute. Open string 7. Strict down-up-down-up in 16th notes. No variance in pick depth, no variance in palm mute pressure. This is your calibration point. Note how your forearm feels at the end of 60 seconds — that\'s your baseline. It should feel warm, not tired. If it feels tired, 80 BPM is already a training tempo for you.'},
    {label:'16th note endurance — 2-minute run at 100 BPM, count errors', mins:10, color:'#7720cc', bpm:100, skill:'Alternate Pick', detail:'Set a 2-minute timer. 16th note alternate picking, string 7, 100 BPM. Count every error: uneven note, pick direction reversal, change in tone, any break. Your score is the error count. Record it. Come back next week and try to beat it. This is the most honest performance metric available to you — it cannot be faked.'},
    {label:'Gallop → palm mute → gallop transitions at 110 BPM', mins:10, color:'#5a10a0', bpm:110, skill:'Gallop Rhythm', detail:'4 bars gallop → 2 bars pure palm mute → 4 bars gallop. The transition is the training zone. Most players can do both separately but fumble the switch. The muting hand position doesn\'t change between gallop and pure mute — only the strumming pattern does. Keep your right hand anchored at the bridge and only change your pick motion.'},
    {label:'Accent pattern — 15 muted + 1 open accent, 120 BPM', mins:8, color:'#3d0870', bpm:120, skill:'Gallop Rhythm', detail:'15 palm-muted 8th notes, then 1 fully open accented note. The contrast is the point — the silence of the mute makes the open note explode. This is how deathcore breakdowns work rhythmically. The accent should be double the volume of the muted notes. Practice your right-hand palm lift — it should be instant, not gradual.'},
    {label:'Record and listen back — identify one specific thing to fix', mins:7, color:'#5a5248', bpm:90, skill:'Alternate Pick', detail:'Record 60 seconds of your best playing from this session. Then listen without playing. Your brain will try to correct what it hears — resist that. Just listen. Find ONE thing that is clearly imperfect. Write it down. That one thing is your entire focus for the next session. Not five things. One. This is professional-level self-coaching.'}
  ]},
  { name: 'Theory Into Practice', summary: 'Where scale knowledge becomes actual music. The Phrygian riff movement is the signature sound of deathcore — learn to hear and feel it.', blocks: [
    {label:'Warmup — power chord shapes: Am5, Bb5, C5, D5, E5 at 70 BPM', mins:5, color:'#c8883a', bpm:70, skill:'Chromatic/Warmup', detail:'Fret each power chord cleanly and strum 4 times at 70 BPM before moving to the next. Am5: strings 7-5-4 open. Bb5: fret 1 same strings. C5: fret 3. D5: fret 5. E5: fret 7. You\'re mapping the fretboard against scale degrees of A. Every chord you play has a Roman numeral name: Am=i, Bb=bII, C=bIII, D=IV, E=V.'},
    {label:'i-bVII-bVI-bVII progression — clean changes at 90 BPM', mins:10, color:'#7720cc', bpm:90, skill:'Phrygian', detail:'Am→G5→F5→G5 — this is i-bVII-bVI-bVII in A. Strum 4 beats each. This progression is behind hundreds of deathcore songs. It sounds heavy and inevitable because the movement down the scale (Am→G→F) creates a descending pull, and the G at the end creates tension that wants to resolve back to Am. Hold each chord for a full 4 beats before changing.'},
    {label:'Phrygian two-chord riff (i-bII) at 100 BPM', mins:8, color:'#5a10a0', bpm:100, skill:'Phrygian', detail:'Open Am5 → fret 1 (Bb5) → back. Palm mute throughout. This two-chord movement is the most concentrated expression of Phrygian. The half-step movement (Am to Bb) creates immediate menace because it violates Western expectations — the expected chord would be a major chord a 5th above. The Bb is wrong in a perfect way. Practice until the muting stays consistent through both chords.'},
    {label:'Dim7 arpeggio over the progression — hear how it fits', mins:7, color:'#3d0870', bpm:85, skill:'Sweep Arpeggios', detail:'Adim7 = A-C-Eb-F#. Alternate pick these 4 notes in any order over the i-bVII-bVI-bVII progression. Notice which notes sound tense and which resolve. A and C work over Am. Eb creates maximum tension (tritone against A). F# wants to move. This exercise trains your ear to hear harmonic relationships — the foundation of actual improvisation.'},
    {label:'Composition — write and record one 4-bar riff using this session', mins:10, color:'#c8883a', bpm:95, skill:'Natural Minor', detail:'Using everything from this session: pick a tempo between 80-120 BPM. Create a 4-bar riff using at least two of the chords from the i-bVII-bVI-bVII progression. Add palm muting and a gallop pattern. Record it with your phone. This doesn\'t need to be good — it needs to exist. The act of creating something original accelerates your musical development faster than any exercise.'}
  ]},
];

// ── METRONOME DRILLS ──────────────────────────────
const metroDrills = [
  { bpmRange: [40,79], drill: '<p><strong>Slow Sweep Foundation Drill</strong></p><p>At this tempo you have enough time to be completely conscious of every movement. Play the 3-string Am sweep (A open → D fret 2 → G fret 2) and focus entirely on the fretting hand — each finger must lift the <em>instant</em> its string is picked, not when the next finger lands. That lift is what separates sweeping from strumming. 20 perfect reps before increasing by 5 BPM.</p>' },
  { bpmRange: [80,109], drill: '<p><strong>Gallop Precision Drill</strong></p><p>At this tempo, the forward gallop (D-DU) should feel like a heartbeat — automatic. Play it on open string 7 for 8 bars, then the reverse gallop (DU-D) for 8 bars, then switch back without stopping. The seam between the two patterns is your focus: the last note of one pattern and the first of the next must be just as even as everything in the middle.</p><p><strong>Target:</strong> 4 transitions with zero timing error.</p>' },
  { bpmRange: [110,139], drill: '<p><strong>16th Note Alternate Picking Endurance</strong></p><p>Set a 2-minute timer. Alternate pick open string 7 in strict 16th notes at this tempo. No stopping. Count the errors — any uneven note, any pick direction mistake, any change in palm mute pressure. Your score is how many errors in 2 minutes. Track this number weekly. Consistency at moderate tempo is more valuable than speed at your ceiling.</p>' },
  { bpmRange: [140,179], drill: '<p><strong>String 7 Palm Mute Endurance</strong></p><p>This is performance tempo. Play 32 palm-muted alternating-picked 16th notes at this BPM — that\'s 8 beats — then 4 open accent notes, then back to 32 muted. Repeat 4 times without a break. Focus is on maintaining palm contact and pick consistency even as your forearm begins to fatigue. If your tone degrades before 4 repetitions — you\'ve found your actual stamina ceiling.</p>' },
  { bpmRange: [180,240], drill: '<p><strong>Burst Technique Drill</strong></p><p>At this speed, sustained passages are advanced territory. Instead, practice 4-note bursts: pick 4 strict alternate-picked notes, then stop completely for 2 beats. Repeat. The burst trains the fast-twitch precision; the pause prevents speed from masking poor technique. Start each burst precisely on the beat. This develops the ability to <em>enter</em> a fast passage cleanly — which is usually where it breaks down.</p>' },
];

// ── COACHING NOTES ──────────────────────────────────
const coachingNotes = [
  '<p><strong>Priority this week: Palm muting consistency.</strong> Every other technique depends on your right hand control. Take 5 minutes at the start of every session this week to do nothing but palm-muted open-string alternate picking at 80 BPM. Make every note identical. Most players skip this because it feels basic — that\'s why most players have inconsistent rhythm tone.</p><p>Your specific drill: open string 7, 60 seconds at 80 BPM, zero variation in pressure or pick angle. Record it. Listen back. Fix what you hear.</p>',
  '<p><strong>Priority this week: Play slower.</strong> If you\'ve been frustrated with progress, there\'s a 90% chance you\'ve been practising at a tempo where errors are happening faster than your brain can correct them. This week, cut every practice tempo by 20 BPM. Feel embarrassingly slow? Good. That\'s the zone where actual learning happens.</p><p>The ratchet method: 30 seconds of perfect playing at your current BPM before adding 5. Not 10. Not 15. Just 5.</p>',
  '<p><strong>Priority this week: Record yourself every session.</strong> Your ears lie to you while you\'re playing — the brain fills in mistakes with what it intended to play. A phone recording doesn\'t lie. Set it up before you touch the guitar, record the whole session, then spend 5 minutes listening before you put the guitar down.</p><p>One thing to fix per recording. Not five. One. Write it down. Address it next session. This is how professionals practise.</p>',
  '<p><strong>Priority this week: Scale application.</strong> If you\'ve been running scales mechanically, this week you stop doing scale runs and start doing scale phrases. A phrase is 4-8 notes with intention — a beginning, a point of emphasis, and an end. Play 4 notes of A natural minor, land on the root, breathe. That\'s a phrase. Do it over and over until the scale feels musical.</p>',
  '<p><strong>Priority this week: Legato development.</strong> Hammer-ons and pull-offs are your escape from pure picking fatigue. This week, dedicate 10 minutes per session to the 5h7p5 legato loop at 70 BPM on strings 5 and 4. Your goal: every legato note at 90% the volume of your picked notes. Anything quieter means insufficient hammer force or pull-off angle.</p>',
  '<p><strong>Priority this week: Consistency over ceiling.</strong> Pick your best technical exercise and play it at a tempo 15 BPM below your maximum. Practice it for the entire session at that tempo. The goal is to make that speed feel effortless — automatic — before pushing higher. Speed without automaticity is not real speed; it\'s controlled lurching.</p>',
];

// ── PROGRESSION VARIATIONS ──────────────────────────
const progressionVars = [
  '<p><strong>Breakdown version (half-time at 70 BPM):</strong> Play the same chord sequence but hold each chord for 4 beats instead of 1. The slower movement makes every note in the muted chug feel heavier. Add a ghost note (x) between each chord change for the percussive breakdown feel.</p><p><strong>Gallop version (120 BPM):</strong> Apply forward gallop strumming (D-DU) to each chord. The rapid double at the end of each gallop group should land precisely on the upbeat — this is what gives deathcore its propulsive forward energy in verse riffs.</p>',
  '<p><strong>Breakdown version (60 BPM):</strong> Slow the progression to half time and add space — hold each chord for 2 full beats, then a full beat of silence. That silence is part of the groove. The listener\'s brain fills it with anticipation. This is what makes breakdowns feel heavier than the note count suggests.</p><p><strong>Tremolo version (130 BPM):</strong> Apply rapid alternating picking to each chord — 16th notes throughout. The fast tremolo over a slow-moving chord progression creates a wall-of-sound effect. Keep the palm mute consistent across all strings or the chord becomes mud.</p>',
  '<p><strong>Slow doom version (50 BPM):</strong> Hold each chord for 8 full beats. Let the palm mute gradually release on beat 5 to create a swell. This is the rhythmic arc of a doom-influenced breakdown — the gradual opening of the mute creates natural dynamic shape without changing the note.</p><p><strong>Blast-adjacent version (140 BPM):</strong> Play the progression in straight 16th notes with strict alternate picking. No gallop — pure 16ths. This approximates the relentless 16th-note chug of technical deathcore. Focus on pick economy and consistent downstroke weight versus upstroke.</p>',
];

// ── HELPER: pick from bank avoiding recent repeats ──
const usedIndices = {};
function pickFrom(bank, key) {
  if (!bank || !bank.length) return null;
  if (!usedIndices[key]) usedIndices[key] = [];
  const used = usedIndices[key];
  const available = bank.map((_,i)=>i).filter(i => !used.includes(i));
  const pool = available.length ? available : bank.map((_,i)=>i);
  const idx = pool[Math.floor(Math.random() * pool.length)];
  used.push(idx);
  if (used.length > Math.min(3, bank.length - 1)) used.shift();
  return bank[idx];
}

// ── SECTION REFRESH (static content) ────────────────
function refreshSection(itemId) {
  const item = document.getElementById(itemId);
  if (!item) return;
  const topic = item.dataset.topic || '';
  const panel = document.getElementById('ai-panel-' + itemId);
  const body  = document.getElementById('ai-body-' + itemId);
  const btn   = document.getElementById('rbtn-' + itemId);
  const icon  = document.getElementById('rico-' + itemId);
  if (!panel || !body) return;
  if (!item.classList.contains('open')) toggleCollapse(itemId);

  // Find matching exercise bank
  let exercises = null;
  for (const key of Object.keys(exercisesBank)) {
    if (topic.toLowerCase().includes(key.split(' — ')[0].toLowerCase()) ||
        key.toLowerCase().includes(topic.split(' — ')[0].toLowerCase())) {
      exercises = exercisesBank[key];
      break;
    }
  }

  icon.classList.add('spin');
  setTimeout(() => {
    const ex = exercises ? pickFrom(exercises, itemId) : null;
    panel.style.display = 'block';
    if (ex) {
      body.className = 'ai-exercise-body';
      const skillGuess = topic.toLowerCase().includes('scale') ? 'Natural Minor' :
                         topic.toLowerCase().includes('arpeg') || topic.toLowerCase().includes('sweep') ? 'Sweep Arpeggios' :
                         topic.toLowerCase().includes('gallop') || topic.toLowerCase().includes('rhythm') ? 'Gallop Rhythm' :
                         topic.toLowerCase().includes('palm') || topic.toLowerCase().includes('mute') ? 'Palm Muting' :
                         topic.toLowerCase().includes('hammer') || topic.toLowerCase().includes('pull') ? 'Hammer/Pull' :
                         topic.toLowerCase().includes('pick') ? 'Alternate Pick' : 'Chromatic/Warmup';
      const addDetail = ex.instruction + (ex.mistake ? ' ⚠ Common mistake: ' + ex.mistake : '');
      body.innerHTML = `
        <p style="margin-bottom:10px"><strong>Exercise: ${ex.title}</strong> — <span style="color:var(--ember);font-family:var(--mono);font-size:11px">♩ ${ex.bpm} BPM</span></p>
        <div class="ai-tab-block" style="background:#040408;border:1px solid var(--edge);border-left:2px solid var(--blood);padding:12px 14px;margin:10px 0;font-family:var(--mono);font-size:12px;white-space:pre;overflow-x:auto;color:var(--pale)">${ex.tab}</div>
        <p style="font-size:13px;color:var(--mid);line-height:1.7">${ex.instruction}</p>
        <p style="font-family:var(--mono);font-size:11px;color:var(--gold);margin-top:8px;padding-top:8px;border-top:1px solid var(--ghost)">⚠ Common mistake: ${ex.mistake}</p>
        <button class="add-to-sess-btn" onclick="addToSessionFromEl(this,'${ex.title.replace(/'/g,'`')}',5,${ex.bpm},'${skillGuess}','${addDetail.replace(/'/g,'`')}')">+ Add to Session</button>`;
    } else {
      // Generic exercise from tip bank based on topic keywords
      const cat = topic.toLowerCase().includes('scale') ? 'scales' :
                  topic.toLowerCase().includes('arpeggio') || topic.toLowerCase().includes('sweep') ? 'arpeggios' :
                  topic.toLowerCase().includes('gallop') || topic.toLowerCase().includes('rhythm') ? 'rhythm' : 'technique';
      const tip = pickFrom(tipsBank[cat], itemId + '_generic');
      body.className = 'ai-exercise-body';
      body.innerHTML = `<p style="font-size:14px;line-height:1.75;color:var(--pale)">${tip}</p>
        <button class="add-to-sess-btn" onclick="addToSessionFromEl(this,'${topic.split(' — ')[0]}',5,80,'${cat}','${tip.replace(/<[^>]+>/g,'').replace(/'/g,'`').slice(0,200)}')">+ Add to Session</button>`;
    }
    icon.classList.remove('spin');
    const colBody = item.querySelector('.collapse-body');
    if (colBody && colBody.style.maxHeight !== 'none') {
      colBody.style.maxHeight = colBody.scrollHeight + 'px';
    }
  }, 400);
}

function showSectionPanel(panelId, iconId, btnId, html) {
  const panel = document.getElementById(panelId);
  const icon  = document.getElementById(iconId);
  const btn   = document.getElementById(btnId);
  if (!panel) return;
  icon && icon.classList.add('spin');
  btn && (btn.disabled = true);
  setTimeout(() => {
    panel.style.display = 'block';
    const bodyEl = panel.querySelector('.section-ai-body');
    if (bodyEl) { bodyEl.className = 'section-ai-body'; bodyEl.innerHTML = html; }
    icon && icon.classList.remove('spin');
    btn && (btn.disabled = false);
  }, 350);
}

function refreshScaleExercise() {
  const activePill = document.querySelector('.scale-pill.active');
  const scaleName = activePill ? activePill.textContent.trim() : 'Natural Minor';
  const cat = scaleName.toLowerCase().includes('phryg') ? 'Phrygian — bII · FLAT 2ND · SPANISH FLAVOUR' :
              scaleName.toLowerCase().includes('harmonic') ? 'Harmonic Minor — ROOT · 2 · b3 · 4 · 5 · b6 · 7' :
              'Natural Minor — A · C · D · E · F · G · A';
  const exercises = exercisesBank[cat] || exercisesBank['Natural Minor — A · C · D · E · F · G · A'];
  const ex = pickFrom(exercises, 'scale_' + scaleName);
  const tip = pickFrom(tipsBank.scales, 'scale_tip_' + scaleName);
  const skillName = scaleName.toLowerCase().includes('phryg') ? 'Phrygian' :
                    scaleName.toLowerCase().includes('harmonic') ? 'Harmonic Minor' : 'Natural Minor';
  const addDetail = ex ? ex.instruction : tip;
  const addBpm    = ex ? ex.bpm : 70;
  const addTitle  = ex ? scaleName + ': ' + ex.title : scaleName + ' Scale Practice';
  const html = (ex
    ? `<p style="margin-bottom:10px"><strong>${scaleName}: ${ex.title}</strong> — <span style="color:var(--ember);font-family:var(--mono);font-size:11px">♩ ${ex.bpm} BPM</span></p>
       <div style="background:#040408;border:1px solid var(--edge);border-left:2px solid var(--blood);padding:12px 14px;margin:10px 0;font-family:var(--mono);font-size:12px;white-space:pre;overflow-x:auto;color:var(--pale)">${ex.tab}</div>
       <p style="font-size:13px;color:var(--mid)">${ex.instruction}</p>`
    : `<p>${tip}</p>`) +
    `<button class="add-to-sess-btn" onclick="addToSessionFromEl(this,'${addTitle.replace(/'/g,'`')}',8,${addBpm},'${skillName}','${addDetail.replace(/<[^>]+>/g,'').replace(/'/g,'`').slice(0,250)}')">+ Add to Session</button>`;
  showSectionPanel('scale-ai-panel','scale-ref-icon','scale-ref-btn', html);
}

function refreshSessionPlan() {
  const plan = pickFrom(sessionPlans, 'session_plan');
  const html = `
    <div style="margin-bottom:12px">
      <div style="font-size:15px;font-weight:700;color:var(--pale)">${plan.name}</div>
      <div style="font-size:12px;color:var(--dim);margin-top:3px">${plan.summary || ''}</div>
    </div>
    ${plan.blocks.map((b, i) =>
      `<div onclick="openPlanBlockModal(${i}, currentDisplayedPlan)" style="display:flex;align-items:center;gap:12px;padding:10px 8px;border-bottom:1px solid var(--ghost);cursor:pointer;border-radius:6px;transition:background 0.15s" onmouseover="this.style.background='rgba(100,16,180,0.1)'" onmouseout="this.style.background=''">
        <div style="width:4px;height:40px;background:${b.color};border-radius:2px;flex-shrink:0"></div>
        <div style="flex:1">
          <div style="font-size:13px;color:var(--mid)">${b.label}</div>
          ${b.bpm ? `<div style="font-family:var(--mono);font-size:10px;color:var(--flame);margin-top:2px">♩ ${b.bpm} BPM</div>` : ''}
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
          <div style="font-family:var(--mono);font-size:11px;color:var(--dim)">${b.mins}min</div>
          <div style="font-size:10px;color:var(--blood);opacity:0.8">tap for detail ›</div>
        </div>
      </div>`).join('')}
    <div style="display:flex;gap:8px;margin-top:18px;flex-wrap:wrap">
      <button class="sess-big-btn" style="flex:1;min-width:180px;font-size:12px;padding:11px"
        onclick="loadFromPlan(currentDisplayedPlan)">
        ▶ LOAD FULL SESSION
      </button>
    </div>`;
  currentDisplayedPlan = plan;
  showSectionPanel('session-ai-panel','sess-ref-icon','sess-ref-btn', html);
}
let currentDisplayedPlan = null;

function loadFromPlan(plan) {
  sessionBlocks = plan.blocks.map(b => ({
    name: b.label,
    mins: b.mins,
    color: b.color,
    bpm: b.bpm || 80,
    skill: b.skill || null,
    detail: b.detail || '',
    secsLeft: b.mins * 60,
    done: false
  }));
  currentBlockIdx = 0;
  selectedBlockIdx = 0;  // auto-expand first block
  const el = document.getElementById('active-plan-name');
  if (el) el.textContent = '📋 ' + plan.name;
  // Auto-set BPM to first block
  const firstBlock = sessionBlocks[0];
  if (firstBlock && firstBlock.bpm) updateBPM(firstBlock.bpm);
  renderBlocks();
  updateTimerDisplay();
  showToast('Session loaded · tap any block for details');
  document.getElementById('session').scrollTo({ top: 0, behavior: 'smooth' });
  const btn = document.getElementById('sess-start-btn');
  if (btn) { btn.style.transform='scale(1.05)'; setTimeout(()=>btn.style.transform='',400); }
}

function refreshRoadmap() {
  const ideas = [
    '<p><strong>Fretboard Note Flashcard Mode</strong> — A fret position lights up on the interactive fretboard; you say the note name aloud, then click to reveal. Track which positions you always get right vs blank on. Full fretboard knowledge is the single biggest gap between intermediate and advanced players and almost no one deliberately trains it.</p>',
    '<p><strong>In-Browser Riff Recorder with Annotation</strong> — Record a short clip directly in the app, play it back immediately, then type timestamped notes: "0:04 — pick angle collapses on the upstroke." This turns passive self-recording into an active coaching loop, and the annotations stay attached to the recording for review.</p>',
    '<p><strong>BPM Ramp Trainer</strong> — Set a start BPM, end BPM, and increment. The metronome automatically steps up every 60 seconds. A "clean threshold" marker shows your last confirmed error-free tempo. Gamifies the plateau-breaking process and removes the mental overhead of manually bumping the click.</p>',
    '<p><strong>Chord Tone vs Scale Tone Visualiser</strong> — Select a chord, and the fretboard highlights chord tones (A, C, E for Am) in one colour and available scale tones in another. Teaches when to land on strong notes vs passing notes — the fundamental improvisation concept that most beginners never explicitly learn.</p>',
    '<p><strong>Practice Consistency Heatmap</strong> — A calendar grid showing which days you logged practice (like GitHub\'s contribution graph). Visual consistency tracking is one of the most effective motivational tools known — seeing a streak of filled squares creates a powerful psychological pull to not break it.</p>',
    '<p><strong>Interval Ear Training with Metal Context</strong> — Instead of abstract beeps, play intervals as actual guitar riffs using the Web Audio API. The tritone as a Black Sabbath-style riff. The minor 2nd as a Phrygian chug. Learning to hear intervals as sounds you already recognise is a completely different experience from generic ear training.</p>',
  ];
  const picked = [pickFrom(ideas,'road_a'), pickFrom(ideas,'road_b'), pickFrom(ideas,'road_c')];
  showSectionPanel('roadmap-ai-panel','road-ref-icon','road-ref-btn', picked.join('<hr style="border:none;border-top:1px solid var(--edge);margin:14px 0">'));
}

function refreshMetronome() {
  const drill = metroDrills.find(d => bpm >= d.bpmRange[0] && bpm <= d.bpmRange[1]) || metroDrills[1];
  const skill = bpm < 80 ? 'Sweep Arpeggios' : bpm < 110 ? 'Gallop Rhythm' : bpm < 140 ? 'Alternate Pick' : 'Alternate Pick';
  const cleanText = drill.drill.replace(/<[^>]+>/g,'').slice(0,250);
  const html = drill.drill + `<button class="add-to-sess-btn" style="margin-top:14px" onclick="addToSessionFromEl(this,'Metronome Drill @ ${bpm} BPM',5,${bpm},'${skill}','${cleanText.replace(/'/g,'`')}')">+ Add to Session</button>`;
  showSectionPanel('metro-ai-panel','metro-ref-icon','metro-ref-btn', html);
}

/* ═══════════════════════════════════════
   TAB HTML HELPER
/* ═══════════════════════════════════════
   TAB HTML HELPER
═══════════════════════════════════════ */
function makeTab(label, rows, comment, legend) {
  const rowsHtml = rows.map(r => `
    <div class="tab-row">
      <span class="tab-str">${r[0]}</span>
      <span class="tab-sep">|</span>
      <span class="tab-notes">${r[1]}</span>
    </div>`).join('');
  return `
    <div class="tab-block">
      <div class="tab-block-label">${label}</div>
      ${comment ? `<div class="tab-comment">// ${comment}</div>` : ''}
      ${rowsHtml}
      ${legend ? `<div class="tab-legend">${legend}</div>` : ''}
    </div>`;
}

/* ═══════════════════════════════════════
   CONTENT DATA
═══════════════════════════════════════ */

// ── FUNDAMENTALS ──
const fundamentalsData = [
  {
    icon: '♦',
    title: 'Drop A Tuning Reference',
    sub: 'STRING LAYOUT · YOUR WEAPON',
    badge: 'ESSENTIAL',
    content: `
      <p class="prose" style="margin-top:14px">In <strong>Drop A</strong> on a 7-string, your strings from lowest to highest are:</p>
      ${makeTab('OPEN STRINGS', [
        ['7','A  ← The drop string — one-finger power chords live here'],
        ['6','E'],
        ['5','A'],
        ['4','D'],
        ['3','G'],
        ['2','B'],
        ['1','E  ← High E'],
      ], 'Open string pitches, lowest to highest')}
      <p class="prose">The <strong>7th string (A)</strong> is tuned a whole step below the 6th. Because both strings 5, 6, and 7 are all a 5th apart in drop tuning, you can barre one finger across all three for a full power chord — freeing your other fingers for gallop picking.</p>
      ${makeTab('POWER CHORDS — DROP A', [
        ['7','<span class="h">0</span>---<span class="h">2</span>---<span class="h">5</span>---<span class="h">7</span>'],
        ['6','<span class="h">0</span>---<span class="h">2</span>---<span class="h">5</span>---<span class="h">7</span>'],
        ['5','<span class="h">0</span>---<span class="h">2</span>---<span class="h">5</span>---<span class="h">7</span>'],
        ['4','<span class="x">x</span>---<span class="x">x</span>---<span class="x">x</span>---<span class="x">x</span>'],
      ], 'A5 · B5 · D5 · E5 — one barre finger each', 'h = highlighted root · x = muted string')}
    `
  },
  {
    icon: '✋',
    title: 'Fretting Hand Posture',
    sub: 'HAND POSITION · TENSION CONTROL',
    badge: 'START HERE',
    badgeColor: 'gold',
    content: `
      <p class="prose" style="margin-top:14px">Poor posture is the silent killer of progress. These habits must be correct from day one — they\'re almost impossible to fix after they\'re cemented.</p>
      <ul class="dot-list">
        <li><strong>Thumb behind the neck</strong> — roughly behind your middle finger. Wrapping it over the top cuts your reach and causes cramps.</li>
        <li><strong>Curved fingers</strong> — fret with your fingertips, not the flat pads. Each finger should arc like a gentle claw.</li>
        <li><strong>One finger per fret</strong> — when warming up, assign: index=fret 5, middle=6, ring=7, pinky=8. Train this until it\'s automatic.</li>
        <li><strong>Relax actively</strong> — consciously check for tension in your forearm every 5 minutes. If you\'re squeezing hard, you\'re squeezing too hard.</li>
      </ul>
      ${makeTab('1-2-3-4 CHROMATIC WARMUP', [
        ['e','5-6-7-8-7-6-5'],
        ['B','5-6-7-8-7-6-5'],
        ['G','5-6-7-8-7-6-5'],
        ['D','5-6-7-8-7-6-5'],
        ['A','5-6-7-8-7-6-5'],
        ['E','5-6-7-8-7-6-5'],
        ['A','5-6-7-8-7-6-5'],
      ], 'Do this EVERY session before anything else — 60 BPM, every note clean')}
      <div class="info-box" style="margin-top:14px">
        <strong>Pain = Stop.</strong> Wrist or forearm pain is your body telling you something is wrong. Rest, shake out, and reassess your angle. No riff is worth tendinitis.
      </div>
    `
  },
  {
    icon: '⤵',
    title: 'Pick Grip & Angle for Metal',
    sub: 'PICKING HAND · ATTACK',
    content: `
      <p class="prose" style="margin-top:14px">Metal picking is mechanical precision. The right grip makes everything else easier.</p>
      <ul class="dot-list">
        <li><strong>Pick weight:</strong> 1.0mm minimum. Most metal guitarists use 1.5mm+ (Dunlop Jazz III XL or Ultex Sharp). Thin picks = flappy attack = mud.</li>
        <li><strong>Grip:</strong> Index finger curled, pick resting on the first segment. Thumb presses lightly on top. Don\'t death-grip it — the pick should have a little give.</li>
        <li><strong>Angle:</strong> Tilt the pick 30–45° relative to the strings. This reduces drag and increases speed. Perfectly flat pick = maximum resistance.</li>
        <li><strong>Wrist vs elbow:</strong> For deathcore speeds, most of the motion comes from the wrist. At extreme BPM some elbow motion is unavoidable, but anchor the movement in the wrist.</li>
      </ul>
      ${makeTab('ALTERNATE PICKING DRILL', [
        ['e','-------------------------------'],
        ['B','-------------------------------'],
        ['G','-------------------------------'],
        ['D','-------------------------------'],
        ['A','-------------------------------'],
        ['E','-------------------------------'],
        ['A','0-0-0-0-0-0-0-0-0-0-0-0-0-0-0'],
      ], 'Down-Up-Down-Up on string 7 open, palm muted — start at 60 BPM', 'Every note equal volume, equal duration. Increase 5 BPM every 2 clean minutes.')}
    `
  },
  {
    icon: '📖',
    title: 'Reading Guitar Tabs',
    sub: 'TAB NOTATION · SYMBOLS',
    content: `
      <p class="prose" style="margin-top:14px">Tabs are a number system representing frets. Numbers go on string lines. <strong>0 = open string.</strong> Higher numbers = higher up the neck.</p>
      ${makeTab('TAB SYMBOLS GUIDE', [
        ['B','7<span class="h">h</span>9---9<span class="h">p</span>7  h=hammer-on / p=pull-off'],
        ['B','7<span class="h">b</span>9~~~       b=bend up to pitch of fret 9 / ~~~=vibrato'],
        ['G','5<span class="h">/</span>7---7<span class="h">\\</span>5  /=slide up / \\=slide down'],
        ['D','5-----5    Numbers on same time = played together (chord)'],
        ['A','5-----5'],
        ['E','<span class="x">x</span>-----------  x = muted/dead note'],
      ], 'Common tab notation — all symbols you\'ll encounter in deathcore tabs')}
      <p class="prose">When multiple numbers are stacked vertically (aligned in the tab), they\'re played simultaneously. Otherwise read left to right.</p>
    `
  },
  {
    icon: '🤲',
    title: 'Palm Muting — The Metal Foundation',
    sub: 'RIGHT HAND · TIGHTNESS',
    badge: 'CRITICAL',
    badgeColor: 'gold',
    content: `
      <p class="prose" style="margin-top:14px">Palm muting is what separates metal from everything else. Rest the heel of your picking hand lightly on the bridge saddles — just barely touching the strings at the very end.</p>
      <ul class="dot-list">
        <li><strong>Position:</strong> The contact point is the bony heel of your palm, at the very bridge. Too far forward = dead/thuddy. Right at the bridge = tight and percussive.</li>
        <li><strong>Pressure:</strong> Start with almost no pressure. Gradually roll your hand slightly toward the neck until you find that sweet chugging tone.</li>
        <li><strong>Left hand muting:</strong> Fingers not fretting a note should lightly rest on strings to prevent sympathetic ringing. This is equally important.</li>
      </ul>
      ${makeTab('MUTING EXERCISE', [
        ['7','<span class="h">0-0-0-0</span>-<span class="x">x</span>-<span class="h">0-0-0-0</span>-<span class="x">x</span>-<span class="h">0-0-0-0</span>'],
        ['6','<span class="x">x-x-x-x-x-x-x-x-x-x-x-x-x-x-x</span>'],
        ['5','<span class="x">x-x-x-x-x-x-x-x-x-x-x-x-x-x-x</span>'],
      ], 'Palm muted chugs on string 7 — x = silent (no ringing strings)', 'PM . . . . . . . . every note is palm muted. The 5th note is a ghost/accent.')}
      <div class="info-box">
        <strong>Test:</strong> After every note you play on one string, no other string should ring. If you hear sympathetic buzz or ring, your muting isn\'t tight enough yet.
      </div>
    `
  }
];

// ── SCALES ──
const scalesData = [
  {
    id: 'minor',
    name: 'Natural Minor',
    formula: 'W-H-W-W-H-W-W',
    notes: 'A B C D E F G',
    color: '#7720cc',
    dots: [0,2,3,5,7,8,10], // semitones from root
    icon: '≡',
    title: 'A Natural Minor',
    sub: 'THE FOUNDATION · DARK & MELANCHOLIC',
    badge: 'LEARN FIRST',
    badgeColor: 'gold',
    content: `
      <p class="prose" style="margin-top:14px">The natural minor scale is the bedrock of all heavy music. Every other deathcore scale is an alteration of this. Own it completely before moving on.</p>
      <p class="prose">Notes in A: <strong>A B C D E F G</strong> — Formula: W-H-W-W-H-W-W</p>
      ${makeTab('A NATURAL MINOR — POSITION 1 (7-STRING)', [
        ['e','-------------<span class="h">5</span>-<span class="h">7</span>-<span class="h">8</span>'],
        ['B','-----------<span class="h">5</span>-<span class="h">6</span>-<span class="h">8</span>'],
        ['G','---------<span class="h">5</span>-<span class="h">7</span>'],
        ['D','-------<span class="h">5</span>-<span class="h">7</span>-<span class="h">8</span>'],
        ['A','-------<span class="h">5</span>-<span class="h">7</span>-<span class="h">8</span>'],
        ['E','-------<span class="h">5</span>-<span class="h">7</span>'],
        ['A','---<span class="h">5</span>-<span class="h">7</span>-<span class="h">8</span>'],
      ], 'Ascending — play each highlighted note cleanly, one at a time')}
      ${makeTab('MINOR SCALE LICK IN A', [
        ['e','------------------------'],
        ['B','------------------------'],
        ['G','------<span class="h">5</span>-<span class="h">7</span>-----------'],
        ['D','----<span class="h">5</span>-<span class="h">7</span>-<span class="h">8</span>---------'],
        ['A','--<span class="h">5</span>-<span class="h">7</span>-<span class="h">8</span>-----------'],
        ['E','------------------------'],
        ['A','------------------------'],
      ], 'Simple 3-string minor pentatonic-style lick', 'Practice ascending + descending. Then in 3rds: 1-3, 2-4, 3-5...')}
    `
  },
  {
    id: 'phrygian',
    name: 'Phrygian',
    formula: 'H-W-W-W-H-W-W',
    notes: 'A Bb C D E F G',
    color: '#5a10a0',
    dots: [0,1,3,5,7,8,10],
    icon: '◈',
    title: 'A Phrygian',
    sub: 'MIDDLE EASTERN DARKNESS · GENRE STAPLE',
    badge: 'LEARN SECOND',
    content: `
      <p class="prose" style="margin-top:14px">Phrygian is natural minor with a <strong>flat 2nd (Bb)</strong>. That half-step interval from A to Bb is the signature "terror" interval of deathcore. It's everywhere.</p>
      <p class="prose">Notes: <strong>A Bb C D E F G</strong></p>
      ${makeTab('A PHRYGIAN — POSITION 1', [
        ['e','-------------<span class="h">5</span>-<span class="h">6</span>-<span class="h">8</span>'],
        ['B','-----------<span class="h">5</span>-<span class="h">6</span>-<span class="h">8</span>'],
        ['G','---------<span class="h">5</span>-<span class="h">7</span>'],
        ['D','-------<span class="h">5</span>-<span class="h">6</span>-<span class="h">8</span>'],
        ['A','-------<span class="h">5</span>-<span class="h">6</span>-<span class="h">8</span>'],
        ['E','-------<span class="h">5</span>-<span class="h">7</span>'],
        ['A','---<span class="h">5</span>-<span class="h">6</span>-<span class="h">8</span>'],
      ], 'Spot the difference from Natural Minor — fret 6 replaces fret 7 on strings 7, 6, 5, 4, 2')}
      ${makeTab('PHRYGIAN SIGNATURE LICK', [
        ['A','---<span class="h">0</span>-<span class="h">1</span>-<span class="h">0</span>---<span class="h">0</span>-<span class="h">1</span>-<span class="h">3</span>-<span class="h">1</span>-<span class="h">0</span>---'],
        ['E','------------------------------------------'],
      ], 'The b2 interval (0→1 on string 7 = A→Bb) is THE deathcore move', 'Use this over a droning A for maximum Phrygian menace')}
    `
  },
  {
    id: 'harmonic',
    name: 'Harmonic Minor',
    formula: 'W-H-W-W-H-A2-H',
    notes: 'A B C D E F G#',
    color: '#3d0870',
    dots: [0,2,3,5,7,8,11],
    icon: '∿',
    title: 'A Harmonic Minor',
    sub: 'RAISED 7TH · NEO-CLASSICAL EVIL',
    content: `
      <p class="prose" style="margin-top:14px">Natural minor with a raised 7th (G# instead of G). The augmented 2nd interval between the b6 and natural 7 is what creates that classical, cinematic evil sound.</p>
      ${makeTab('A HARMONIC MINOR', [
        ['e','-------------<span class="h">5</span>-<span class="h">7</span>-<span class="h">8</span>'],
        ['B','-----------<span class="h">4</span>-<span class="h">5</span>-<span class="h">8</span>'],
        ['G','---------<span class="h">5</span>-<span class="h">7</span>'],
        ['D','-------<span class="h">5</span>-<span class="h">7</span>-<span class="h">8</span>'],
        ['A','-------<span class="h">5</span>-<span class="h">7</span>-<span class="h">8</span>'],
        ['E','-------<span class="h">5</span>-<span class="h">7</span>'],
        ['A','---<span class="h">5</span>-<span class="h">7</span>-<span class="h">8</span>'],
      ], 'Note the G# on the B string (fret 4 instead of 5)')}
      ${makeTab('HARMONIC MINOR DESCENDING RUN', [
        ['e','<span class="h">8</span>-<span class="h">7</span>-<span class="h">5</span>---------------------------------'],
        ['B','--------<span class="h">8</span>-<span class="h">5</span>-<span class="h">4</span>-------------------'],
        ['G','------------------<span class="h">7</span>-<span class="h">5</span>-----------'],
        ['D','------------------------<span class="h">8</span>-<span class="h">7</span>-<span class="h">5</span>'],
      ], 'Descending across strings — the G# (fret 4, B string) is the spice')}
    `
  },
  {
    id: 'diminished',
    name: 'Diminished',
    formula: 'W-H-W-H-W-H-W-H',
    notes: 'A B C D Eb F F# G#',
    color: '#5a0f0f',
    dots: [0,2,3,5,6,8,9,11],
    icon: '◦',
    title: 'Diminished (Whole-Half)',
    sub: 'SYMMETRICAL · PURE HORROR',
    badge: 'ADVANCED',
    badgeColor: 'gray',
    content: `
      <p class="prose" style="margin-top:14px">8-note symmetrical scale. It repeats every 3 frets, meaning the same fingering shape works at frets 5, 8, and 11. Creates cascading, unresolved tension.</p>
      ${makeTab('DIMINISHED SHAPE (STRINGS 7-5)', [
        ['A','---<span class="h">5</span>-<span class="h">6</span>-<span class="h">8</span>-<span class="h">9</span>---'],
        ['E','---<span class="h">5</span>-<span class="h">6</span>-<span class="h">8</span>-<span class="h">9</span>---'],
        ['A','---<span class="h">5</span>-<span class="h">6</span>-<span class="h">8</span>-<span class="h">9</span>---'],
      ], 'Same 4-note pattern on all three lowest strings', 'Shift entire shape up 3 frets = same scale, different voicing')}
      ${makeTab('DIMINISHED SWEEP/RUN IDEA', [
        ['e','-------------------------------<span class="h">8</span>-<span class="h">9</span>'],
        ['B','-------------------------<span class="h">8</span>-<span class="h">9</span>----'],
        ['G','-------------------<span class="h">6</span>-<span class="h">9</span>--------'],
        ['D','-----------<span class="h">6</span>-<span class="h">7</span>-<span class="h">9</span>--------------'],
        ['A','---<span class="h">5</span>-<span class="h">6</span>-<span class="h">8</span>-<span class="h">9</span>-------------------'],
      ], 'Rising run across strings — the symmetry lets you shift this up 3 frets')}
    `
  }
];

// ── ARPEGGIOS ──
const arpeggiosData = [
  {
    icon: '◈',
    title: 'Am Arpeggio — Your First Shape',
    sub: 'ROOT · b3 · 5 — MINOR TRIAD',
    badge: 'START HERE',
    badgeColor: 'gold',
    content: `
      <p class="prose" style="margin-top:14px">An arpeggio is just a chord with its notes played one at a time. Start here: the Am triad has three notes — A (root), C (flat 3rd), E (5th).</p>
      ${makeTab('Am ARPEGGIO — PICK VERSION', [
        ['e','---<span class="h">0</span>-----------'],
        ['B','------<span class="h">1</span>--------'],
        ['G','---------<span class="h">2</span>-----'],
        ['D','------------<span class="h">2</span>--'],
        ['A','---------------<span class="h">0</span>'],
        ['E','--------------------'],
        ['A','<span class="h">0</span>-------------------'],
      ], 'Play each note individually — ascending then descending. No sweeping yet.', 'Start at 60 BPM. Every note clean and equal volume.')}
      <p class="prose" style="margin-top:12px">Once this is smooth, shift the shape: <strong>Bm = fret 2, Cm = fret 3, Dm = fret 5.</strong> The shape moves intact.</p>
    `
  },
  {
    icon: '↓↑',
    title: 'Introduction to Sweep Picking',
    sub: 'ONE DIRECTIONAL MOTION · CLEAN EXECUTION',
    badge: 'TAKE YOUR TIME',
    content: `
      <p class="prose" style="margin-top:14px">Sweep picking means dragging the pick in one continuous direction across multiple strings — like a controlled, slow strum where the left hand times each note perfectly.</p>
      <div class="info-box">
        <strong>THE GOLDEN RULE:</strong> Each fretting finger must lift immediately after its note is picked. No notes should ring together (unless intentional). Blurring = you\'re going too fast.
      </div>
      ${makeTab('Am 5-STRING SWEEP ARPEGGIO', [
        ['e','----<span class="h">0</span>--------0----'],
        ['B','------<span class="h">1</span>----<span class="h">1</span>------'],
        ['G','--------<span class="h">2</span>----------'],
        ['D','------<span class="h">2</span>----<span class="h">2</span>------'],
        ['A','---<span class="h">0</span>----------<span class="h">0</span>---'],
        ['E','-<span class="h">0</span>--------------<span class="h">0</span>'],
      ], 'Down sweep → top → up sweep. The top note is a pivot — pick down, return up.', 'Start at 40 BPM. If any notes blur together, you\'re too fast. h=down, then up')}
      <p class="prose" style="margin-top:12px">Practice the down-sweep on 3 strings first. Add strings one at a time over weeks. Trying to sweep 6 strings before 3 are clean is a trap.</p>
    `
  },
  {
    icon: '♦',
    title: 'Diminished 7 Arpeggio',
    sub: 'ROOT · b3 · b5 · bb7 — THE EVIL CHORD',
    badge: 'ADVANCED',
    badgeColor: 'gray',
    content: `
      <p class="prose" style="margin-top:14px">Four notes, each a minor third apart. Because it's perfectly symmetrical, the same shape repeats every 3 frets. Pure unresolved horror.</p>
      ${makeTab('Adim7 ARPEGGIO', [
        ['e','---<span class="h">5</span>-----------'],
        ['B','------<span class="h">5</span>--------'],
        ['G','---------<span class="h">6</span>-----'],
        ['D','------------<span class="h">7</span>--'],
        ['A','---------------<span class="h">7</span>'],
        ['E','------------------'],
        ['A','<span class="h">5</span>-----------------'],
      ], 'Adim7: A - C - Eb - F# — shift entire shape up 3 frets for same arpeggio')}
      ${makeTab('dim7 DESCENDING SWEEP (3-STRING)', [
        ['G','<span class="h">6</span>-----------'],
        ['D','--<span class="h">7</span>--------'],
        ['A','-----<span class="h">7</span>-----'],
        ['E','--------<span class="h">8</span>--'],
      ], 'One direction sweep going down — each note a minor 3rd below')}
    `
  },
  {
    icon: '↗',
    title: 'Major Arpeggio Shape',
    sub: 'ROOT · 3 · 5 — FOR CONTRAST',
    content: `
      <p class="prose" style="margin-top:14px">Major arpeggios provide contrast in deathcore — a momentary brightness before collapsing back into darkness. Use sparingly for impact.</p>
      ${makeTab('A MAJOR ARPEGGIO', [
        ['e','---<span class="h">0</span>-----------'],
        ['B','------<span class="h">2</span>--------'],
        ['G','---------<span class="h">2</span>-----'],
        ['D','------------<span class="h">2</span>--'],
        ['A','---------------<span class="h">0</span>'],
        ['E','--------------------'],
        ['A','<span class="h">0</span>-------------------'],
      ], 'A major: A - C# - E — compare to Am (C vs C# is the only difference)')}
    `
  }
];

// ── TECHNIQUES ──
const techniquesData = [
  {
    icon: '⊕',
    title: 'Palm Muting & The Chug',
    sub: 'THE DEATHCORE HEARTBEAT',
    badge: 'ESSENTIAL',
    badgeColor: 'gold',
    content: `
      <p class="prose" style="margin-top:14px">The chug is the rhythmic core of every breakdown and verse. It's palm muted alternate picking on low strings — tight, percussive, intentional.</p>
      ${makeTab('BASIC CHUG — STRING 7', [
        ['A','<span class="h">0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0</span>'],
      ], 'All palm muted (PM), alternate pick every note — start 80 BPM', 'PM = palm mute all notes. Goal: every note sounds identical — same volume, same length.')}
      ${makeTab('OPEN-PALM-OPEN BREAKDOWN PATTERN', [
        ['A','<span class="h">0</span>-<span class="h">0</span>-<span class="h">0</span>-<span class="x">x</span>-<span class="h">0</span>-<span class="h">0</span>-<span class="h">0</span>-<span class="x">x</span>-<span class="h">0</span>-<span class="h">0</span>-<span class="h">0</span>-<span class="x">x</span>-<span class="h">2</span>-<span class="h">2</span>-<span class="h">2</span>-<span class="x">x</span>'],
      ], 'Mix of open, PM, and B5 chord — x = ghost note (muted accent)', 'The ghost notes (x) are percussive dead notes — pick them but mute fully.')}
    `
  },
  {
    icon: '♩♪',
    title: 'Gallop & Rhythm Patterns',
    sub: 'FORWARD & REVERSE GALLOP',
    badge: 'ESSENTIAL',
    badgeColor: 'gold',
    content: `
      <p class="prose" style="margin-top:14px">The gallop is a triplet subdivision: three notes in the space of two. Forward gallop = long-short-short. Reverse gallop = short-short-long.</p>
      ${makeTab('FORWARD GALLOP (long-short-short)', [
        ['A','<span class="h">0</span>--<span class="h">0</span>-<span class="h">0</span>-<span class="h">0</span>--<span class="h">0</span>-<span class="h">0</span>-<span class="h">0</span>--<span class="h">0</span>-<span class="h">0</span>-<span class="h">0</span>--<span class="h">0</span>-<span class="h">0</span>'],
      ], 'Pick: D --- DU --- D --- DU (D=down, U=up) — all palm muted at 80 BPM')}
      ${makeTab('REVERSE GALLOP (short-short-long)', [
        ['A','<span class="h">0</span>-<span class="h">0</span>--<span class="h">0</span>-<span class="h">0</span>-<span class="h">0</span>--<span class="h">0</span>-<span class="h">0</span>-<span class="h">0</span>--<span class="h">0</span>-<span class="h">0</span>-<span class="h">0</span>--<span class="h">0</span>'],
      ], 'Pick: DU --- D --- DU --- D — used in slower breakdowns')}
      ${makeTab('GALLOP WITH CHORD MOVEMENT', [
        ['A','<span class="h">0</span>--<span class="h">0</span>-<span class="h">0</span>-<span class="h">2</span>--<span class="h">2</span>-<span class="h">2</span>-<span class="h">3</span>--<span class="h">3</span>-<span class="h">3</span>-<span class="h">5</span>--<span class="h">5</span>-<span class="h">5</span>'],
        ['E','<span class="h">0</span>--<span class="h">0</span>-<span class="h">0</span>-<span class="h">2</span>--<span class="h">2</span>-<span class="h">2</span>-<span class="h">3</span>--<span class="h">3</span>-<span class="h">3</span>-<span class="h">5</span>--<span class="h">5</span>-<span class="h">5</span>'],
        ['A','<span class="h">0</span>--<span class="h">0</span>-<span class="h">0</span>-<span class="h">2</span>--<span class="h">2</span>-<span class="h">2</span>-<span class="h">3</span>--<span class="h">3</span>-<span class="h">3</span>-<span class="h">5</span>--<span class="h">5</span>-<span class="h">5</span>'],
      ], 'A5 → B5 → C5 → D5 with forward gallop — this IS deathcore')}
    `
  },
  {
    icon: 'h·p',
    title: 'Hammer-ons & Pull-offs',
    sub: 'LEGATO TECHNIQUE',
    content: `
      <p class="prose" style="margin-top:14px"><strong>Hammer-on:</strong> Pick a note, then slam a higher finger down on the same string — the second note sounds from the impact alone. <strong>Pull-off:</strong> Fret two notes, pick, then pull the upper finger sideways off the string, sounding the lower note.</p>
      ${makeTab('BASIC HAMMER-ON EXERCISE', [
        ['A','<span class="h">5</span>h<span class="h">7</span>-<span class="h">5</span>h<span class="h">7</span>-<span class="h">5</span>h<span class="h">7</span>-<span class="h">5</span>h<span class="h">7</span>'],
      ], 'Pick only the 5 — the 7 is hammered. Pick should sound, hammer should sound equally.', 'h = hammer-on (no pick, left hand only)')}
      ${makeTab('HAMMER-ON + PULL-OFF COMBO', [
        ['A','<span class="h">5</span>h<span class="h">7</span>p<span class="h">5</span>-<span class="h">5</span>h<span class="h">7</span>p<span class="h">5</span>-<span class="h">5</span>h<span class="h">7</span>p<span class="h">5</span>'],
      ], 'One pick, three notes — 5 (pick) → 7 (hammer) → 5 (pull)')}
      ${makeTab('A MINOR LEGATO RUN', [
        ['A','<span class="h">5</span>h<span class="h">7</span>h<span class="h">8</span>-<span class="h">8</span>p<span class="h">7</span>p<span class="h">5</span>-<span class="h">5</span>h<span class="h">7</span>h<span class="h">8</span>'],
        ['E','<span class="h">5</span>h<span class="h">7</span>-------<span class="h">5</span>h<span class="h">7</span>---'],
      ], 'Natural minor ascending legato — string 7 to 6 transition')}
    `
  },
  {
    icon: '◠',
    title: 'String Bends & Vibrato',
    sub: 'EXPRESSION · THE VOICE OF METAL',
    content: `
      <p class="prose" style="margin-top:14px">Bends and vibrato are what make a lead sound alive. Without vibrato, notes are sterile. These take months to develop — start now.</p>
      ${makeTab('WHOLE STEP BEND', [
        ['B','---7<span class="h">b</span>9~~~---7<span class="h">b</span>9~~~---7<span class="h">b</span>9'],
      ], 'Fret 7 (F#), bend up to sound of fret 9 (G#). Vibrato after bend = ~~~', 'b9 = bend until the note matches fret 9 pitch. Use your ear.')}
      ${makeTab('VIBRATO EXERCISE', [
        ['B','---7~~~---9~~~---7~~~---5~~~'],
        ['G','-----------------------------'],
      ], 'Hold each note, apply wrist-rotation vibrato. Consistent, even oscillation.', 'Rotate wrist (not just finger). Think: turning a key in a lock.')}
      <p class="prose">Hold a note after bending, then apply vibrato. This is the most emotional sound in metal lead playing. It requires strong finger pressure and controlled wrist motion.</p>
    `
  },
  {
    icon: '////',
    title: 'Economy & Alternate Picking',
    sub: 'PICKING EFFICIENCY AT SPEED',
    badge: 'INTERMEDIATE',
    content: `
      <p class="prose" style="margin-top:14px"><strong>Alternate picking:</strong> Strictly down-up-down-up on every note. Metronomic and mechanical. Best for scales and single-string runs. <strong>Economy picking:</strong> When crossing strings in the same direction, continue that motion — avoids string-crossing inefficiency.</p>
      ${makeTab('ALTERNATE PICKING — SCALE RUN', [
        ['A','<span class="h">5</span>-<span class="h">7</span>-<span class="h">8</span>---'],
        ['E','----------<span class="h">5</span>-<span class="h">7</span>---'],
        ['A','------------------<span class="h">5</span>-<span class="h">7</span>-<span class="h">8</span>'],
      ], 'Down-Up-Down · Down-Up-Down-Up — strict alternating', 'Never break the alternating pattern. If you stumble, slow down.')}
      ${makeTab('ECONOMY PICKING — STRING CROSSING', [
        ['A','<span class="h">5</span>-<span class="h">7</span>-<span class="h">8</span>--'],
        ['E','--------<span class="h">5</span>- (down after the 8 above, since you\'re crossing down)'],
      ], 'When moving to a lower string, continue the down stroke. No wasted motion.')}
    `
  },
  {
    icon: '✺',
    title: 'Pinch Harmonics',
    sub: 'THE SQUEAL · DEATHCORE SIGNATURE',
    badge: 'FUN',
    badgeColor: 'gold',
    content: `
      <p class="prose" style="margin-top:14px">Pinch harmonics (squeals) are that high-pitched squeal sound ubiquitous in deathcore. Created by catching the string with your thumb right after the pick.</p>
      <ul class="dot-list">
        <li><strong>Grip:</strong> Hold the pick so very little pick protrudes — your thumb should almost touch the string when you pick.</li>
        <li><strong>Motion:</strong> Pick the string normally, then immediately catch it with the fleshy side of your thumb. The thumb "chokes" the harmonic.</li>
        <li><strong>Position:</strong> The sweet spot changes depending on where you pick along the string. Try picking near the bridge, then gradually move toward the neck until you hear the squeal.</li>
        <li><strong>With bends:</strong> Pinch harmonic on a bent note = the classic deathcore scream. Try it on string 2, fret 9, bend up a whole step.</li>
      </ul>
      ${makeTab('PINCH HARMONIC EXERCISE', [
        ['B','---9<span class="h">P.H.</span>~~~---12<span class="h">P.H.</span>~~~'],
        ['G','--------------------------------'],
      ], 'P.H. = pinch harmonic. Vibrato (~~~) after for the full squeal effect', 'High-gain amp or dist pedal is required. Pinch harmonics are almost inaudible clean.')}
    `
  }
];

// ── PROGRESS ──
const skillsData = [
  { label: 'Chromatic/Warmup', pct: 20 },
  { label: 'Palm Muting', pct: 20 },
  { label: 'String Muting', pct: 10 },
  { label: 'Alternate Pick', pct: 15 },
  { label: 'Natural Minor', pct: 20 },
  { label: 'Phrygian', pct: 0 },
  { label: 'Harmonic Minor', pct: 0 },
  { label: 'Gallop Rhythm', pct: 10 },
  { label: 'Hammer/Pull', pct: 10 },
  { label: 'Sweep Arpeggios', pct: 0 },
  { label: 'Bends & Vibrato', pct: 0 },
  { label: 'Pinch Harmonics', pct: 0 },
];

const milestonesData = [
  { title: 'Month 1', desc: 'Play A minor scale cleanly ascending + descending. Execute palm-muted chug riff on string 7 at 100 BPM.' },
  { title: 'Month 2', desc: 'Execute forward gallop at 120 BPM. Complete one full beginner song. Begin 3-string arpeggio picking.' },
  { title: 'Month 3', desc: 'Know Natural Minor in 2 positions. Introduce Phrygian. Legato hammer/pull-off runs.' },
  { title: 'Month 4', desc: '5-string sweep arpeggio at 80 BPM cleanly. Learn Harmonic Minor scale. Know 3 songs.' },
  { title: 'Month 5', desc: 'Improvise freely over an A minor drone. String 7 riffs at 160 BPM. Begin pinch harmonics.' },
  { title: 'Month 6', desc: 'Record yourself. Write an original 8-bar riff. Play a full song at performance speed without stopping.' },
];

const achievementsData = [
  { icon: '🔥', name: 'First Blood', desc: '1 day streak', prog: 'streak', threshold: 1 },
  { icon: '💀', name: 'Chug Lord', desc: '100+ palm-muted notes', prog: 'muting', threshold: 50 },
  { icon: '⚡', name: 'Speed Demon', desc: '150+ BPM metronome', prog: 'altpick', threshold: 70 },
  { icon: '🌑', name: 'Scale Master', desc: 'Natural Minor at 100%', prog: 'minor', threshold: 100 },
  { icon: '◈', name: 'Sweep Initiate', desc: 'Arpeggio > 40%', prog: 'sweep', threshold: 40 },
  { icon: '🎸', name: 'The Riff Wizard', desc: 'Write original riff', prog: null, threshold: null },
  { icon: '⏱', name: 'Consistent', desc: '7-day streak', prog: 'streak', threshold: 7 },
  { icon: '👑', name: 'Six Month Beast', desc: 'All milestones done', prog: null, threshold: null },
];

// ── ROADMAP ──
const roadmapData = [
  {
    num: '01',
    title: 'Ear Training Module',
    desc: 'Play a random note via Web Audio API — you guess it. Then identify intervals (a perfect 5th vs a tritone). Then chord quality (major vs minor vs diminished). This is the highest-leverage skill gap for beginners: they learn shapes but not sounds. Without ear training you\'re forever dependent on tabs. With it, you can learn songs by listening and start writing your own music.',
    tags: [['HIGH IMPACT','impact'],['MEDIUM EFFORT','effort'],['INTERACTIVE','type']]
  },
  {
    num: '02',
    title: 'Speed Trainer — Ramp Mode',
    desc: 'Auto-incrementing metronome: pick a technique, set a start BPM, end BPM, and increment step. The metronome automatically ratchets up every 60 seconds. Visual indicator shows your "clean threshold" — the last BPM where you confirmed zero errors. Gamifies the plateau-breaking process and removes the mental overhead of manually bumping the click.',
    tags: [['HIGH IMPACT','impact'],['LOW EFFORT','effort'],['GAMIFICATION','type']]
  },
  {
    num: '03',
    title: 'Backing Drone Generator',
    desc: 'Generate a sustained A drone note + simple kick/snare pattern using the Web Audio API — right in the browser, no files needed. Practicing scales and arpeggios over a real pulse is 10x more musical than silence. Add: root note selection (A to G#), tempo, "deathcore feel" checkbox (heavy low-pass EQ on the drone, double-kick pattern). This is the single biggest "fun factor" improvement possible.',
    tags: [['HIGH IMPACT','impact'],['MEDIUM EFFORT','effort'],['AUDIO','type']]
  },
  {
    num: '04',
    title: 'Song Difficulty Library',
    desc: 'Curated list of 30 deathcore songs sorted by difficulty (Beginner / Intermediate / Advanced), with: key, tuning, main techniques required, estimated hours to learn, YouTube link, and free tab link. Decision paralysis is a real problem — "what should I learn next?" kills momentum. A vetted library removes this entirely. Include notes like "best song for gallop practice" or "first sweep arpeggio song".',
    tags: [['HIGH IMPACT','impact'],['LOW EFFORT','effort'],['REFERENCE','type']]
  },
  {
    num: '05',
    title: 'Riff Builder & Progression Explorer',
    desc: 'Select a scale → see which chords naturally occur in it → click a progression (i–bVII–bVI–V is deathcore gold) → see which voicings work in Drop A. This bridges the gap between "I know scales" and "I can write riffs." Most beginners never make this connection. Add a "common deathcore progressions" preset list and a "what notes can I use over this chord" explainer.',
    tags: [['HIGH IMPACT','impact'],['HIGH EFFORT','effort'],['CREATIVE','type']]
  },
  {
    num: '06',
    title: 'Record & Playback — In Browser',
    desc: 'Use the MediaRecorder API to let users record a short clip (30–60s) directly in the app, then play it back immediately. Self-recording is one of the most powerful feedback tools in music — you hear things your brain filters out while playing. Add: "compare to last session" feature, basic waveform display, and a notes field to annotate what you hear.',
    tags: [['HIGH IMPACT','impact'],['MEDIUM EFFORT','effort'],['AUDIO','type']]
  },
  {
    num: '07',
    title: 'Interval Recognition Quiz',
    desc: 'Two notes play in sequence — you identify the interval (minor 2nd, perfect 5th, tritone, etc.). Start with just 3 intervals, expand as you progress. Display the interval on the fretboard visually. This directly addresses the most common theory gap: players know note names but can\'t hear intervals. The tritone (b5) is especially important for deathcore — it\'s the "devil\'s interval".',
    tags: [['HIGH IMPACT','impact'],['MEDIUM EFFORT','effort'],['QUIZ','type']]
  },
  {
    num: '08',
    title: 'Interactive 7-String Chord Identifier',
    desc: 'Tap any frets on an interactive 7-string grid and instantly see the chord name, which scale it belongs to, and related chords. Reverse-engineers what you\'re already playing. Massive for beginners who stumble onto good voicings and have no idea what they found. Add: "save voicing to notepad" button and "similar dark voicings" suggestions.',
    tags: [['MEDIUM IMPACT','impact'],['MEDIUM EFFORT','effort'],['CREATIVE','type']]
  },
  {
    num: '09',
    title: 'Weekly Challenge System',
    desc: 'A new challenge each week: "Play the gallop pattern at 140 BPM for 90 seconds without errors" or "Learn the verse riff of [song] by Friday." Challenges unlock badge variants and contribute to streak. Checkbox-style completion. Optional: AI-generated custom challenge based on your current progress scores. Gamification keeps practice sessions purposeful when motivation is low.',
    tags: [['MEDIUM IMPACT','impact'],['LOW EFFORT','effort'],['GAMIFICATION','type']]
  },
  {
    num: '10',
    title: 'AI Practice Journal Coach',
    desc: 'After a session, type 2–3 sentences in the notepad about what you worked on and what felt hard. An AI analyzes it and responds with: what to focus on next session, one specific exercise to address the weak point, and a motivational note. Turns passive logging into an active conversation with a coach. The AI already exists here — this is just routing notepad content through a structured prompt.',
    tags: [['HIGH IMPACT','impact'],['LOW EFFORT','effort'],['AI-POWERED','type']]
  },
  {
    num: '11',
    title: 'Fretboard Note Flashcards',
    desc: 'A fret position lights up — you say the note name out loud, then click to reveal. Track which positions you always get right vs which you blank on. Full fretboard knowledge (knowing that fret 8 on string 6 is C) transforms how you think about guitar. Most players never develop this; it\'s a massive edge for improvisation and communication with other musicians.',
    tags: [['HIGH IMPACT','impact'],['LOW EFFORT','effort'],['QUIZ','type']]
  },
  {
    num: '12',
    title: 'Tone & Gear Guide for Drop A',
    desc: 'Specific settings: what amp sim or pedal to use, EQ curve for deathcore (high-pass at 80Hz, mid scoop at 400Hz, presence boost at 3kHz), pick recommendations, string gauges for Drop A (min .010 for strings 1–6, .070–.074 for string 7). Beginners often spend months fighting their tone instead of practicing — a clear "this is what the genre sounds like and why" guide is genuinely valuable.',
    tags: [['MEDIUM IMPACT','impact'],['LOW EFFORT','effort'],['REFERENCE','type']]
  }
];

/* ═══════════════════════════════════════
   FRETBOARD SVG RENDERER
═══════════════════════════════════════ */
function renderFretboard(scaleId) {
  const svg = document.getElementById('fretboard-svg');
  if (!svg) return;
  const scale = scalesData.find(s => s.id === scaleId) || scalesData[0];

  // ── Layout constants ──────────────────────────────────────
  const strings = 7, frets = 12;
  const W = 720, H = 230;
  const ML = 36, MR = 16, MT = 44, MB = 26; // margins (extra top for open note markers)
  const fw = (W - ML - MR) / frets;
  const sh = (H - MT - MB) / (strings - 1);
  svg.setAttribute('viewBox', '0 0 ' + W + ' ' + H);

  // ── Correct open-string semitones (Drop A 7-string) ──────
  // Display: string 0 = HIGH e (E4=4), string 6 = LOW A7 (A1=9)
  // Low to high display: A7 at bottom, e at top
  const strNames = ['e','B','G','D','A','E','A7'];
  // Semitones mod 12: E=4, B=11, G=7, D=2, A=9, E=4, A=9
  const strSemi  = [4, 11, 7, 2, 9, 4, 9];

  const rootSemi = 9; // A

  // ── NOTE NAMES for tooltip ────────────────────────────────
  const noteNames = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];

  let html = '';

  // Background
  html += `<rect x="0" y="0" width="${W}" height="${H}" fill="#060610" rx="8"/>`;

  // ── Fretboard body ────────────────────────────────────────
  html += `<rect x="${ML}" y="${MT}" width="${W-ML-MR}" height="${H-MT-MB}" fill="#0d0b1a" rx="2"/>`;

  // Fret position markers (dots on fretboard)
  [3,5,7,9].forEach(f => {
    const x = ML + (f - 0.5) * fw;
    const y = MT + (H-MT-MB)/2;
    html += `<circle cx="${x}" cy="${y}" r="4" fill="#1a1830" opacity="0.8"/>`;
  });
  // Double dot at 12
  const x12 = ML + 11.5 * fw;
  [-1,1].forEach(off => {
    html += `<circle cx="${x12}" cy="${MT + (H-MT-MB)/2 + off*18}" r="4" fill="#1a1830" opacity="0.8"/>`;
  });

  // Fret lines + numbers
  for (let f = 0; f <= frets; f++) {
    const x = ML + f * fw;
    if (f === 0) {
      // Nut — thick, highlighted
      html += `<rect x="${x-2}" y="${MT}" width="4" height="${H-MT-MB}" fill="#8b5e3c" rx="1"/>`;
    } else {
      html += `<line x1="${x}" y1="${MT}" x2="${x}" y2="${H-MB}" stroke="#2a2840" stroke-width="1"/>`;
    }
    // Fret number above
    if ([1,3,5,7,9,12].includes(f)) {
      const labelX = ML + (f - 0.5) * fw;
      html += `<text x="${labelX}" y="${MT-8}" fill="#44445a" font-size="10" text-anchor="middle" font-family="ui-monospace,monospace" font-weight="600">${f}</text>`;
    }
  }

  // ── String lines ──────────────────────────────────────────
  for (let s = 0; s < strings; s++) {
    const y = MT + s * sh;
    const strokeW = 0.5 + s * 0.35;
    const brightness = Math.round(50 + s * 8);
    html += `<line x1="${ML}" y1="${y}" x2="${W-MR}" y2="${y}" stroke="rgb(${brightness},${brightness-5},${brightness+20})" stroke-width="${strokeW}"/>`;
    // String label left
    html += `<text x="${ML-8}" y="${y+4}" fill="#6a6484" font-size="10" text-anchor="middle" font-family="ui-monospace,monospace" font-weight="700">${strNames[s]}</text>`;
  }

  // ── Scale degree colors ───────────────────────────────────
  const degreeColors = {
    0: { fill: scale.color || '#7720cc', stroke: '#fff', label: 'R' },        // Root
    1: { fill: '#2a3a6a', stroke: '#5a7aaa', label: '2' },
    2: { fill: '#1e3a2a', stroke: '#4a8a5a', label: '3' },
    3: { fill: '#2a2a4a', stroke: '#5a5aaa', label: '4' },
    4: { fill: '#1e2e3a', stroke: '#4a7a9a', label: '5' },
    5: { fill: '#3a2a1a', stroke: '#9a7a4a', label: '6' },
    6: { fill: '#3a1e2a', stroke: '#9a4a6a', label: '7' },
  };

  // ── Place note dots ───────────────────────────────────────
  scale.dots.forEach((interval, degree) => {
    const targetSemi = (rootSemi + interval) % 12;
    for (let s = 0; s < strings; s++) {
      const y = MT + s * sh;
      for (let f = 0; f <= frets; f++) {
        const noteSemi = (strSemi[s] + f) % 12;
        if (noteSemi !== targetSemi) continue;

        const isRoot = degree === 0;
        const dc = degreeColors[degree] || degreeColors[1];
        const r = isRoot ? 9 : 7;

        let cx, cy, openNote = false;
        if (f === 0) {
          // Open note — place ABOVE the nut, above fret area
          cx = ML - 18;
          cy = y;
          openNote = true;
        } else {
          cx = ML + (f - 0.5) * fw;
          cy = y;
        }

        // Shadow / glow for root
        if (isRoot) {
          html += `<circle cx="${cx}" cy="${cy}" r="${r+4}" fill="${dc.fill}" opacity="0.2"/>`;
        }
        html += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="${dc.fill}" stroke="${dc.stroke}" stroke-width="${isRoot ? 1.5 : 1}" opacity="0.95"/>`;
        // Label
        const label = isRoot ? 'R' : String(interval);
        html += `<text x="${cx}" y="${cy+3.5}" fill="#fff" font-size="${isRoot ? 8 : 7}" text-anchor="middle" font-family="ui-monospace,monospace" font-weight="700">${label}</text>`;

        // Open note indicator line from nut
        if (openNote) {
          html += `<line x1="${ML-9}" y1="${cy}" x2="${ML-2}" y2="${cy}" stroke="${dc.fill}" stroke-width="1" stroke-dasharray="2,2"/>`;
        }
      }
    }
  });

  // ── Legend ────────────────────────────────────────────────
  const legendY = H - 8;
  const legendItems = [
    { color: scale.color || '#7720cc', label: 'Root (R)' },
    { color: '#4a6a9a', label: 'Scale tones (interval #)' },
  ];
  legendItems.forEach((li, i) => {
    const lx = ML + i * 160;
    html += `<circle cx="${lx+6}" cy="${legendY}" r="5" fill="${li.color}"/>`;
    html += `<text x="${lx+15}" y="${legendY+4}" fill="#5a5470" font-size="9" font-family="ui-monospace,monospace">${li.label}</text>`;
  });
  // "○ = open string" label
  html += `<text x="${ML + 330}" y="${legendY+4}" fill="#5a5470" font-size="9" font-family="ui-monospace,monospace">○ left of nut = open string</text>`;

  svg.innerHTML = html;
}

/* ═══════════════════════════════════════
   SCALES PAGE INIT
═══════════════════════════════════════ */
function initScales() {
  const pills = document.getElementById('scale-pills');
  pills.innerHTML = scalesData.map(s =>
    `<div class="scale-pill ${s.id === 'minor' ? 'active' : ''}" onclick="selectScale('${s.id}', this)">${s.name}</div>`
  ).join('');

  buildCollapse('scales-group', scalesData.map(s => ({
    icon: s.icon,
    title: s.title,
    sub: s.sub,
    badge: s.badge,
    badgeColor: s.badgeColor,
    content: s.content
  })));

  renderFretboard('minor');
}

function selectScale(id, el) {
  document.querySelectorAll('.scale-pill').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  renderFretboard(id);
}

/* ═══════════════════════════════════════
   SESSION TIMER
═══════════════════════════════════════ */
const presets = {
  quick: [
    { name: 'Chromatic Warmup', mins: 3, color: '#3d0870', bpm: 60, skill: 'Chromatic/Warmup',
      detail: '1-2-3-4 on all 7 strings starting at fret 1. One finger per fret — index on 1, middle on 2, ring on 3, pinky on 4. Alternate pick every note. Unused fingers hover 5mm above strings, never splayed. Move string by string without rushing. This warms the tendons and sets your pick-attack consistency before any heavy technique.' },
    { name: 'Scale Practice', mins: 7, color: '#7720cc', bpm: 80, skill: 'Natural Minor',
      detail: 'A natural minor position 1 ascending and descending at 80 BPM. One note per click, no rushing. Name each note aloud as you play it — muscle memory AND fretboard knowledge at once. When clean in both directions: practice in thirds (A-C, B-D, C-E). These sound musical immediately.' },
    { name: 'Song Work', mins: 10, color: '#c8883a', bpm: 100, skill: 'Palm Muting',
      detail: 'Apply everything you warmed up to an actual song or riff. No song yet? Practice Am5 to G5 to F5 transitions at 100 BPM in palm-muted 16th notes. The palm stays on the bridge through every chord change — fretting hand moves while pick hand stays planted.' },
  ],
  deep: [
    { name: 'Chromatic Warmup', mins: 5, color: '#3d0870', bpm: 60, skill: 'Chromatic/Warmup',
      detail: '1-2-3-4 across all 7 strings, two full passes in 5 minutes. Use this to set your hand position for the session — check thumb placement (behind the middle finger, on the neck back), wrist angle, and pick grip. The warmup is your quality control checkpoint for everything that follows.' },
    { name: 'Scale Deep Dive', mins: 10, color: '#7720cc', bpm: 75, skill: 'Natural Minor',
      detail: 'First 5 minutes: A natural minor position 1 in quarter notes at 75 BPM. Second 5 minutes: the scale in thirds — every other degree. A-C, B-D, C-E. These interval patterns sound immediately musical and train your ear to hear the scale, not just execute it mechanically.' },
    { name: 'Arpeggio Practice', mins: 10, color: '#4a7a9a', bpm: 65, skill: 'Sweep Arpeggios',
      detail: '3-string Am sweep only: A (open) to D (fret 2) to G (fret 2), down-sweep. At 65 BPM you have time to be conscious of every lift. Each finger must lift the INSTANT its string sounds — not when the next lands. That lift is what separates sweeping from strumming. 20 perfect reps before adding the turnaround.' },
    { name: 'Rhythm Drills', mins: 10, color: '#c8883a', bpm: 100, skill: 'Gallop Rhythm',
      detail: 'Forward gallop (D-DU) on string 7 for 8 bars, then reverse gallop (DU-D) for 8 bars, then switch mid-phrase without stopping. The seam between patterns is your entire focus. Record yourself — if the transition sounds even, you are there.' },
    { name: 'Song Work', mins: 10, color: '#4a9a4a', bpm: 120, skill: 'Alternate Pick',
      detail: 'Full song section at performance BPM, no stops. Play through every mistake. The goal is performance stamina — quality maintained across the full duration. Stop only at natural section breaks. Never stop mid-phrase in this block.' },
  ],
  tech: [
    { name: 'Chromatic Warmup', mins: 5, color: '#3d0870', bpm: 60, skill: 'Chromatic/Warmup',
      detail: '1-2-3-4 across all 7 strings at 60 BPM. Use this specifically to check your fretting hand position: thumb behind the neck, fingertips (not pads) on strings, knuckles parallel to fretboard. Fix any tension you feel immediately. Tension during the warmup becomes injury during the session.' },
    { name: 'Alternate Picking', mins: 8, color: '#7720cc', bpm: 90, skill: 'Alternate Pick',
      detail: 'String 7, strict 16th-note alternate picking. Set a 2-minute timer and count errors — any uneven note, direction mistake, or pressure change. Then string 6 for 2 minutes. Repeat. Your score: total errors in 8 minutes. Write it down. This is the most important technique for deathcore rhythm and must be trained with scientific precision.' },
    { name: 'Legato Exercises', mins: 8, color: '#4a7a9a', bpm: 70, skill: 'Hammer/Pull',
      detail: '5h7p5 loop on strings 5 and 4 at 70 BPM. Every legato note must reach 90% the volume of a picked note — anything quieter means insufficient hammer force or wrong pull-off angle. The pull-off pulls the string sideways not straight up. Work this until all 3 notes are indistinguishable in volume.' },
    { name: 'Technique Focus', mins: 9, color: '#c8883a', bpm: 80, skill: 'Bends & Vibrato',
      detail: 'Whole-step bends on string 3, fret 7. Sing the target pitch (fret 9) before bending to it — this trains pitch accuracy. Use your ring finger backed by middle and index. Vibrato: wrist rotation (not finger wiggling), 3mm oscillation, minimum 4 cycles per second. These are the two techniques that make leads sound professional.' },
  ]
};

/* skill → exercisesBank key for block detail content */
const skillBankMap = {
  'Chromatic/Warmup':  'Fretting Hand Posture — THUMB · CURVE · 1-2-3-4',
  'Palm Muting':       'Palm Muting & The Chug — THE DEATHCORE HEARTBEAT',
  'String Muting':     'Palm Muting & The Chug — THE DEATHCORE HEARTBEAT',
  'Alternate Pick':    'Gallop & Rhythm Patterns — FORWARD & REVERSE GALLOP',
  'Gallop Rhythm':     'Gallop & Rhythm Patterns — FORWARD & REVERSE GALLOP',
  'Natural Minor':     'Natural Minor — A · C · D · E · F · G · A',
  'Phrygian':          'Phrygian — bII · FLAT 2ND · SPANISH FLAVOUR',
  'Harmonic Minor':    'Harmonic Minor — ROOT · 2 · b3 · 4 · 5 · b6 · 7',
  'Hammer/Pull':       'Hammer-ons & Pull-offs — LEGATO TECHNIQUE',
  'Sweep Arpeggios':   'Introduction to Sweep Picking — ONE DIRECTIONAL MOTION',
  'Bends & Vibrato':   'Fretting Hand Posture — THUMB · CURVE · 1-2-3-4',
  'Pinch Harmonics':   'Palm Muting & The Chug — THE DEATHCORE HEARTBEAT',
};

/* registry for "Add to Session" exercise data */
const pendingEx = {};
let pendingExN = 0;
function registerEx(name, bpm, skill, detail, mins, color) {
  const k = 'ex_' + (pendingExN++);
  pendingEx[k] = { name, bpm: parseInt(bpm)||80, skill: skill||null, detail: detail||'', mins: parseInt(mins)||8, color: color||'#7720cc' };
  return k;
}
function addExerciseToSession(key, minsOverride) {
  const ex = pendingEx[key];
  if (!ex) return;
  const m = parseInt(minsOverride) || ex.mins;
  sessionBlocks.push({ name: ex.name, mins: m, bpm: ex.bpm, skill: ex.skill, detail: ex.detail, color: ex.color, secsLeft: m * 60, done: false });
  renderBlocks();
  updateTimerDisplay();
  showToast('ADDED · ' + ex.name.toUpperCase().slice(0,36));
}
function showToast(msg) {
  document.querySelectorAll('.sess-toast').forEach(t => t.remove());
  const t = document.createElement('div');
  t.className = 'sess-toast'; t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => { t.style.transition = 'opacity 0.35s'; t.style.opacity = '0'; setTimeout(() => t.remove(), 360); }, 1800);
}
function buildAddToSessFooter(name, bpm, skill, detail, mins, color) {
  const k = registerEx(name, bpm, skill, detail, mins, color);
  return `<div class="sess-add-footer">
    <span class="sess-add-label">▶ Add to Session:</span>
    <div class="sess-add-mins"><input class="sess-add-mins-input" id="atsm-${k}" type="number" value="${mins||8}" min="1" max="60"><span class="sess-add-mins-lbl">min</span></div>
    <button class="add-to-sess-btn" onclick="addExerciseToSession('${k}', document.getElementById('atsm-${k}').value)">Add to Session</button>
  </div>`;
}

let expandedBlockIdx = -1;
let sessionBlocks = [];
let sessRunning = false;
let sessTimer = null;
let currentBlockIdx = 0;
let blockSecsLeft = 0;
let totalSecsLogged = 0;

function loadPreset(name) {
  sessionBlocks = presets[name].map(b => ({ ...b, secsLeft: b.mins * 60, done: false }));
  currentBlockIdx = 0;
  selectedBlockIdx = 0;  // auto-expand first block
  const el = document.getElementById('active-plan-name');
  if (el) el.textContent = '';
  // Auto-set BPM to first block
  const first = sessionBlocks[0];
  if (first && first.bpm) updateBPM(first.bpm);
  renderBlocks();
  updateTimerDisplay();
  showToast('Session loaded · tap any block for details');
}

let selectedBlockIdx = null;

function renderBlocks() {
  const container = document.getElementById('session-blocks');
  container.innerHTML = sessionBlocks.map((b, i) => {
    const isActive   = i === currentBlockIdx && sessRunning;
    const isSelected = i === selectedBlockIdx;
    const isDone     = b.done;
    const classes = [
      'session-block',
      isActive   ? 'active-block' : '',
      isSelected ? 'selected-block' : '',
      isDone     ? 'done-block' : '',
      isSelected ? 'expanded' : '',
    ].filter(Boolean).join(' ');

    const detailHtml = b.detail ? `
      <div class="block-detail">
        <div class="block-detail-inner">
          <div class="block-detail-text">${b.detail}</div>
          <div class="block-detail-actions">
            <button class="block-jump-btn" onclick="event.stopPropagation(); jumpToBlock(${i})">
              ▶ ${isActive ? 'Current Block' : 'Jump Here + Set BPM'}
            </button>
            <button class="block-set-metro-btn" onclick="event.stopPropagation(); setBlockMetro(${i})">
              ♩ Set ${b.bpm || 80} BPM
            </button>
          </div>
        </div>
      </div>` : '';

    return `<div class="${classes}" id="sblock-${i}" onclick="selectBlock(${i})">
      <div class="block-header">
        <div class="block-color" style="background:${b.color}; height:${detailHtml ? 32 : 28}px"></div>
        <div class="block-info">
          <div class="block-name">${isDone ? '✓ ' : ''}${b.name}</div>
          <div class="block-meta">
            <span class="block-bpm">♩ ${b.bpm || 80} BPM</span>
            <span class="block-skill">${b.skill ? '· ' + b.skill : ''}</span>
            <span style="font-family:var(--mono);font-size:9px;color:var(--dim)">· ${b.mins}min</span>
          </div>
        </div>
        ${isDone
          ? `<div class="block-timer-val" style="color:var(--dim);font-size:16px">✓</div>`
          : `<div class="block-timer-val">${fmtTime(b.secsLeft)}</div>`}
        ${detailHtml ? `<div class="block-chevron">▼</div>` : ''}
      </div>
      ${detailHtml}
    </div>`;
  }).join('');
  const total = sessionBlocks.reduce((s, b) => s + b.mins, 0);
  document.getElementById('session-total').textContent = `Total: ${total} minutes`;
}

function selectBlock(i) {
  const wasSelected = selectedBlockIdx === i;
  selectedBlockIdx = wasSelected ? null : i;
  renderBlocks();
  // If selecting (not deselecting), set metronome immediately
  if (!wasSelected) {
    const b = sessionBlocks[i];
    if (b && b.bpm) updateBPM(b.bpm);
  }
}

function jumpToBlock(i) {
  if (sessRunning) {
    // pause first
    clearInterval(sessTimer);
    sessRunning = false;
    const btn = document.getElementById('sess-start-btn');
    const lblEl = document.getElementById('sess-btn-label');
    if (btn) btn.classList.remove('running');
    if (lblEl) lblEl.textContent = '▶  START SESSION';
    syncSessionFab();
    if (metroRunning) toggleMetro();
  }
  currentBlockIdx = i;
  selectedBlockIdx = i;
  const b = sessionBlocks[i];
  if (b && b.bpm) {
    updateBPM(b.bpm);
    if (!metroRunning) toggleMetro();
  }
  updateTimerDisplay();
  renderBlocks();
  showToast('Block set · ' + (b.bpm || 80) + ' BPM · ready');
}

function setBlockMetro(i) {
  const b = sessionBlocks[i];
  if (b && b.bpm) {
    updateBPM(b.bpm);
    if (!metroRunning) toggleMetro();
    showToast('♩ ' + b.bpm + ' BPM set');
  }
}

function showToast(msg) {
  let t = document.getElementById('sess-toast');
  if (!t) {
    t = document.createElement('div');
    t.id = 'sess-toast';
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}

/* ─── ADD EXERCISE TO SESSION ─────────────────────────── */
function addExerciseToSession({ name, mins, bpm, skill, detail, color, btn }) {
  const block = {
    name: name || 'Custom Exercise',
    mins: mins || 5,
    bpm:  bpm  || 80,
    skill: skill || null,
    detail: detail || '',
    color: color || '#7720cc',
    secsLeft: (mins || 5) * 60,
    done: false
  };
  // If no session loaded, start a fresh one
  if (sessionBlocks.length === 0) {
    sessionBlocks = [block];
  } else {
    // Insert after current block (or append)
    const insertAt = Math.min(currentBlockIdx + 1, sessionBlocks.length);
    sessionBlocks.splice(insertAt, 0, block);
  }
  renderBlocks();
  updateTimerDisplay();
  // Visual feedback on button
  if (btn) {
    const orig = btn.innerHTML;
    btn.innerHTML = '✓ ADDED';
    btn.classList.add('added');
    setTimeout(() => { btn.innerHTML = orig; btn.classList.remove('added'); }, 2000);
  }
  showToast(block.name + ' added to session');
  // Auto-navigate to session tab briefly to show it was added, then come back
  // (don't navigate — just toast is enough)
}

/* Helper called from inline HTML buttons in generated content */
function addToSessionFromEl(el, name, mins, bpm, skill, detail) {
  addExerciseToSession({ name, mins, bpm: parseInt(bpm)||80, skill, detail, btn: el });
}

function fmtTime(secs) {
  const m = Math.floor(secs/60).toString().padStart(2,'0');
  const s = (secs%60).toString().padStart(2,'0');
  return `${m}:${s}`;
}

function updateTimerDisplay() {
  if (sessionBlocks.length === 0) return;
  const b = sessionBlocks[currentBlockIdx];
  if (!b) { document.getElementById('sess-timer-val').textContent = '00:00'; return; }
  document.getElementById('sess-timer-val').textContent = fmtTime(b.secsLeft);
  document.getElementById('sess-timer-label').textContent = b ? b.name : '';
}

function toggleSession() {
  if (sessionBlocks.length === 0) { loadPreset('deep'); setTimeout(()=>toggleSession(),50); return; }
  const btn = document.getElementById('sess-start-btn');
  const lblEl = document.getElementById('sess-btn-label');
  if (sessRunning) {
    clearInterval(sessTimer);
    sessRunning = false;
    if (btn) btn.classList.remove('running');
    if (lblEl) lblEl.textContent = '▶  RESUME SESSION';
    else if (btn) btn.textContent = 'Resume';
    // pause metronome too
    if (metroRunning) toggleMetro();
    syncSessionFab();
  } else {
    sessRunning = true;
    if (btn) btn.classList.add('running');
    if (lblEl) lblEl.textContent = '■  PAUSE SESSION';
    else if (btn) btn.textContent = 'Pause';
    syncSessionFab();
    // sync metronome to current block BPM and auto-start
    const startBlock = sessionBlocks[currentBlockIdx];
    if (startBlock && startBlock.bpm) {
      updateBPM(startBlock.bpm);
      if (!metroRunning) toggleMetro();
    }
    sessTimer = setInterval(() => {
      const b = sessionBlocks[currentBlockIdx];
      if (!b) { clearInterval(sessTimer); sessRunning = false; syncSessionFab(); return; }
      b.secsLeft--;
      totalSecsLogged++;
      updateTimerDisplay();
      updateFabTimer();
      renderBlocks();
      saveHomeStats();
      saveDailyStats();
      // Continuous micro-increment: +0.15% per minute (~0.0025% per second) per skill
      if (b.skill && totalSecsLogged % 12 === 0) {
        autoProgressSkill(b.skill, 0.3);
      }
      if (b.secsLeft <= 0) {
        b.done = true;
        // Block completion bonus — bigger jump on finish
        if (b.skill) autoProgressSkill(b.skill, 6);
        currentBlockIdx++;
        if (currentBlockIdx >= sessionBlocks.length) {
          clearInterval(sessTimer); sessRunning = false; syncSessionFab(); saveSessionStats();
          if (metroRunning) toggleMetro();
          document.getElementById('sess-timer-label').textContent = 'Session Complete! 🔥';
          if (lblEl) lblEl.textContent = '▶  START SESSION';
          else if (btn) btn.textContent = 'Start Session';
          if (btn) btn.classList.remove('running');
          saveDailyStats();
          refreshHomeStats && refreshHomeStats();
        } else {
          // advance to next block — update BPM automatically + expand it
          const nextBlock = sessionBlocks[currentBlockIdx];
          if (nextBlock && nextBlock.bpm) updateBPM(nextBlock.bpm);
          selectedBlockIdx = currentBlockIdx;
          updateTimerDisplay();
        }
        renderBlocks();
      }
    }, 1000);
  }
}

/* ── AUTO PROGRESS TRACKING ─────────────────────── */
const pageSkillMap = {
  fundamentals: ['Chromatic/Warmup', 'Palm Muting', 'String Muting'],
  scales:        ['Natural Minor', 'Phrygian', 'Harmonic Minor'],
  arpeggios:     ['Sweep Arpeggios'],
  techniques:    ['Alternate Pick', 'Hammer/Pull', 'Bends & Vibrato', 'Pinch Harmonics'],
  riff:          ['Gallop Rhythm', 'Palm Muting'],
  theory:        ['Natural Minor', 'Phrygian'],
};
const visitedPages = new Set();

/* ═══════════════════════════════════════════════════════════════
   METRICS — fully auto-driven from sessions, visits, time
   progValues stores 0–100 for each skill.
   Sources of gain:
     • Completing a timed session block tagged to that skill (+increment)
     • Visiting a page that maps to skills (+2 per unique visit)
     • Per-minute accumulation while a session block runs (+0.15/min)
     • Riff lab sessions (+5 to Gallop Rhythm, Palm Muting)
     • Interval trainer correct answers (+1 to Natural Minor)
   Manual tap-to-cycle on progress page is preserved as override.
================================================================ */
function autoProgressSkill(skillLabel, increment) {
  const s = skillsData.find(s => s.label === skillLabel);
  if (!s) return;
  const cur = progValues[s.label] ?? s.pct;
  const next = Math.min(100, parseFloat((cur + increment).toFixed(2)));
  if (next <= cur) return;
  progValues[s.label] = next;
  saveProgress();
  // Live-update progress bars if visible
  const idx = skillsData.indexOf(s);
  const fill = document.getElementById('pf-' + idx);
  const pct  = document.getElementById('pp-' + idx);
  if (fill) fill.style.width = next + '%';
  if (pct)  pct.textContent  = Math.round(next) + '%';
  if (typeof buildAchievements === 'function') buildAchievements();
  if (typeof refreshHomeStats  === 'function') refreshHomeStats();
}

function trackPageVisit(pageId) {
  if (visitedPages.has(pageId)) return;
  visitedPages.add(pageId);
  const skills = pageSkillMap[pageId];
  if (skills) skills.forEach(sk => autoProgressSkill(sk, 2));
}

/* ── CONTEXT BAR (floating quick-start on every page) ── */
const contextSessions = {
  fundamentals: { name: 'Fundamentals Session', preset: 'tech', bpm: 60 },
  scales:        { name: 'Scale Fluency Session', plan: 1, bpm: 65 },
  arpeggios:     { name: 'Sweep Foundation Session', plan: 3, bpm: 30 },
  techniques:    { name: 'Technique Isolation Session', plan: 2, bpm: 60 },
  riff:          { name: 'Riff Practice Session', preset: 'quick', bpm: 90 },
  theory:        { name: 'Theory Into Practice Session', plan: 5, bpm: 70 },
  metronome:     { name: 'Rhythm Endurance Session', plan: 4, bpm: 80 },
  dailytip:      { name: 'Quick Practice Session', preset: 'quick', bpm: 80 },
};

function updateContextBar(pageId) {
  const bar = document.getElementById('context-bar');
  if (!bar) return;
  const ctx = contextSessions[pageId];
  const hidePages = new Set(['home','session','progress','review','notepad','roadmap']);
  if (!ctx || hidePages.has(pageId)) { bar.style.display = 'none'; return; }
  bar.style.display = 'flex';
  document.getElementById('ctx-label').textContent = ctx.name;
  document.getElementById('ctx-bpm').textContent = ctx.bpm + ' BPM';
}

function startContextSession(pageId) {
  const ctx = contextSessions[pageId];
  if (!ctx) return;
  if (ctx.plan !== undefined) loadFromPlan(sessionPlans[ctx.plan]);
  else loadPreset(ctx.preset);
  updateBPM(ctx.bpm);
  if (!metroRunning) toggleMetro();
  const navBtns = document.querySelectorAll('nav button');
  navBtns.forEach(b => b.classList.remove('active'));
  const sessionBtn = Array.from(navBtns).find(b => b.textContent === 'Session');
  if (sessionBtn) sessionBtn.classList.add('active');
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('session').classList.add('active');
  window.scrollTo(0,0);
  onPageOpen('session');
}

function resetSession() {
  clearInterval(sessTimer); sessRunning = false; syncSessionFab();
  currentBlockIdx = 0;
  selectedBlockIdx = sessionBlocks.length > 0 ? 0 : null;
  sessionBlocks.forEach(b => { b.secsLeft = b.mins * 60; b.done = false; });
  if (sessionBlocks.length > 0 && sessionBlocks[0].bpm) updateBPM(sessionBlocks[0].bpm);
  if (metroRunning) toggleMetro();
  renderBlocks(); updateTimerDisplay();
  const lblEl = document.getElementById('sess-btn-label');
  if (lblEl) lblEl.textContent = '▶  START SESSION';
}

/* ── LOG TIME MODAL ─────────────────────────────────────── */
let logMinsVal = 30;
function openLogTimeModal() {
  logMinsVal = 30;
  document.getElementById('log-mins-display').textContent = logMinsVal;
  const m = document.getElementById('log-time-modal');
  m.style.display = 'flex';
}
function closeLogTimeModal() {
  document.getElementById('log-time-modal').style.display = 'none';
}
function adjustLogMins(delta) {
  logMinsVal = Math.max(1, Math.min(240, logMinsVal + delta));
  document.getElementById('log-mins-display').textContent = logMinsVal;
}
function confirmLogTime() {
  totalSecsLogged += logMinsVal * 60;
  saveDailyStats();
  saveSessionStats();
  closeLogTimeModal();
  // Show brief confirmation
  const btn = document.getElementById('log-manual-btn');
  if (btn) {
    const orig = btn.textContent;
    btn.textContent = '✓ Logged!';
    btn.style.background = '#1a8c3a';
    setTimeout(() => { btn.textContent = orig; btn.style.background = ''; }, 2000);
  }
}

function skipBlock() {
  if (sessionBlocks.length === 0) return;
  sessionBlocks[currentBlockIdx].done = true;
  currentBlockIdx++;
  if (currentBlockIdx >= sessionBlocks.length) {
    currentBlockIdx = sessionBlocks.length - 1;
  } else {
    const nextB = sessionBlocks[currentBlockIdx];
    if (nextB && nextB.bpm) updateBPM(nextB.bpm);
  }
  updateTimerDisplay(); renderBlocks();
}

/* ═══════════════════════════════════════
   METRONOME
═══════════════════════════════════════ */
let audioCtx = null;
let metroRunning = false;
let nextNoteTime = 0;
let currentBeat = 0;
let beatsPerMeasure = 4;
let bpm = 80;
let metroTimeout;
let tapTimes = [];

function getACtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}
function playClick(time, accent) {
  const ctx = getACtx();
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.connect(g); g.connect(ctx.destination);
  o.frequency.value = accent ? 1400 : 900;
  g.gain.setValueAtTime(accent ? 0.7 : 0.35, time);
  g.gain.exponentialRampToValueAtTime(0.001, time + 0.07);
  o.start(time); o.stop(time + 0.08);
}
function flashBeat(b) {
  document.querySelectorAll('.beat-pip').forEach((d, i) => {
    d.classList.toggle('on', i === b);
    d.classList.toggle('accent', i === b && b === 0);
  });
  // Also update floating metronome popup pips
  document.querySelectorAll('#mp-beat-row .mp-pip').forEach((d, i) => {
    d.classList.toggle('on', i === b);
    d.classList.toggle('accent', i === b && b === 0);
  });
}
function scheduler() {
  const ctx = getACtx();
  while (nextNoteTime < ctx.currentTime + 0.1) {
    playClick(nextNoteTime, currentBeat === 0);
    const b = currentBeat;
    const d = (nextNoteTime - ctx.currentTime) * 1000;
    setTimeout(() => flashBeat(b), Math.max(0, d));
    nextNoteTime += 60 / bpm;
    currentBeat = (currentBeat + 1) % beatsPerMeasure;
  }
  metroTimeout = setTimeout(scheduler, 25);
}
function toggleMetro() {
  const btn = document.getElementById('metro-btn');
  const mpBtn = document.getElementById('mp-start-btn');
  const fabEl = document.getElementById('fab-metro');
  if (metroRunning) {
    clearTimeout(metroTimeout); metroRunning = false;
    btn.textContent = 'Start';
    btn.classList.remove('running');
    document.querySelectorAll('.beat-pip').forEach(d => d.classList.remove('on','accent'));
    document.querySelectorAll('#mp-beat-row .mp-pip').forEach(d => d.classList.remove('on','accent'));
    if (mpBtn) { mpBtn.textContent = '▶  START'; mpBtn.classList.remove('running'); }
    if (fabEl) fabEl.classList.remove('active-fab');
  } else {
    const ctx = getACtx();
    if (ctx.state === 'suspended') ctx.resume();
    metroRunning = true;
    nextNoteTime = ctx.currentTime + 0.05;
    currentBeat = 0;
    btn.textContent = 'Stop';
    btn.classList.add('running');
    if (mpBtn) { mpBtn.textContent = '■  STOP'; mpBtn.classList.add('running'); }
    if (fabEl) fabEl.classList.add('active-fab');
    scheduler();
  }
}
function updateBPM(v) {
  bpm = Math.min(240, Math.max(40, parseInt(v)));
  document.getElementById('bpm-display').textContent = bpm;
  document.getElementById('bpm-slider').value = bpm;
  // Sync floating popup
  const mpNum = document.getElementById('mp-bpm-display');
  const mpSlider = document.getElementById('mp-bpm-slider');
  if (mpNum) mpNum.textContent = bpm;
  if (mpSlider) mpSlider.value = bpm;
}
function changeBPM(d) { updateBPM(bpm + d); }
function setTS(b) {
  beatsPerMeasure = b;
  document.getElementById('ts-label').textContent = b + (b >= 6 ? '/8' : '/4');
  const row = document.getElementById('beat-row');
  row.innerHTML = Array(b).fill('<div class="beat-pip"></div>').join('');
  // Sync popup beat row
  const mpRow = document.getElementById('mp-beat-row');
  if (mpRow) mpRow.innerHTML = Array(b).fill('<div class="mp-pip"></div>').join('');
  currentBeat = 0;
}
function tapTempo() {
  const now = Date.now();
  tapTimes.push(now);
  if (tapTimes.length > 8) tapTimes.shift();
  if (tapTimes.length >= 2) {
    const intervals = [];
    for (let i = 1; i < tapTimes.length; i++) intervals.push(tapTimes[i] - tapTimes[i-1]);
    const avg = intervals.reduce((a,b) => a+b,0) / intervals.length;
    updateBPM(Math.round(60000 / avg));
  }
  const btn = document.getElementById('tap-btn');
  if (btn) { btn.classList.add('tapping'); setTimeout(() => btn.classList.remove('tapping'), 300); }
  const mpTap = document.getElementById('mp-tap-btn');
  if (mpTap) { mpTap.classList.add('tapping'); setTimeout(() => mpTap.classList.remove('tapping'), 300); }
}

/* ── BPM RAMP MODE ────────────────────────────────────── */
let rampState = { start:60, end:120, step:5, interval:30 };
let rampRunning = false;
let rampTimer = null;
let rampCountdown = 0;
let rampCountdownTimer = null;

function rampAdj(key, delta) {
  if (key === 'start')    rampState.start    = Math.min(240, Math.max(40,  rampState.start    + delta));
  if (key === 'end')      rampState.end      = Math.min(240, Math.max(40,  rampState.end      + delta));
  if (key === 'step')     rampState.step     = Math.min(20,  Math.max(1,   rampState.step     + delta));
  if (key === 'interval') rampState.interval = Math.min(300, Math.max(10,  rampState.interval + delta));
  document.getElementById('ramp-start-val').textContent    = rampState.start;
  document.getElementById('ramp-end-val').textContent      = rampState.end;
  document.getElementById('ramp-step-val').textContent     = rampState.step;
  document.getElementById('ramp-interval-val').textContent = rampState.interval;
}

function toggleRamp() {
  if (rampRunning) {
    clearTimeout(rampTimer); clearInterval(rampCountdownTimer);
    rampRunning = false;
    document.getElementById('ramp-start-btn').textContent = '▶ Start Ramp';
    document.getElementById('ramp-status').textContent = '';
    if (metroRunning) toggleMetro();
  } else {
    rampRunning = true;
    document.getElementById('ramp-start-btn').textContent = '■ Stop Ramp';
    updateBPM(rampState.start);
    if (!metroRunning) toggleMetro();
    scheduleNextRampStep();
  }
}

function scheduleNextRampStep() {
  if (!rampRunning) return;
  rampCountdown = rampState.interval;
  updateRampStatus();
  rampCountdownTimer = setInterval(() => {
    rampCountdown--;
    updateRampStatus();
    if (rampCountdown <= 0) {
      clearInterval(rampCountdownTimer);
      const nextBpm = bpm + rampState.step;
      if (nextBpm > rampState.end) {
        document.getElementById('ramp-status').textContent = `✓ Reached ${rampState.end} BPM — ramp complete!`;
        rampRunning = false;
        document.getElementById('ramp-start-btn').textContent = '▶ Start Ramp';
        if (metroRunning) toggleMetro();
      } else {
        updateBPM(nextBpm);
        scheduleNextRampStep();
      }
    }
  }, 1000);
}

function updateRampStatus() {
  const el = document.getElementById('ramp-status');
  if (el) el.textContent = `${bpm} BPM → +${rampState.step} in ${rampCountdown}s  (target: ${rampState.end})`;
}

function resetRamp() {
  clearTimeout(rampTimer); clearInterval(rampCountdownTimer);
  rampRunning = false;
  document.getElementById('ramp-start-btn').textContent = '▶ Start Ramp';
  document.getElementById('ramp-status').textContent = '';
  updateBPM(rampState.start);
  if (metroRunning) toggleMetro();
}

/* ── METRO TOGGLE FROM SESSION BAR ────────────────── */
function toggleMetroFromSession() {
  toggleMetro();
  const btn = document.getElementById('sess-metro-btn');
  if (btn) btn.textContent = metroRunning ? '■ Metro' : '♩ Metro';
}

/* ── PLAN BLOCK DETAIL MODAL ─────────────────────── */
function openPlanBlockModal(blockIdx, planObj) {
  const b = planObj.blocks[blockIdx];
  if (!b) return;
  document.getElementById('pbm-title').textContent = b.label;
  document.getElementById('pbm-meta').innerHTML = `
    <span class="pbm-badge" style="border-color:${b.color};color:${b.color}">${b.mins} MIN</span>
    <span class="pbm-badge" style="border-color:var(--gold);color:var(--gold)">♩ ${b.bpm||'—'} BPM</span>
    ${b.skill ? `<span class="pbm-badge" style="border-color:var(--wire);color:var(--dim)">${b.skill}</span>` : ''}`;
  document.getElementById('pbm-body').textContent = b.detail || b.label;
  const modal = document.getElementById('plan-block-modal');
  modal.style.display = 'flex';
}
function closePlanModal() {
  document.getElementById('plan-block-modal').style.display = 'none';
}

/* ═══════════════════════════════════════
   DAILY TIP
═══════════════════════════════════════ */
let tipCat = 'any';
let tipCount = 0;
let tipHistory = [];
const tipOrbs = { any:'✦', technique:'⊕', rhythm:'♩', scales:'≡', arpeggios:'◈', mindset:'◉', theory:'∿', gear:'⊞' };

function setTipCat(el) {
  document.querySelectorAll('.tip-filter-tag').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  tipCat = el.dataset.cat;
}
function fetchTip() {
  const btn = document.getElementById('regen-btn');
  const icon = document.getElementById('regen-icon');
  const text = document.getElementById('tip-inner');
  const cat  = document.getElementById('tip-cat-label');
  const orb  = document.getElementById('tip-orb');
  const mainBody = document.getElementById('tip-main-text');
  btn.disabled = true;
  icon.classList.add('spinning');
  mainBody && mainBody.classList.add('loading');

  const catKey = tipCat === 'any'
    ? ['technique','rhythm','scales','arpeggios','mindset','theory','gear'][Math.floor(Math.random()*7)]
    : tipCat;
  const bank = tipsBank[catKey] || tipsBank.technique;
  const tip = pickFrom(bank, 'tip_' + catKey);

  setTimeout(() => {
    text.textContent = tip;
    cat.textContent  = catKey.toUpperCase();
    orb.textContent  = tipOrbs[tipCat] || tipOrbs[catKey] || '✦';
    tipCount++;
    document.getElementById('tip-count').textContent = tipCount;
    const homeText = document.getElementById('home-tip-text');
    if (homeText) homeText.textContent = tip.substring(0,120) + (tip.length > 120 ? '...' : '');
    if (tipHistory.length >= 10) tipHistory.shift();
    tipHistory.push(tip.substring(0,80)+'...');
    renderTipHistory();
    btn.disabled = false;
    icon.classList.remove('spinning');
    mainBody && mainBody.classList.remove('loading');
  }, 300);
}
function addTipToSession(btn) {
  const tipText = document.getElementById('tip-inner')?.textContent || '';
  const catLabel = document.getElementById('tip-cat-label')?.textContent || 'Practice';
  if (!tipText || tipText.includes('Hit "New Tip"')) {
    fetchTip();
    showToast('Generating tip first...');
    return;
  }
  const bpmGuess = catLabel.toLowerCase().includes('rhythm') ? 100 :
                   catLabel.toLowerCase().includes('technique') ? 70 :
                   catLabel.toLowerCase().includes('scale') ? 75 : 80;
  const skillGuess = catLabel.toLowerCase().includes('rhythm') ? 'Gallop Rhythm' :
                     catLabel.toLowerCase().includes('scale') ? 'Natural Minor' :
                     catLabel.toLowerCase().includes('arpeg') ? 'Sweep Arpeggios' : 'Chromatic/Warmup';
  addExerciseToSession({ name: catLabel + ' — Daily Tip', mins: 5, bpm: bpmGuess, skill: skillGuess, detail: tipText, color: '#4a7a9a', btn });
}

function renderTipHistory() {
  if (!tipHistory.length) return;
  const wrap = document.getElementById('tip-history-wrap');
  const list = document.getElementById('tip-hist-list');
  wrap.style.display = 'block';
  list.innerHTML = [...tipHistory].reverse().map((t,i) =>
    `<div class="tip-hist-item"><span class="tip-hist-num">#${tipHistory.length-i}</span><span>${t}</span></div>`
  ).join('');
}

/* ═══════════════════════════════════════
   NOTEPAD
═══════════════════════════════════════ */
let noteTabs = [];
let activeNoteId = null;
let noteInited = false;
let noteSaveTimer = null;
const NOTE_KEY = 'grimoire-notes-v2';

function genId() { return 'n' + Date.now() + Math.random().toString(36).slice(2,5); }
async function loadNotes() {
  try {
    const r = await window.storage.get(NOTE_KEY);
    if (r?.value) { const d = JSON.parse(r.value); noteTabs = d.tabs||[]; activeNoteId = d.active||null; }
  } catch(e) {}
  if (!noteTabs.length) {
    noteTabs = [
      { id: genId(), name: 'Practice Log', content: '' },
      { id: genId(), name: 'Riff Ideas', content: '' },
      { id: genId(), name: 'Goals', content: '' },
    ];
  }
  if (!activeNoteId || !noteTabs.find(t=>t.id===activeNoteId)) activeNoteId = noteTabs[0].id;
  renderNoteTabs(); loadNoteTab();
}
async function saveNoteData() {
  const ta = document.getElementById('note-area');
  const tab = noteTabs.find(t=>t.id===activeNoteId);
  if (tab) tab.content = ta.value;
  try {
    await window.storage.set(NOTE_KEY, JSON.stringify({tabs:noteTabs,active:activeNoteId}));
    setSaved(true);
  } catch(e) { setSaved(false); }
}
function setSaved(ok) {
  document.getElementById('save-dot').className = 'saved-dot' + (ok?' ok':'');
  document.getElementById('save-txt').textContent = ok ? 'SAVED' : 'UNSAVED';
}
function renderNoteTabs() {
  const row = document.getElementById('note-tab-row');
  const addBtn = row.querySelector('.note-add-btn');
  row.querySelectorAll('.note-tab').forEach(t=>t.remove());
  noteTabs.forEach(tab => {
    const el = document.createElement('div');
    el.className = 'note-tab' + (tab.id===activeNoteId?' active':'');
    el.dataset.id = tab.id;
    const inp = document.createElement('input');
    inp.type='text'; inp.className='note-tab-input'; inp.value=tab.name;
    inp.maxLength=20; inp.readOnly=true;
    inp.ondblclick = ()=>{ inp.readOnly=false; inp.select(); };
    inp.onblur = ()=>{ inp.readOnly=true; tab.name=inp.value.trim()||'Untitled'; saveNoteData(); };
    inp.onkeydown = e=>{ if(e.key==='Enter') inp.blur(); e.stopPropagation(); };
    el.onclick = e=>{ if(e.target.classList.contains('note-tab-x')||e.target===inp) return; switchNote(tab.id); };
    el.appendChild(inp);
    if (noteTabs.length > 1) {
      const x = document.createElement('span');
      x.className='note-tab-x'; x.textContent='×';
      x.onclick=()=>closeNote(tab.id);
      el.appendChild(x);
    }
    row.insertBefore(el, addBtn);
  });
}
function switchNote(id) {
  const ta = document.getElementById('note-area');
  const cur = noteTabs.find(t=>t.id===activeNoteId);
  if (cur) cur.content = ta.value;
  activeNoteId = id;
  renderNoteTabs(); loadNoteTab(); saveNoteData();
}
function loadNoteTab() {
  const tab = noteTabs.find(t=>t.id===activeNoteId);
  const ta = document.getElementById('note-area');
  ta.value = tab ? tab.content : '';
  updateNoteStats(); setSaved(true);
}
function addTab() {
  const ta = document.getElementById('note-area');
  const cur = noteTabs.find(t=>t.id===activeNoteId);
  if (cur) cur.content = ta.value;
  const t = { id:genId(), name:'New Tab', content:'' };
  noteTabs.push(t); activeNoteId = t.id;
  renderNoteTabs(); loadNoteTab(); saveNoteData();
  setTimeout(()=>{ const a=document.querySelector('.note-tab.active .note-tab-input'); if(a){a.readOnly=false;a.select();} },50);
}
function closeNote(id) {
  if (noteTabs.length<=1) return;
  const idx = noteTabs.findIndex(t=>t.id===id);
  noteTabs.splice(idx,1);
  if (activeNoteId===id) activeNoteId=noteTabs[Math.min(idx,noteTabs.length-1)].id;
  renderNoteTabs(); loadNoteTab(); saveNoteData();
}
function onNoteType() {
  setSaved(false); updateNoteStats();
  scheduleNoteSave(); // debounced 800ms
}
function updateNoteStats() {
  const ta = document.getElementById('note-area');
  const t = ta.value;
  const w = t.trim() ? t.trim().split(/\s+/).length : 0;
  document.getElementById('note-chars').textContent = t.length + ' ch';
  document.getElementById('note-words').textContent = w + ' words';
}
function fmt(before, after) {
  const ta = document.getElementById('note-area');
  const s=ta.selectionStart, e=ta.selectionEnd;
  const sel = ta.value.substring(s,e)||'text';
  ta.value = ta.value.substring(0,s)+before+sel+after+ta.value.substring(e);
  ta.selectionStart=s+before.length; ta.selectionEnd=s+before.length+sel.length;
  ta.focus(); onNoteType();
}
function ins(prefix) {
  const ta = document.getElementById('note-area');
  const pos=ta.selectionStart;
  const before=ta.value.substring(0,pos);
  const nl = before.length>0 && !before.endsWith('\n') ? '\n' : '';
  const insert = nl+prefix;
  ta.value = before+insert+ta.value.substring(pos);
  ta.selectionStart=ta.selectionEnd=pos+insert.length;
  ta.focus(); onNoteType();
}
function noteKey(e) {
  if (e.key==='Tab') { e.preventDefault(); ins('  '); }
}
function copyNote() {
  const ta = document.getElementById('note-area');
  navigator.clipboard.writeText(ta.value).then(()=>{
    const b=event.target; const orig=b.textContent;
    b.textContent='Copied!'; setTimeout(()=>b.textContent=orig,1500);
  });
}
function exportNote() {
  const tab=noteTabs.find(t=>t.id===activeNoteId);
  const ta=document.getElementById('note-area');
  const blob=new Blob([ta.value],{type:'text/plain'});
  const u=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=u;
  a.download=(tab?tab.name.replace(/\s+/g,'_'):'note')+'.txt';
  a.click(); URL.revokeObjectURL(u);
}
function clearNote() {
  if(!confirm('Clear this note?')) return;
  document.getElementById('note-area').value=''; onNoteType();
}

/* ═══════════════════════════════════════
   PROGRESS
═══════════════════════════════════════ */
const progLevels = [0,10,20,30,40,50,60,70,80,90,100];
let progValues = {};

async function loadProgress() {
  try {
    const r = await window.storage.get('grimoire-progress');
    if (r?.value) progValues = JSON.parse(r.value);
  } catch(e) {}
}
async function saveProgress() {
  try { await window.storage.set('grimoire-progress', JSON.stringify(progValues)); } catch(e) {}
}
function buildProgress() {
  const container = document.getElementById('prog-skills');
  container.innerHTML = '';
  skillsData.forEach((s, i) => {
    const raw = progValues[s.label] ?? s.pct;
    const val = Math.round(raw);
    const row = document.createElement('div');
    row.className = 'prog-row';
    row.title = 'Tap to manually adjust · auto-fills as you practice';
    row.innerHTML = `<div class="prog-label">${s.label}</div>
      <div class="prog-track"><div class="prog-fill" id="pf-${i}" style="width:${raw}%"></div></div>
      <div class="prog-pct" id="pp-${i}">${val}%</div>`;
    row.onclick = () => cycleProgress(i, s.label);
    container.appendChild(row);
  });
  buildAchievements();
}
function cycleProgress(i, label) {
  const fill = document.getElementById('pf-'+i);
  const pct = document.getElementById('pp-'+i);
  const cur = Math.round(parseFloat(fill.style.width) || 0);
  const idx = progLevels.indexOf(cur) >= 0 ? progLevels.indexOf(cur) : progLevels.findIndex(l => l > cur) - 1;
  const next = progLevels[((idx < 0 ? 0 : idx)+1) % progLevels.length];
  fill.style.width = next+'%';
  pct.textContent = next+'%';
  progValues[label] = next;
  saveProgress();
  buildAchievements();
  refreshHomeStats();
}
function buildAchievements() {
  const grid = document.getElementById('achievements');
  const streak = parseInt(document.getElementById('stat-streak')?.textContent||0);
  grid.innerHTML = achievementsData.map(a => {
    const unlocked = a.prog === 'streak' ? streak >= a.threshold :
                     a.prog === null ? false :
                     (progValues[skillsData.find(s=>s.label.toLowerCase().includes(a.prog.toLowerCase()))?.label]||0) >= (a.threshold||0);
    return `<div class="achieve-badge ${unlocked?'unlocked':''}">
      <div class="badge-icon">${a.icon}</div>
      <div class="badge-name">${a.name}</div>
      <div class="badge-desc">${a.desc}</div>
    </div>`;
  }).join('');
}

/* ═══════════════════════════════════════
   HOME STATS
═══════════════════════════════════════ */
async function saveHomeStats() {
  try {
    const mins = Math.floor(totalSecsLogged / 60);
    await window.storage.set('grimoire-stats', JSON.stringify({ mins, lastVisit: Date.now() }));
    document.getElementById('stat-mins').textContent = mins;
  } catch(e) {}
}
async function loadHomeStats() {
  try {
    const r = await window.storage.get('grimoire-stats');
    if (r?.value) {
      const d = JSON.parse(r.value);
      if (d.mins) { totalSecsLogged = d.mins * 60; document.getElementById('stat-mins').textContent = d.mins; }
    }
    // Streak: check last visit date
    const r2 = await window.storage.get('grimoire-streak');
    if (r2?.value) {
      const ds = JSON.parse(r2.value);
      const today = new Date().toDateString();
      const last = ds.last;
      let streak = ds.streak||0;
      if (last !== today) {
        const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
        if (last === yesterday.toDateString()) streak++;
        else if (last !== today) streak = 1;
        await window.storage.set('grimoire-streak', JSON.stringify({streak, last:today}));
      }
      document.getElementById('stat-streak').textContent = streak;
    } else {
      const today = new Date().toDateString();
      await window.storage.set('grimoire-streak', JSON.stringify({streak:1, last:today}));
      document.getElementById('stat-streak').textContent = 1;
    }
  } catch(e) {}
}
function refreshHomeStats() {
  buildWeekChart();
  const vals = Object.values(progValues);
  if (vals.length) {
    const avg = Math.round(vals.reduce((a,b) => a+b, 0) / vals.length);
    const el = document.getElementById('stat-skills');
    if (el) el.textContent = avg + '%';
  }
  const minsEl = document.getElementById('stat-mins');
  if (minsEl) minsEl.textContent = Math.floor(totalSecsLogged / 60);
}

/* ═══════════════════════════════════════
   BUILD MILESTONES
═══════════════════════════════════════ */
function buildMilestones() {
  const c = document.getElementById('milestones');
  c.innerHTML = milestonesData.map((m,i) => `
    <div class="check-row" onclick="toggleCheck(this)">
      <div class="check-box" id="ms-${i}">□</div>
      <div>
        <span class="check-main">${m.title}</span>
        <span class="check-sub">${m.desc}</span>
      </div>
    </div>`).join('');
}
function toggleCheck(row) {
  const box = row.querySelector('.check-box');
  box.classList.toggle('done');
  box.textContent = box.classList.contains('done') ? '✓' : '□';
}

/* ═══════════════════════════════════════
   BUILD ROADMAP
═══════════════════════════════════════ */
/* ═══════════════════════════════════════
   BUILD ROADMAP MILESTONES (interactive)
═══════════════════════════════════════ */
function buildRoadmapMilestones() {
  const c = document.getElementById('roadmap-milestones');
  if (!c) return;
  c.innerHTML = milestonesData.map((m, i) => {
    const done = localStorage.getItem('grimoire_rm_' + i) === '1';
    return `<div class="check-row" style="display:flex;align-items:flex-start;gap:14px;padding:12px 0;border-bottom:1px solid var(--ghost);cursor:pointer" onclick="toggleRoadmapMs(this,${i})">
      <div style="width:22px;height:22px;flex-shrink:0;border:2px solid ${done?'var(--blood)':'var(--wire)'};display:flex;align-items:center;justify-content:center;border-radius:4px;font-size:13px;color:${done?'var(--flame)':'var(--dim)'};margin-top:2px">${done?'✓':'○'}</div>
      <div style="flex:1">
        <div style="font-weight:700;color:${done?'var(--flame)':'var(--pale)'};margin-bottom:3px">${m.title}</div>
        <div style="font-size:13px;color:var(--mid)">${m.desc}</div>
      </div>
    </div>`;
  }).join('');
}
function toggleRoadmapMs(row, idx) {
  const box = row.querySelector('div');
  const done = box.textContent === '✓';
  box.textContent = done ? '○' : '✓';
  box.style.borderColor = done ? 'var(--wire)' : 'var(--blood)';
  box.style.color = done ? 'var(--dim)' : 'var(--flame)';
  const titleEl = row.querySelectorAll('div')[1].querySelector('div');
  if (titleEl) titleEl.style.color = done ? 'var(--pale)' : 'var(--flame)';
  localStorage.setItem('grimoire_rm_' + idx, done ? '0' : '1');
  if (!done) { autoProgressSkill('Natural Minor', 8); autoProgressSkill('Palm Muting', 5); }
}

/* ═══════════════════════════════════════
   BUILD ROADMAP
═══════════════════════════════════════ */
const roadmapNavMap = { 'Ear Training':'theory','Speed Trainer':'metronome','Backing Drone':'riff','Song Difficulty':'fundamentals','Riff Recorder':'riff','BPM Ramp':'metronome' };
function buildRoadmap() {
  const c = document.getElementById('roadmap-list');
  const navOrder = ['home','fundamentals','scales','arpeggios','techniques','session','metronome','dailytip','notepad','progress','review','theory','riff','roadmap'];
  c.innerHTML = roadmapData.map(r => {
    const target = Object.entries(roadmapNavMap).find(([k]) => r.title.includes(k));
    const navBtn = target ? `<button class="btn" style="margin-top:8px;font-size:10px;padding:4px 12px" onclick="goTo('${target[1]}', document.querySelectorAll('nav button')[${navOrder.indexOf(target[1])}])">→ Open ${target[1].charAt(0).toUpperCase()+target[1].slice(1)}</button>` : '';
    return `<div class="road-item">
      <div class="road-num">${r.num}</div>
      <div class="road-body">
        <div class="road-title">${r.title}</div>
        <div class="road-desc">${r.desc}</div>
        <div class="road-tags">${r.tags.map(t=>`<span class="road-tag ${t[1]}">${t[0]}</span>`).join('')}</div>
        ${navBtn}
      </div>
    </div>`;
  }).join('');
}

/* ═══════════════════════════════════════
   INIT
═══════════════════════════════════════ */
document.addEventListener('DOMContentLoaded', async () => {
  buildCollapse('fund-group', fundamentalsData);
  buildCollapse('arp-group', arpeggiosData);
  buildCollapse('tech-group', techniquesData);
  initScales();
  buildMilestones();
  buildRoadmap();
  buildRoadmapMilestones();
  buildMistakes();
  buildProgressions();
  loadPreset('deep');
  setTS(4);
  await loadProgress();
  buildProgress();
  await loadHomeStats();
  loadNotes();
  buildReview();
  buildProgressCard();
  setTimeout(patchVideoLinks, 100);
});


/* ══════════════════════════════════════════════════
   COMMON MISTAKES DATABASE
══════════════════════════════════════════════════ */
const mistakesData = [
  { title: 'Rushing the up-stroke on gallop patterns', body: 'The up-strokes between the two rapid notes of the gallop feel faster than the down-stroke. Players unconsciously rush them, destroying the triplet feel. The rhythm should feel like a heartbeat — long, short-short. Record yourself and listen back.', fix: 'Practice the gallop at 60 BPM with a metronome. Accent only the down-stroke. Every up-stroke is silent in your mind until the feel is locked.' },
  { title: 'Fretting too far from the fret wire', body: 'Pressing strings in the middle of the fret space requires far more pressure and causes buzzing. The string should vibrate cleanly with minimal effort when your fingertip is directly behind the fret wire (the metal bar itself).', fix: 'Play fret 5 on any string. Gradually slide your finger toward the wire until it buzzes, then move just past that point. That\'s your ideal position.' },
  { title: 'Pick angle too flat for speed', body: 'A pick held perfectly parallel to the string face creates maximum drag. At any real speed this becomes an invisible wall — you\'re fighting physics. Most players never realize this is happening.', fix: 'Tilt your pick 30-45° so the leading edge contacts the string before the flat face. The string should glide off the pick, not be pushed through it. This single change can unlock 15-20 BPM instantly.' },
  { title: 'Squeezing the neck on string 7 chugs', body: 'The lowest string requires more pressure than the others — and beginners overcompensate by death-gripping the neck. This creates forearm tension, slows alternate picking, and leads to injury over time.', fix: 'Practice open-string chugs on string 7 with your fretting hand completely off the neck. Your picking hand alone should mute unwanted strings. Then add fretting pressure — the minimum needed for clean tone only.' },
  { title: 'Ignoring right-hand muting on string changes', body: 'When you move from string 7 to string 6, string 7 continues to ring unless you consciously mute it. In a dense deathcore mix this is inaudible — but recorded clean it sounds like a swamp. Bad habits formed here are almost impossible to fix later.', fix: 'Practice each string transition in complete silence first — no picking, just fretting and muting. Feel your palm and fingers account for every string you leave behind. Then add the pick.' },
  { title: 'Sweep arpeggios: letting notes ring together', body: 'A sweep arpeggio played with notes ringing = a strummed chord. The defining feature of sweep picking is each note sounding individually in sequence. This requires your fretting fingers to lift immediately after picking — a completely counterintuitive movement.', fix: 'Practice the Am 3-string shape at 30 BPM. Focus entirely on the fretting hand lifting. The picking hand is almost irrelevant at this stage. One note at a time, zero overlap. Speed comes after this is automatic.' },
  { title: 'Vibrato that goes only sharp', body: 'Beginners almost always push the string up (sharpening) without pulling it back down past the original pitch. Real vibrato oscillates above AND below the root note equally, creating a symmetrical wobble. One-directional "vibrato" sounds like a nervous twitch.', fix: 'Hold a note on the B string, fret 7. Slowly push up a quarter-step, then return through the original pitch to a quarter-step flat. Feel both sides equally. Gradually increase speed over weeks.' },
  { title: 'Practicing without a metronome', body: 'Tempo drift is invisible to the player in the moment — your brain speeds up or slows down to match what you\'re playing. Without an external reference, you\'re reinforcing flawed timing every single session. This is the single fastest way to cement bad habits that take years to fix.', fix: 'Every practice session: metronome on before you pick up the guitar. If a riff feels "too slow" at 80 BPM, that feeling is lying to you. Trust the click. Own 80 before you touch 85.' },
];

function buildMistakes() {
  const c = document.getElementById('mistakes-list');
  if (!c) return;
  c.innerHTML = mistakesData.map(m => `
    <div class="mistake-card">
      <div class="mistake-title">${m.title}</div>
      <div class="mistake-body">${m.body}</div>
      <div class="mistake-fix">${m.fix}</div>
    </div>`).join('');
}

/* ══════════════════════════════════════════════════
   DEATHCORE PROGRESSIONS
══════════════════════════════════════════════════ */
const progressionsData = [
  { name: 'The Darkness (i – bVII – bVI – bVII)', chords: ['Am', 'G5', 'F5', 'G5'], desc: 'The most common deathcore progression. Descending minor feel. Found in: countless Thy Art Is Murder and Whitechapel verses.', tab: 'A|0-0-0-0--10-10--8-8--10-10\nE|0-0-0-0--10-10--8-8--10-10\nA|0-0-0-0--10-10--8-8--10-10' },
  { name: 'Phrygian Terror (i – bII – i – bII)', chords: ['Am', 'Bb5', 'Am', 'Bb5'], desc: 'The bII is the signature Phrygian chord — one semitone above the root. Pure Meshuggah/Lorna Shore energy. Menacing, grinding.', tab: 'A|0-0-0-0-1-1-1-1-0-0-0-0-1-1-1\nE|0-0-0-0-1-1-1-1-0-0-0-0-1-1-1\nA|0-0-0-0-1-1-1-1-0-0-0-0-1-1-1' },
  { name: 'The Breakdown (i – bVII – i – bVI)', chords: ['Am', 'G5', 'Am', 'F5'], desc: 'A slower, heavier-feeling movement used in breakdowns. The return to root after bVII creates momentum into the final chord drop.', tab: 'A|0--0--0--0--10--10--0--0--8--8\nE|0--0--0--0--10--10--0--0--8--8\nA|0--0--0--0--10--10--0--0--8--8' },
  { name: 'Diminished Descent (i – dim – bVII – i)', chords: ['Am', 'Adim', 'G5', 'Am'], desc: 'Chromatic-feeling movement using a diminished chord as a passing chord. Sounds cinematic and unresolved — classic Suicide Silence territory.', tab: 'A|0-0-0-0-4-4-4-4-10-10-10-10-0-0-0-0\nE|0-0-0-0-5-5-5-5-10-10-10-10-0-0-0-0\nA|0-0-0-0-6-6-6-6-10-10-10-10-0-0-0-0' },
  { name: 'War March (i – bVI – bVII – i)', chords: ['Am', 'F5', 'G5', 'Am'], desc: 'An ascending build-to-root. Great for verse → chorus transitions. The ascending motion creates momentum that resolves at the root.', tab: 'A|0-0-0-0-8-8-8-8-10-10-10-10-0-0-0\nE|0-0-0-0-8-8-8-8-10-10-10-10-0-0-0\nA|0-0-0-0-8-8-8-8-10-10-10-10-0-0-0' },
];

function buildProgressions() {
  const c = document.getElementById('prog-list');
  if (!c) return;
  c.innerHTML = progressionsData.map((p, i) => `
    <div class="collapse-item" id="prog-item-${i}" style="margin-bottom:6px">
      <div class="collapse-trigger" onclick="toggleCollapse('prog-item-${i}')">
        <div class="collapse-icon" style="font-size:10px">${i+1}</div>
        <div class="collapse-title">
          <div class="collapse-title-main" style="font-size:13px">${p.name}</div>
          <div class="collapse-title-sub">${p.chords.join(' — ')}</div>
        </div>
        <div class="collapse-arrow">▼</div>
      </div>
      <div class="collapse-body">
        <div class="collapse-body-inner">
          <p class="prose" style="margin-top:12px">${p.desc}</p>
          <div class="tab-block" style="margin-top:12px">
            <div class="tab-block-label">DROP A TAB</div>
            <pre style="font-family:var(--mono);font-size:12px;color:var(--pale);line-height:1.8;margin-top:4px">${p.tab}</pre>
          </div>
          <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;align-items:center">
            <button class="btn" onclick="aiExpandProgression('${p.name.replace(/'/g,'')}')" style="font-size:10px;padding:7px 14px">↻ Generate Variations</button>
            <button class="add-to-sess-btn" style="margin-top:0" onclick="addToSessionFromEl(this,'${p.name}',8,90,'Natural Minor','${p.desc.replace(/'/g,'\`').slice(0,200)}')">+ Add to Session</button>
          </div>
          <div id="prog-ai-${i}" style="display:none;margin-top:10px">
            <div class="ai-exercise-body" id="prog-ai-body-${i}" style="background:rgba(0,0,0,0.2);border:1px solid var(--edge);border-radius:var(--radius);padding:14px"></div>
          </div>
        </div>
      </div>
    </div>`).join('');
}

function aiExpandProgression(name) {
  const idx = progressionsData.findIndex(p => p.name.replace(/[']/g,'') === name);
  if (idx < 0) return;
  const panel = document.getElementById('prog-ai-'+idx);
  const body  = document.getElementById('prog-ai-body-'+idx);
  panel.style.display = 'block';
  body.className = 'ai-exercise-body loading';
  body.textContent = 'Loading variations...';
  const variation = pickFrom(progressionVars, 'progvar_' + idx);
  setTimeout(() => {
    body.className = 'ai-exercise-body';
    body.innerHTML = variation;
  }, 300);
}

/* ══════════════════════════════════════════════════
   CHORD → SCALE FINDER
══════════════════════════════════════════════════ */
const scaleDefinitions = [
  { name: 'Natural Minor (Aeolian)', intervals: [0,2,3,5,7,8,10], color: '#7720cc', desc: 'Dark, melancholic. The universal minor sound. Fits perfectly over any minor or power chord.' },
  { name: 'Phrygian', intervals: [0,1,3,5,7,8,10], color: '#5a10a0', desc: 'That flat 2nd (bII) is the Phrygian signature — Spanish/Middle-Eastern menace. Core deathcore vocabulary.' },
  { name: 'Phrygian Dominant', intervals: [0,1,4,5,7,8,10], color: '#8b0000', desc: 'Phrygian with a major 3rd. Epic, cinematic evil. Symphonic deathcore staple.' },
  { name: 'Harmonic Minor', intervals: [0,2,3,5,7,8,11], color: '#3d0870', desc: 'Natural minor with a raised 7th. The augmented 2nd interval sounds neo-classical and dramatic.' },
  { name: 'Diminished (W-H)', intervals: [0,2,3,5,6,8,9,11], color: '#5a0f0f', desc: 'Symmetrical 8-note scale. Pure unresolved tension. Fits diminished and half-diminished chords.' },
  { name: 'Chromatic', intervals: [0,1,2,3,4,5,6,7,8,9,10,11], color: '#3a3a5a', desc: 'All 12 notes. Pass-through for chromatic runs and connecting positions.' },
  { name: 'Minor Pentatonic', intervals: [0,3,5,7,10], color: '#c8883a', desc: '5-note minor scale. The bedrock of rock and metal. Works over anything minor or power chord.' },
  { name: 'Dorian', intervals: [0,2,3,5,7,9,10], color: '#4a7a9a', desc: 'Natural minor with a raised 6th. Slightly brighter and jazzier — used in progressive deathcore.' },
];

const chordIntervals = {
  'm':   [0,3,7],
  '5':   [0,7],
  'dim': [0,3,6],
  'm7':  [0,3,7,10],
  'maj': [0,4,7],
  'aug': [0,4,8],
  'dim7':[0,3,6,9],
};

const noteNames = ['A','A#/Bb','B','C','C#/Db','D','D#/Eb','E','F','F#/Gb','G','G#/Ab'];

function findScales() {
  const rootName = document.getElementById('chord-root-sel').value;
  const quality  = document.getElementById('chord-quality-sel').value;
  let rootIdx  = noteNames.indexOf(rootName);
  if (rootIdx === -1) rootIdx = 0; // fallback to A
  const qualIntervals = chordIntervals[quality];
  if (!qualIntervals) { console.warn('Unknown quality:', quality); return; }
  const chordTones = qualIntervals.map(i => (rootIdx + i) % 12);
  
  const results = scaleDefinitions.map(scale => {
    const scaleTones = scale.intervals.map(i => (rootIdx + i) % 12);
    const matches = chordTones.filter(t => scaleTones.includes(t)).length;
    const pct = Math.round((matches / chordTones.length) * 100);
    return { ...scale, pct, best: pct === 100 };
  }).sort((a,b) => b.pct - a.pct);

  const c = document.getElementById('scale-results');
  c.innerHTML = results.map(r => `
    <div class="scale-result-item ${r.best ? 'best' : ''}">
      <div class="scale-result-name">
        ${r.name}
        <span class="scale-result-match">${r.pct}% match</span>
      </div>
      <div class="scale-result-notes">${r.intervals.map(i => noteNames[(rootIdx+i)%12]).join('  ·  ')}</div>
      <div class="scale-result-desc">${r.desc}</div>
    </div>`).join('');
}

function switchTheoryTab(panel, el) {
  document.querySelectorAll('.theory-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.theory-panel').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('theory-' + panel).classList.add('active');
}

/* ══════════════════════════════════════════════════
   INTERVAL EAR TRAINER
══════════════════════════════════════════════════ */
const intervals = [
  { name: 'Minor 2nd', semitones: 1, context: 'The bII in Phrygian — the "terror" interval. Opening of Jaws.' },
  { name: 'Major 2nd', semitones: 2, context: 'Whole step. The gap between W in scale formulas.' },
  { name: 'Minor 3rd', semitones: 3, context: 'The defining interval of a minor chord. Dark and heavy.' },
  { name: 'Major 3rd', semitones: 4, context: 'The defining interval of a major chord. Bright and resolved.' },
  { name: 'Perfect 4th', semitones: 5, context: 'Powerful and stable. Common riff interval.' },
  { name: 'Tritone', semitones: 6, context: 'The Devil\'s Interval. Black Sabbath intro. Pure tension.' },
  { name: 'Perfect 5th', semitones: 7, context: 'Power chord interval. The foundation of all metal.' },
  { name: 'Minor 6th', semitones: 8, context: 'Dark, slightly ambiguous. Used in harmonic minor lines.' },
  { name: 'Minor 7th', semitones: 10, context: 'Blues-heavy interval. Common in passing notes.' },
  { name: 'Octave', semitones: 12, context: 'Same note, higher pitch. Pure consonance.' },
];

let intScore = 0, intTotal = 0, intStreak = 0, intCurrent = null, intAnswered = false;
let intACtx = null;

function getIntACtx() {
  if (!intACtx) intACtx = new (window.AudioContext || window.webkitAudioContext)();
  return intACtx;
}

function playNote(freq, time, duration, ctx) {
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.connect(g); g.connect(ctx.destination);
  o.type = 'sawtooth';
  o.frequency.value = freq;
  g.gain.setValueAtTime(0.3, time);
  g.gain.exponentialRampToValueAtTime(0.001, time + duration);
  o.start(time); o.stop(time + duration + 0.05);
}

function playIntervalSound(semitones) {
  const ctx = getIntACtx();
  if (ctx.state === 'suspended') ctx.resume();
  const baseFreq = 110; // A2 — 7th string open
  const now = ctx.currentTime + 0.05;
  playNote(baseFreq, now, 0.8, ctx);
  playNote(baseFreq * Math.pow(2, semitones/12), now + 0.9, 0.8, ctx);
}

function initIntervalTrainer() {
  buildIntervalOptions();
  newInterval();
}

function buildIntervalOptions() {
  const c = document.getElementById('int-options');
  if (!c) return;
  c.innerHTML = intervals.map(iv =>
    `<div class="interval-opt" data-semi="${iv.semitones}" onclick="checkInterval(${iv.semitones}, this)">${iv.name}</div>`
  ).join('');
}

function newInterval() {
  intCurrent = intervals[Math.floor(Math.random() * intervals.length)];
  intAnswered = false;
  document.getElementById('int-name').textContent = '?';
  document.getElementById('int-semitones').textContent = '— semitones';
  document.getElementById('int-context').textContent = '';
  document.querySelectorAll('.interval-opt').forEach(el => {
    el.classList.remove('correct','wrong');
  });
}

function playInterval(isNew) {
  if (isNew) newInterval();
  if (intCurrent) playIntervalSound(intCurrent.semitones);
}

function checkInterval(semitones, el) {
  if (intAnswered) return;
  intAnswered = true;
  intTotal++;
  document.getElementById('int-total').textContent = intTotal;
  if (semitones === intCurrent.semitones) {
    el.classList.add('correct');
    intScore++; intStreak++;
    document.getElementById('int-score').textContent = intScore;
    document.getElementById('int-streak').textContent = intStreak;
    // Award theory skill for correct answers
    autoProgressSkill('Natural Minor', 0.8);
    autoProgressSkill('Phrygian', 0.5);
    if (intStreak >= 5) autoProgressSkill('Harmonic Minor', 1.0);
  } else {
    el.classList.add('wrong');
    intStreak = 0;
    document.getElementById('int-streak').textContent = 0;
    // Reveal correct
    document.querySelectorAll('.interval-opt').forEach(opt => {
      if (parseInt(opt.dataset.semi || -1) === intCurrent.semitones) opt.classList.add('correct');
    });
  }
  document.getElementById('int-name').textContent = intCurrent.name;
  document.getElementById('int-semitones').textContent = intCurrent.semitones + ' semitones';
  document.getElementById('int-context').textContent = intCurrent.context;
  setTimeout(() => { if (!intAnswered) return; }, 0);
}



/* ══════════════════════════════════════════════════
   WEEKLY REVIEW
══════════════════════════════════════════════════ */
function buildReview() {
  // Pull stats from live session + localStorage
  const vals = Object.values(progValues);
  const avg = vals.length ? Math.round(vals.reduce((a,b)=>a+b,0)/vals.length) : 0;

  // Total mins — sum from daily localStorage keys
  let totalMins = 0;
  for (let i = 0; i < 365; i++) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const key = 'grimoire_day_' + d.toISOString().slice(0,10);
    try {
      const data = JSON.parse(localStorage.getItem(key) || '{}');
      totalMins += data.mins || 0;
    } catch(e) {}
  }
  // Add current unsaved session
  totalMins = Math.max(totalMins, Math.floor(totalSecsLogged/60));

  // Week mins
  const weekDays = getWeekStats ? getWeekStats() : [];
  const weekMins = weekDays.reduce((s,d) => s + d.mins, 0);

  // Streak from stat element
  const streak = parseInt(document.getElementById('stat-streak')?.textContent || '0');

  const stats = document.getElementById('review-stats');
  if (stats) stats.innerHTML = `
    <div class="review-stat"><div class="review-stat-val">${streak}</div><div class="review-stat-lbl">Day Streak</div></div>
    <div class="review-stat"><div class="review-stat-val">${weekMins}</div><div class="review-stat-lbl">This Week (min)</div></div>
    <div class="review-stat"><div class="review-stat-val">${totalMins}</div><div class="review-stat-lbl">Total Mins</div></div>
    <div class="review-stat"><div class="review-stat-val">${avg}%</div><div class="review-stat-lbl">Avg Skill</div></div>
  `;

  const bars = document.getElementById('review-bars');
  if (bars) bars.innerHTML = skillsData.map(s => {
    const v = progValues[s.label] ?? s.pct;
    return `<div class="review-bar-row">
      <div class="review-bar-label">${s.label}</div>
      <div class="review-bar-track"><div class="review-bar-fill" style="width:${v}%"></div></div>
      <div class="review-bar-pct">${v}%</div>
    </div>`;
  }).join('');
}

function refreshWeeklyCoach() {
  const note = pickFrom(coachingNotes, 'coaching');
  const cleanNote = note.replace(/<[^>]+>/g,'').slice(0,250).replace(/'/g,'`');
  const noteHtml = note + `<button class="add-to-sess-btn" style="margin-top:14px" onclick="addToSessionFromEl(this,'This Week Coach Focus',10,75,'Chromatic/Warmup','${cleanNote}');">+ Add to Session</button>`;
  showSectionPanel('review-ai-panel','review-ai-icon','review-ai-btn', noteHtml);
}

function buildProgressCard() {
  const vals = Object.values(progValues);
  const avg = vals.length ? Math.round(vals.reduce((a,b)=>a+b,0)/vals.length) : 0;
  const mins = Math.floor(totalSecsLogged/60);
  const streak = document.getElementById('stat-streak')?.textContent||'0';
  const c = document.getElementById('progress-card-preview');
  if (!c) return;
  const topSkills = skillsData.slice(0,8).map(s => {
    const v = progValues[s.label] ?? s.pct;
    return `<div class="card-skill-row">
      <div class="card-skill-lbl">${s.label}</div>
      <div class="card-skill-bar"><div class="card-skill-fill" style="width:${v}%"></div></div>
      <span style="font-family:var(--mono);font-size:9px;color:var(--ember);width:28px;text-align:right">${v}%</span>
    </div>`;
  }).join('');
  c.innerHTML = `
    <div class="card-preview-title">Drop A Grimoire</div>
    <div class="card-preview-sub">7-String Deathcore · Progress Card</div>
    <div class="card-preview-stats">
      <div class="card-prev-stat"><div class="card-prev-val">${streak}</div><div class="card-prev-lbl">Streak</div></div>
      <div class="card-prev-stat"><div class="card-prev-val">${mins}</div><div class="card-prev-lbl">Mins</div></div>
      <div class="card-prev-stat"><div class="card-prev-val">${avg}%</div><div class="card-prev-lbl">Overall</div></div>
    </div>
    <div class="card-preview-skills">${topSkills}</div>`;
}

function copyProgressCard() {
  const vals = Object.values(progValues);
  const avg = vals.length ? Math.round(vals.reduce((a,b)=>a+b,0)/vals.length) : 0;
  const mins = Math.floor(totalSecsLogged/60);
  const streak = document.getElementById('stat-streak')?.textContent||'0';
  const skills = skillsData.slice(0,8).map(s => {
    const v = progValues[s.label] ?? s.pct;
    const bar = '█'.repeat(Math.floor(v/10)) + '░'.repeat(10-Math.floor(v/10));
    return `  ${s.label.padEnd(18)} ${bar} ${v}%`;
  }).join('\n');
  const text = `╔═══════════════════════════════╗
║    DROP A GRIMOIRE — 7-STRING  ║
╚═══════════════════════════════╝
  Streak:   ${streak} days
  Practice: ${mins} minutes
  Overall:  ${avg}%

SKILLS:
${skills}

// Learning deathcore on 7-string Drop A
// Drop A Grimoire`;
  navigator.clipboard.writeText(text).then(() => {
    const btn = event.target;
    const orig = btn.textContent;
    btn.textContent = 'Copied to clipboard!';
    setTimeout(() => btn.textContent = orig, 2000);
  });
}

/* ══════════════════════════════════════════════════
   VIDEO LINKS — injected into collapsibles via data
══════════════════════════════════════════════════ */
const videoLinks = {
  'Palm Muting': [
    { name: 'Palm Muting for Heavy Metal — Full Guide', ch: 'Paul Davids', url: 'https://www.youtube.com/results?search_query=palm+muting+metal+guitar+tutorial' },
    { name: 'Drop Tuning Palm Mute Technique', ch: 'Jared Dines', url: 'https://www.youtube.com/results?search_query=drop+tuning+palm+muting+7+string' },
  ],
  'Sweep Picking': [
    { name: 'Sweep Picking for Absolute Beginners', ch: 'Bernth', url: 'https://www.youtube.com/results?search_query=sweep+picking+beginners+tutorial' },
    { name: '5-String Arpeggio Sweep Guide', ch: 'Guitargate', url: 'https://www.youtube.com/results?search_query=5+string+sweep+arpeggio+tutorial' },
  ],
  'Gallop Rhythm': [
    { name: 'Gallop Picking Pattern — Deathcore', ch: 'Jared Dines', url: 'https://www.youtube.com/results?search_query=gallop+picking+pattern+metal+tutorial' },
    { name: 'Forward vs Reverse Gallop Explained', ch: 'Rick Beato', url: 'https://www.youtube.com/results?search_query=forward+reverse+gallop+metal+guitar' },
  ],
  'Natural Minor': [
    { name: 'Natural Minor Scale — Metal Context', ch: 'Signals Music Studio', url: 'https://www.youtube.com/results?search_query=natural+minor+scale+metal+guitar' },
  ],
  'Phrygian': [
    { name: 'Phrygian Mode for Metal — Complete Guide', ch: 'Ola Englund', url: 'https://www.youtube.com/results?search_query=phrygian+mode+metal+guitar+tutorial' },
    { name: 'Phrygian Licks for Deathcore', ch: 'Phil Sgrosso', url: 'https://www.youtube.com/results?search_query=phrygian+licks+deathcore+guitar' },
  ],
};

function buildVideoLinks(topic) {
  const links = videoLinks[topic];
  if (!links) return '';
  return `<div class="video-section">
    <div class="video-section-title">// Video Resources</div>
    <div class="video-link-list">
      ${links.map(l => `
        <a href="${l.url}" target="_blank" rel="noopener" class="video-link">
          <span class="video-link-icon">▶</span>
          <div class="video-link-info">
            <div class="video-link-name">${l.name}</div>
            <div class="video-link-ch">${l.ch}</div>
          </div>
          <span class="video-link-arrow">↗</span>
        </a>`).join('')}
    </div>
  </div>`;
}

// Patch existing collapse items with video links on page load
function patchVideoLinks() {
  const techTopics = {
    'fund-group-item-4': 'Palm Muting',
    'tech-group-item-0': 'Palm Muting',
    'tech-group-item-1': 'Gallop Rhythm',
    'arp-group-item-1': 'Sweep Picking',
    'scales-group-item-0': 'Natural Minor',
    'scales-group-item-1': 'Phrygian',
  };
  Object.entries(techTopics).forEach(([id, topic]) => {
    const item = document.getElementById(id);
    if (!item) return;
    const inner = item.querySelector('.collapse-body-inner');
    if (inner && videoLinks[topic]) {
      const aiPanel = inner.querySelector('[id^="ai-panel"]');
      const videoDiv = document.createElement('div');
      videoDiv.innerHTML = buildVideoLinks(topic);
      if (aiPanel) inner.insertBefore(videoDiv.firstElementChild, aiPanel);
      else inner.appendChild(videoDiv.firstElementChild);
    }
  });
}
/* ═══════════════════════════════════════════════
   FAB POPUP — METRONOME
═══════════════════════════════════════════════ */
let metroPopupOpen = false;

function toggleMetroPopup() {
  metroPopupOpen = !metroPopupOpen;
  const popup = document.getElementById('metro-popup');
  const fab = document.getElementById('fab-metro');
  if (!popup) return;
  popup.classList.toggle('open', metroPopupOpen);
  if (fab) fab.classList.toggle('active-fab', metroPopupOpen);
  if (metroPopupOpen) {
    // Sync on open
    const mpNum = document.getElementById('mp-bpm-display');
    const mpSlider = document.getElementById('mp-bpm-slider');
    const mpBtn = document.getElementById('mp-start-btn');
    const mpRow = document.getElementById('mp-beat-row');
    if (mpNum) mpNum.textContent = bpm;
    if (mpSlider) mpSlider.value = bpm;
    if (mpBtn) { mpBtn.textContent = metroRunning ? '■  STOP' : '▶  START'; mpBtn.classList.toggle('running', metroRunning); }
    if (mpRow) mpRow.innerHTML = Array(beatsPerMeasure).fill('<div class="mp-pip"></div>').join('');
  }
}

document.addEventListener('click', e => {
  const popup = document.getElementById('metro-popup');
  const fabM = document.getElementById('fab-metro');
  if (metroPopupOpen && popup && fabM && !popup.contains(e.target) && !fabM.contains(e.target)) {
    metroPopupOpen = false;
    popup.classList.remove('open');
    fabM.classList.remove('active-fab');
  }
});

/* ═══════════════════════════════════════════════
   FAB — SESSION
═══════════════════════════════════════════════ */
function fabSessionClick() {
  const sessPage = document.getElementById('session');
  if (!sessPage || !sessPage.classList.contains('active')) {
    goTo('session', null);
    setTimeout(() => { if (!sessRunning && sessionBlocks.length === 0) loadPreset('deep'); }, 80);
  } else {
    toggleSession();
  }
}

function syncSessionFab() {
  const fab = document.getElementById('fab-session');
  const btn = document.getElementById('sess-start-btn');
  const lbl = document.getElementById('sess-btn-label');
  if (fab) fab.classList.toggle('session-running', sessRunning);
  if (btn) btn.classList.toggle('running', sessRunning);
  if (lbl) lbl.textContent = sessRunning ? '■  PAUSE SESSION' : '▶  START SESSION';
}

function buildWeekChart() {
  const el = document.getElementById('week-chart-section');
  if (!el) return;
  const days = getWeekStats();
  const maxMins = Math.max(30, ...days.map(d => d.mins));
  const today = new Date().toLocaleDateString('en-US',{weekday:'short'});
  const bars = days.map(d => {
    const pct = maxMins > 0 ? Math.max(4, Math.round((d.mins / maxMins) * 72)) : 4;
    const isToday = d.date === today;
    return `<div class="week-bar-wrap">
      <div class="week-mins">${d.mins > 0 ? d.mins+'m' : ''}</div>
      <div class="week-bar ${isToday ? 'today' : ''}" style="height:${pct}px"></div>
      <div class="week-day">${d.date}</div>
    </div>`;
  }).join('');
  const totalWeek = days.reduce((s,d) => s+d.mins, 0);
  el.innerHTML = `
    <div style="font-family:var(--mono);font-size:9px;color:#7870a0;letter-spacing:2px;margin-bottom:6px">// THIS WEEK — ${totalWeek} MINS TOTAL</div>
    <div class="week-chart">${bars}</div>`;
}

function updateFabTimer() {
  const b = sessionBlocks[currentBlockIdx];
  const el = document.getElementById('fab-timer-val');
  if (el && b) el.textContent = fmtTime(b.secsLeft);
}

/* ═══════════════════════════════════════════════
   DAILY STATS TRACKING
═══════════════════════════════════════════════ */
function todayKey() {
  return 'day_' + new Date().toISOString().slice(0,10);
}

function saveDailyStats() {
  const key = todayKey();
  const mins = Math.round(totalSecsLogged / 60);
  const existing = JSON.parse(localStorage.getItem('grimoire_' + key) || '{}');
  existing.mins = mins;
  existing.date = new Date().toISOString().slice(0,10);
  localStorage.setItem('grimoire_' + key, JSON.stringify(existing));
}

function saveSessionStats() {
  saveDailyStats();
  refreshHomeStats();
}

function getWeekStats() {
  const days = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const key = 'grimoire_day_' + d.toISOString().slice(0,10);
    const data = JSON.parse(localStorage.getItem(key) || '{}');
    days.push({ date: d.toLocaleDateString('en-US',{weekday:'short'}), mins: data.mins || 0 });
  }
  return days;
}

/* ═══════════════════════════════════════════════
   DRAGGABLE FAB CLUSTER
═══════════════════════════════════════════════ */
document.addEventListener('DOMContentLoaded', () => {
  const cluster = document.getElementById('fab-cluster');
  if (!cluster) return;
  let dragging = false, didDrag = false, startX, startY, origRight, origBottom;
  let pressTimer = null;

  cluster.addEventListener('pointerdown', e => {
    startX = e.clientX; startY = e.clientY;
    origRight = parseInt(cluster.style.right) || 20;
    origBottom = parseInt(cluster.style.bottom) || 24;
    didDrag = false;
    // Long-press to drag
    pressTimer = setTimeout(() => {
      dragging = true;
      cluster.style.cursor = 'grabbing';
      cluster.setPointerCapture(e.pointerId);
    }, 400);
  });

  cluster.addEventListener('pointermove', e => {
    const dx = Math.abs(e.clientX - startX) + Math.abs(e.clientY - startY);
    if (dx > 6) { clearTimeout(pressTimer); }
    if (!dragging) return;
    didDrag = true;
    const newRight = Math.max(8, Math.min(window.innerWidth - 70, origRight - (e.clientX - startX)));
    const newBottom = Math.max(8, Math.min(window.innerHeight - 220, origBottom - (e.clientY - startY)));
    cluster.style.right = newRight + 'px';
    cluster.style.bottom = newBottom + 'px';
    const popup = document.getElementById('metro-popup');
    if (popup) { popup.style.right = newRight + 'px'; popup.style.bottom = (newBottom + 70) + 'px'; }
  });

  cluster.addEventListener('pointerup', e => {
    clearTimeout(pressTimer);
    dragging = false;
    cluster.style.cursor = '';
  });
});

/* ═══════════════════════════════════════════════
   RIFF INSPIRATION — CONTENT BANK
═══════════════════════════════════════════════ */
const riffBank = [
  {
    genre: 'breakdown',
    mood: 'crushing',
    bpm: 65,
    title: 'The Stomp',
    description: 'A half-time breakdown built on open A. The rhythm is the point — it should feel like something heavy falling.',
    tip: 'Keep the palm mute consistent. The accent on beat 3 should be slightly louder.',
    tab: [
      ['e','|--------------------------|'],
      ['B','|--------------------------|'],
      ['G','|--------------------------|'],
      ['D','|--------------------------|'],
      ['A','|--------------------------|'],
      ['E','|--------------------------|'],
      ['A','|-(PM)-0-0-0-0--0---0-0----|'],
    ],
    strum: 'D D D D  D   D D',
    key: 'A (Drop A open)',
  },
  {
    genre: 'breakdown',
    mood: 'dissonant',
    bpm: 72,
    title: 'The Smash',
    description: 'Alternating open A and bII (Bb5) — classic Phrygian breakdown. One finger on fret 1 across strings 5-6-7.',
    tip: 'The muted chug before the Bb hit creates anticipation. Don\'t rush it.',
    tab: [
      ['e','|------------------------------|'],
      ['B','|------------------------------|'],
      ['G','|------------------------------|'],
      ['D','|------------------------------|'],
      ['A','|-(PM)-0-0-0-0-0--1-1--0-0-0---|'],
      ['E','|-(PM)-0-0-0-0-0--1-1--0-0-0---|'],
      ['A','|-(PM)-0-0-0-0-0--1-1--0-0-0---|'],
    ],
    strum: 'D DU D DU  D D  D DU D',
    key: 'A Phrygian (A=0, Bb=1)',
  },
  {
    genre: 'tremolo',
    mood: 'frantic',
    bpm: 180,
    title: 'The Barrage',
    description: 'Straight 16th note tremolo on open A7, shifting to power chord on beat 3. Wall of sound territory.',
    tip: 'Lock to a metronome at 120 first. Tempo is less important than consistency.',
    tab: [
      ['e','|---------------------------------------|'],
      ['B','|---------------------------------------|'],
      ['G','|---------------------------------------|'],
      ['D','|---------------------------------------|'],
      ['A','|---------------------------------------|'],
      ['E','|-(PM)-0-0-0-0-0-0-0-0--2-2-2-2--0-0---|'],
      ['A','|-(PM)-0-0-0-0-0-0-0-0--2-2-2-2--0-0---|'],
    ],
    strum: 'All downstrokes (or alternate pick for speed)',
    key: 'A power chord → B5 → back',
  },
  {
    genre: 'gallop',
    mood: 'aggressive',
    bpm: 130,
    title: 'The War Horse',
    description: 'Forward gallop (D-DU) pattern on open 7th string. The quintessential deathcore rhythm vehicle.',
    tip: 'Start at 80 BPM. The D-DU should feel like a galloping horse rhythm naturally.',
    tab: [
      ['e','|-------------------------|'],
      ['B','|-------------------------|'],
      ['G','|-------------------------|'],
      ['D','|-------------------------|'],
      ['A','|-------------------------|'],
      ['E','|-------------------------|'],
      ['A','|-(PM)-0-00-0-00-0-00-0-00|'],
    ],
    strum: 'D-DU  D-DU  D-DU  D-DU',
    key: 'A (open string 7), (PM) = palm mute',
  },
  {
    genre: 'gallop',
    mood: 'complex',
    bpm: 120,
    title: 'Gallop with Accent',
    description: 'Gallop on string 7, with a chord stab on string 7+6+5 every two groups. Creates a call-and-response feel.',
    tip: 'The chord stab needs a clean palm lift — brief open ring before re-muting.',
    tab: [
      ['e','|-------------------------------|'],
      ['B','|-------------------------------|'],
      ['G','|-------------------------------|'],
      ['D','|--------------------------0----|'],
      ['A','|--------------------------0----|'],
      ['E','|--------------------------0----|'],
      ['A','|-(PM)-0-00-0-00-(PM)-0-00-0----|'],
    ],
    strum: 'D-DU D-DU  →  D-DU + open stab',
    key: 'A open / A5 open power chord',
  },
  {
    genre: 'riff',
    mood: 'melodic',
    bpm: 100,
    title: 'Phrygian Creep',
    description: 'Slow chromatic movement using the Phrygian scale. Works as an intro riff or chord vamp.',
    tip: 'The chromatic movement from A to Bb and back is the whole emotion of this riff. Make each note count.',
    tab: [
      ['e','|----------------------------------------------|'],
      ['B','|----------------------------------------------|'],
      ['G','|----------------------------------------------|'],
      ['D','|----------------------------------------------|'],
      ['A','|--5-5-5-6-5-------5-5-5-6-5-------------------|'],
      ['E','|--5-5-5-6-5-------5-5-5-6-5-------------------|'],
      ['A','|--(PM)0-0-0-1-0---0-0-0-1-0-------------------|'],
    ],
    strum: 'DDD D D  (let ring briefly on the 1)',
    key: 'A Phrygian. Fret 1 = Bb (the b2)',
  },
  {
    genre: 'riff',
    mood: 'sinister',
    bpm: 95,
    title: 'Tritone Menace',
    description: 'Open A7 to Eb5 (tritone - the devil\'s interval). Most dissonant sound in western music.',
    tip: 'The tritone resolves nowhere — it just hangs. That\'s the point. Let the last note decay.',
    tab: [
      ['e','|--------------------------|'],
      ['B','|--------------------------|'],
      ['G','|--------------------------|'],
      ['D','|--------------------------|'],
      ['A','|---------6-6--------------|'],
      ['E','|---------6-6--------------|'],
      ['A','|-(PM)0-0-6-6-0-0-0--------|'],
    ],
    strum: 'DU  DD  DU  DU',
    key: 'A open = root. Fret 6 = Eb (b5 / tritone)',
  },
  {
    genre: 'riff',
    mood: 'melodic',
    bpm: 85,
    title: 'Harmonic Minor Hook',
    description: 'Uses the raised 7th (G#) of A harmonic minor to create tension that resolves to the root.',
    tip: 'The slide from G# (fret 12) to A (fret 12+1 or open) is the payoff. Pause before the resolve.',
    tab: [
      ['e','|----------------------------------------------|'],
      ['B','|----------------------------------------------|'],
      ['G','|----------------------------------------------|'],
      ['D','|----------------------------------------------|'],
      ['A','|-0-0--5-7-8--10-12-/12h13--0------------------|'],
      ['E','|----------------------------------------------|'],
      ['A','|----------------------------------------------|'],
    ],
    strum: 'Pick each note individually. Slide on the /.',
    key: 'A Harmonic Minor. 12=G#, 13=A (resolve)',
  },
  {
    genre: 'lick',
    mood: 'explosive',
    bpm: 140,
    title: 'The Death Burst',
    description: 'A fast 4-note burst ending in a bend. Sounds complex, plays as just 4 notes on two strings.',
    tip: 'Use economy picking: down-down-up-pull. The pull-off does the work.',
    tab: [
      ['e','|-------------------------------|'],
      ['B','|-------------------------------|'],
      ['G','|---5h7--5h7-5------------------|'],
      ['D','|---5---------7b(8)-------------|'],
      ['A','|-------------------------------|'],
      ['E','|-------------------------------|'],
      ['A','|-------------------------------|'],
    ],
    strum: 'Economy picking: D-D-U then pull-off',
    key: 'A minor. Fret 5=A, 7=B on G; 5=A, 7=B, bend to C on D',
  },
  {
    genre: 'lick',
    mood: 'sweep',
    bpm: 80,
    title: 'Am Sweep Fragment',
    description: 'A 5-string Am arpeggio sweep — the foundation of every sweep picking lick in deathcore.',
    tip: 'The down-sweep is ONE continuous motion. Each string gets one pick only. Start at 40 BPM.',
    tab: [
      ['e','|-0------------------------|'],
      ['B','|-1------------------------|'],
      ['G','|-2------------------------|'],
      ['D','|-2------------------------|'],
      ['A','|-0-----------then reverse-|'],
      ['E','|--------------------------|'],
      ['A','|--------------------------|'],
    ],
    strum: 'One continuous down-sweep, then up-sweep back',
    key: 'Am arpeggio: A C E (root, b3, 5)',
  },
];

function getRiff(genre) {
  const pool = genre === 'any' ? riffBank : riffBank.filter(r => r.genre === genre);
  if (!pool.length) return riffBank[Math.floor(Math.random() * riffBank.length)];
  return pool[Math.floor(Math.random() * pool.length)];
}

let currentRiff = null;
let riffGenre = 'any';

function initRiff() {
  generateRiff();
}

function setRiffGenre(el, genre) {
  document.querySelectorAll('.riff-filter').forEach(f => f.classList.remove('active'));
  el.classList.add('active');
  riffGenre = genre;
  generateRiff();
}

function generateRiff() {
  currentRiff = getRiff(riffGenre);
  renderRiff();
}

function addRiffToSession(btn) {
  if (!currentRiff) return;
  const slowBpm = Math.max(40, Math.round(currentRiff.bpm * 0.65));
  // Add 3 riff-practice blocks
  const blocks = [
    { name: currentRiff.title + ' — Learn Slowly', mins: 5, bpm: slowBpm, skill: 'Alternate Pick', detail: currentRiff.description + ' Start at ' + slowBpm + ' BPM. Focus on clean fretting.', color: '#5a10a0', secsLeft: 300, done: false },
    { name: currentRiff.title + ' — Up to Tempo', mins: 7, bpm: currentRiff.bpm, skill: 'Gallop Rhythm', detail: 'Push up to ' + currentRiff.bpm + ' BPM. Apply: ' + currentRiff.tip, color: '#7720cc', secsLeft: 420, done: false },
  ];
  blocks.forEach(block => {
    if (sessionBlocks.length === 0) {
      sessionBlocks.push(block);
    } else {
      const insertAt = Math.min(currentBlockIdx + 1, sessionBlocks.length);
      sessionBlocks.splice(insertAt, 0, block);
    }
  });
  renderBlocks();
  updateTimerDisplay();
  if (btn) { const o=btn.innerHTML; btn.innerHTML='✓ 2 BLOCKS ADDED'; btn.classList.add('added'); setTimeout(()=>{btn.innerHTML=o;btn.classList.remove('added');},2000); }
  showToast(currentRiff.title + ' added — 2 blocks');
}

function renderRiff() {
  const r = currentRiff;
  if (!r) return;

  // Build tab HTML — low string (A7) at bottom
  const rowsHtml = r.tab.map(row => {
    return `<div class="tab-row">
      <span class="tab-str">${row[0]}</span>
      <span class="tab-sep">|</span>
      <span class="tab-notes">${row[1].replace(/\(PM\)/g,'<span style="color:var(--gold)">(PM)</span>')}</span>
    </div>`;
  }).join('');

  const genreColors = { breakdown:'var(--blood)', tremolo:'var(--ember)', gallop:'var(--hot)', riff:'var(--crimson)', lick:'var(--gold)' };
  const col = genreColors[r.genre] || 'var(--blood)';

  document.getElementById('riff-display').innerHTML = `
    <div class="riff-card">
      <div class="riff-card-header">
        <div class="riff-title">${r.title}</div>
        <div class="riff-tags">
          <span class="riff-tag" style="border-color:${col};color:${col}">${r.genre.toUpperCase()}</span>
          <span class="riff-tag">${r.mood}</span>
          <span class="riff-tag">♩${r.bpm} BPM</span>
        </div>
      </div>
      <p class="prose">${r.description}</p>
      <div class="tab-block" style="border-top-color:${col}">
        <div class="tab-block-label" style="background:${col}">${r.genre.toUpperCase()} RIFF</div>
        <div class="tab-comment" style="margin-bottom:10px">// e (high) at top → A7 (low) at bottom — standard tab notation</div>
        ${rowsHtml}
        <div class="tab-key">
          <span class="tab-key-title">KEY:</span> ${r.key}<br>
          <span class="tab-key-title">PICK:</span> ${r.strum}
        </div>
      </div>
      <div class="riff-tip">
        <span class="riff-tip-label">💡 TIP</span>
        <span>${r.tip}</span>
      </div>
      <div style="display:flex;gap:8px;margin-top:16px;flex-wrap:wrap;align-items:center">
        <button class="btn primary" onclick="startRiffSession()">🎸 Practice This</button>
        <button class="btn" onclick="generateRiff()">↻ New Riff</button>
        <button class="btn" onclick="copyRiffTab()">Copy Tab</button>
        <button class="add-to-sess-btn" onclick="addRiffToSession(this)">+ Add to Session</button>
      </div>
      <div class="riff-session-panel" id="riff-session-panel" style="display:none"></div>
    </div>`;
}

function copyRiffTab() {
  if (!currentRiff) return;
  const text = currentRiff.tab.map(r => r[0] + r[1]).join('\n');
  navigator.clipboard.writeText(text).then(() => {
    const btn = event.target;
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy Tab', 1500);
  });
}

/* ── RIFF LAB INLINE SESSION ─────────────────────────── */
let riffSessBlocks = [];
let riffSessIdx = 0;
let riffSessRunning = false;
let riffSessTimer = null;
let riffSessSecs = 0;

function startRiffSession() {
  if (!currentRiff) return;
  const slowBpm = Math.max(40, Math.round(currentRiff.bpm * 0.6));
  riffSessBlocks = [
    { name: 'Warmup — Open String Chugs', mins: 3, color: '#3d0870', bpm: 60, secsLeft: 180, done: false },
    { name: currentRiff.title + ' — Slow (' + slowBpm + ' BPM)', mins: 5, color: '#7720cc', bpm: slowBpm, secsLeft: 300, done: false },
    { name: currentRiff.title + ' — Up to Tempo (' + currentRiff.bpm + ' BPM)', mins: 7, color: '#5a10a0', bpm: currentRiff.bpm, secsLeft: 420, done: false },
    { name: 'Full Riff — Record Yourself', mins: 5, color: '#4a7a4a', bpm: currentRiff.bpm, secsLeft: 300, done: false },
  ];
  riffSessIdx = 0;
  riffSessRunning = false;
  riffSessSecs = 0;
  if (riffSessTimer) clearInterval(riffSessTimer);
  const panel = document.getElementById('riff-session-panel');
  if (panel) panel.style.display = 'block';
  renderRiffSessionPanel();
  updateBPM(60);
  setTimeout(() => {
    const p = document.getElementById('riff-session-panel');
    if (p) p.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}

function renderRiffSessionPanel() {
  const panel = document.getElementById('riff-session-panel');
  if (!panel) return;
  const cur = riffSessBlocks[riffSessIdx];
  const allDone = riffSessIdx >= riffSessBlocks.length;
  const timerStr = cur ? fmtTime(cur.secsLeft) : '00:00';
  const label = allDone ? 'Session Complete 🔥' : (cur ? cur.name : '');
  const totalMins = riffSessBlocks.reduce((s,b) => s + b.mins, 0);

  panel.innerHTML = `
    <div class="riff-session-header">
      <div>
        <div class="riff-session-title">🎸 PRACTICE SESSION</div>
        <div class="riff-session-label">${label}</div>
      </div>
      <div style="text-align:right">
        <div class="riff-session-timer">${timerStr}</div>
        <div style="font-size:10px;color:var(--dim)">${totalMins} min total</div>
      </div>
    </div>
    <div class="riff-session-blocks">
      ${riffSessBlocks.map((b,i) => `
        <div class="riff-sblock ${i===riffSessIdx&&!allDone?'riff-sblock-active':''} ${b.done?'riff-sblock-done':''}">
          <div class="riff-sblock-dot" style="background:${b.color}"></div>
          <div class="riff-sblock-name">${b.name}</div>
          <div class="riff-sblock-time">${b.done ? '✓' : (i===riffSessIdx&&!allDone ? fmtTime(b.secsLeft) : b.mins+'m')}</div>
        </div>`).join('')}
    </div>
    <div class="riff-session-footer">
      ${allDone
        ? `<button class="btn primary" onclick="riffSessReset()">↻ Restart</button>
           <button class="btn" onclick="openLogTimeModal()">📊 View in Metrics</button>`
        : `<button class="sess-big-btn" style="flex:2;font-size:12px;padding:10px 16px" onclick="toggleRiffSession()">
             ${riffSessRunning ? '■ PAUSE' : (riffSessSecs > 0 ? '▶ RESUME' : '▶ START')}
           </button>
           <button class="btn" onclick="riffSessSkip()">Skip →</button>
           <button class="btn" onclick="riffSessReset()">✕</button>`}
    </div>`;
}

function toggleRiffSession() {
  if (riffSessRunning) {
    clearInterval(riffSessTimer);
    riffSessRunning = false;
    if (metroRunning) toggleMetro();
    renderRiffSessionPanel();
  } else {
    riffSessRunning = true;
    // auto-start metronome at current block BPM
    const curBlock = riffSessBlocks[riffSessIdx];
    if (curBlock && curBlock.bpm) updateBPM(curBlock.bpm);
    if (!metroRunning) toggleMetro();
    renderRiffSessionPanel();
    riffSessTimer = setInterval(() => {
      if (riffSessIdx >= riffSessBlocks.length) {
        clearInterval(riffSessTimer); riffSessRunning = false;
        if (metroRunning) toggleMetro();
        renderRiffSessionPanel(); return;
      }
      const b = riffSessBlocks[riffSessIdx];
      b.secsLeft--;
      riffSessSecs++;
      totalSecsLogged++;
      saveDailyStats();
      // Continuous micro-gain while practicing
      if (riffSessSecs % 12 === 0) {
        autoProgressSkill('Gallop Rhythm', 0.3);
        autoProgressSkill('Palm Muting', 0.2);
        autoProgressSkill('Alternate Pick', 0.2);
      }
      if (b.secsLeft <= 0) {
        b.done = true;
        if (b.skill) autoProgressSkill(b.skill, 5);
        riffSessIdx++;
        if (riffSessIdx >= riffSessBlocks.length) {
          clearInterval(riffSessTimer); riffSessRunning = false;
          if (metroRunning) toggleMetro();
          saveSessionStats();
          autoProgressSkill('Gallop Rhythm', 8);
          autoProgressSkill('Palm Muting', 5);
        } else {
          // advance BPM to next block
          const nextB = riffSessBlocks[riffSessIdx];
          if (nextB && nextB.bpm) updateBPM(nextB.bpm);
        }
      }
      renderRiffSessionPanel();
    }, 1000);
  }
}

function riffSessSkip() {
  if (riffSessIdx < riffSessBlocks.length) {
    riffSessBlocks[riffSessIdx].done = true;
    riffSessIdx++;
    if (riffSessIdx >= riffSessBlocks.length) {
      clearInterval(riffSessTimer); riffSessRunning = false; saveSessionStats();
    }
  }
  renderRiffSessionPanel();
}

function riffSessReset() {
  clearInterval(riffSessTimer); riffSessRunning = false; riffSessSecs = 0;
  riffSessBlocks.forEach(b => { b.secsLeft = b.mins * 60; b.done = false; });
  riffSessIdx = 0;
  renderRiffSessionPanel();
}

/* ═══════════════════════════════════════════════
   AUTOSAVE NOTES — DEBOUNCED
═══════════════════════════════════════════════ */
let noteSaveTimeout = null;
function scheduleNoteSave() {
  clearTimeout(noteSaveTimeout);
  noteSaveTimeout = setTimeout(() => {
    saveNoteData();
  }, 800);
}



</script>
<script>
// Register service worker for offline use
if ('serviceWorker' in navigator) {
  // Inline service worker as a blob so no separate file needed
  const swCode = `
    const CACHE = 'grimoire-v1';
    self.addEventListener('install', e => {
      e.waitUntil(
        caches.open(CACHE).then(cache => cache.addAll([self.location.pathname]))
      );
      self.skipWaiting();
    });
    self.addEventListener('activate', e => {
      e.waitUntil(caches.keys().then(keys =>
        Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))
      ));
      self.clients.claim();
    });
    self.addEventListener('fetch', e => {
      e.respondWith(
        caches.match(e.request).then(cached => cached || fetch(e.request).catch(() => cached))
      );
    });
  `;
  const blob = new Blob([swCode], { type: 'application/javascript' });
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl).catch(() => {});
}
</script>

<!-- ═══════════ FLOATING ACTION BUTTONS ═══════════ -->
<!-- ── CONTEXT BAR ── -->
<div id="context-bar">
  <div class="ctx-info">
    <div class="ctx-name" id="ctx-label">Practice Session</div>
    <div class="ctx-bpm-badge">♩ <span id="ctx-bpm">80 BPM</span> · metronome auto-starts</div>
  </div>
  <div class="ctx-actions">
    <button class="btn" onclick="toggleMetroPopup()" style="font-size:11px">♩ Metro</button>
    <button class="sess-big-btn" style="font-size:11px;padding:10px 20px;letter-spacing:2px"
      onclick="startContextSession(document.querySelector('.page.active')?.id)">▶ START</button>
  </div>
</div>

<!-- ── PLAN BLOCK DETAIL MODAL ── -->
<div id="plan-block-modal" style="display:none;position:fixed;inset:0;z-index:9100;background:rgba(0,0,0,0.78);align-items:center;justify-content:center">
  <div class="pbm-inner">
    <div class="pbm-header">
      <div class="pbm-title" id="pbm-title"></div>
      <button class="pbm-close" onclick="closePlanModal()">×</button>
    </div>
    <div class="pbm-meta" id="pbm-meta"></div>
    <div class="pbm-body" id="pbm-body"></div>
    <button class="pbm-start" onclick="closePlanModal()">✓ GOT IT — LOAD SESSION</button>
  </div>
</div>

<div class="fab-cluster" id="fab-cluster">

  <!-- Session timer fab -->
  <div class="fab" id="fab-session" onclick="fabSessionClick()" title="Session Timer">
    <span id="fab-sess-icon">⏱</span>
    <span class="fab-label">SESSION TIMER</span>
    <span class="fab-timer-val" id="fab-timer-val">00:00</span>
  </div>

  <!-- Notepad fab -->
  <div class="fab" onclick="goTo('notepad', null)" title="Notepad">
    ✎
    <span class="fab-label">NOTEPAD</span>
  </div>

  <!-- Metronome fab -->
  <div class="fab" id="fab-metro" onclick="toggleMetroPopup()" title="Metronome">
    <span id="fab-metro-icon">♩</span>
    <span class="fab-label">METRONOME</span>
  </div>

</div>

<!-- ═══════════ METRONOME POPUP ═══════════ -->
<!-- ── LOG TIME MODAL ────────────────────────────────────── -->
<div id="log-time-modal" style="display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,0.72);align-items:center;justify-content:center">
  <div style="background:#0e0718;border:1px solid var(--wire);border-radius:14px;padding:28px 24px;width:88%;max-width:340px;box-shadow:0 8px 40px rgba(0,0,0,0.6)">
    <div style="font-size:15px;font-weight:700;color:var(--lead);margin-bottom:6px">Log Practice Time</div>
    <div style="font-size:12px;color:var(--dim);margin-bottom:20px">Record minutes you practiced outside the timer</div>
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
      <button onclick="adjustLogMins(-5)" style="width:40px;height:40px;border-radius:50%;border:1px solid var(--wire);background:none;color:var(--lead);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center">−</button>
      <div style="flex:1;text-align:center">
        <div id="log-mins-display" style="font-size:42px;font-weight:800;color:var(--ember);font-family:var(--mono)">30</div>
        <div style="font-size:11px;color:var(--dim)">minutes</div>
      </div>
      <button onclick="adjustLogMins(5)" style="width:40px;height:40px;border-radius:50%;border:1px solid var(--wire);background:none;color:var(--lead);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center">+</button>
    </div>
    <div style="display:flex;gap:10px">
      <button onclick="closeLogTimeModal()" style="flex:1;padding:12px;border-radius:8px;border:1px solid var(--wire);background:none;color:var(--dim);cursor:pointer;font-size:13px">Cancel</button>
      <button onclick="confirmLogTime()" style="flex:2;padding:12px;border-radius:8px;border:none;background:var(--ember);color:#fff;cursor:pointer;font-size:13px;font-weight:700">Record Practice</button>
    </div>
  </div>
</div>

<div class="metro-popup" id="metro-popup">
  <div class="mp-header">
    <span class="mp-title">METRONOME</span>
    <button class="mp-close" onclick="toggleMetroPopup()">×</button>
  </div>
  <div class="mp-bpm-row">
    <div class="mp-adj-group">
      <div class="mp-adj" onclick="changeBPM(-10)">−10</div>
      <div class="mp-adj sm" onclick="changeBPM(-1)">−1</div>
    </div>
    <div class="mp-bpm-num" id="mp-bpm-display">80</div>
    <div class="mp-adj-group">
      <div class="mp-adj" onclick="changeBPM(10)">+10</div>
      <div class="mp-adj sm" onclick="changeBPM(1)">+1</div>
    </div>
  </div>
  <input type="range" class="mp-slider" id="mp-bpm-slider" min="40" max="240" value="80"
    oninput="updateBPM(this.value)">
  <div class="mp-beat-row" id="mp-beat-row">
    <div class="mp-pip"></div>
    <div class="mp-pip"></div>
    <div class="mp-pip"></div>
    <div class="mp-pip"></div>
  </div>
  <button class="mp-start-btn" id="mp-start-btn" onclick="toggleMetro()">▶ START</button>
  <button class="mp-tap-btn" id="mp-tap-btn" onclick="tapTempo()">TAP TEMPO</button>
</div>

<div id="sess-toast"></div>
</body>
</html>
